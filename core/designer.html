<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Designer - Viyar Pro</title>
    <!-- Dynamic Schema Loader -->
    <!-- Dynamic Schema Loader -->
    <script>
        document.write('<script src="../data/config_calculators.js?v=' + Date.now() + '"><\/script>');
        document.write('<script src="../data/config_dashboard.js?v=' + Date.now() + '"><\/script>');
    </script>
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');

            // If dashboard mode, we don't need a specific config file immediately
            // But we keep the existing logic for calculator mode
            const configFile = params.get('config') || '../data/schema_kitchen.js';
            window.currentConfigFile = configFile;
            window.currentMode = mode === 'dashboard' ? 'dashboard' : 'calculator';

            if (window.currentMode === 'calculator') {
                const script = document.createElement('script');
                let cfgPath = configFile;
                if (cfgPath.startsWith('data/')) cfgPath = '../' + cfgPath;
                script.src = cfgPath + '?v=' + new Date().getTime();
                script.onload = function () {
                    console.log('Schema loaded:', configFile);
                    if (window.renderMatrix) window.renderMatrix();
                    if (window.renderDesigner) window.renderDesigner();
                };
                script.onerror = function () {
                    // console.error...
                };
                document.head.appendChild(script);
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #111827;
            --sidebar-bg: #1f2937;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --border: #374151;
            --field-bg: #374151;
            --text-main: #f3f4f6;
            --text-dim: #9ca3af;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: var(--bg);
            color: var(--text-main);
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.2);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        .context-select {
            width: 100%;
            background: #111827;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 12px;
            cursor: pointer;
        }

        /* New Premium Controls Styling */
        .section-tab {
            font-size: 9px;
            color: var(--accent);
            font-weight: 800;
            text-transform: uppercase;
            margin: 25px 0 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-group {
            display: flex;
            background: #111827;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            flex: 1;
            padding: 6px;
            font-size: 10px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-weight: 700;
            transition: 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .shadow-subtle {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .shadow-deep {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .shadow-glow {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .selected-db-card {
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.5), inset 0 0 15px rgba(99, 102, 241, 0.3);
            background: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px);
        }

        .calc-mode-back {
            background: #4f46e5;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            border: none;
            transition: 0.3s;
        }

        .calc-mode-back:hover {
            background: #4338ca;
            transform: translateX(-5px);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-footer {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-top: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 24px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .control-label {
            display: block;
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .property-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .width-btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .width-btn {
            background: #111827;
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .width-btn:hover {
            border-color: var(--accent);
            color: white;
        }

        .width-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn-back,
        .btn-save {
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            text-decoration: none;
        }

        .canvas {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preview-container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            min-height: 80vh;
        }

        .group-box {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            margin-bottom: 40px;
            padding: 30px 20px 20px;
            position: relative;
            background: rgba(255, 255, 255, 0.01);
            transition: border-color 0.3s;
        }

        .group-header {
            position: absolute;
            top: -14px;
            left: 20px;
            background: var(--accent);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .group-header:hover {
            filter: brightness(1.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .group-header.selected {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
            transform: scale(1.05);
        }

        .fields-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
        }

        .field-card {
            background: #1f2937;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            cursor: move;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .field-card.selected {
            border: 2px solid var(--accent);
            background: #2d3748;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            transform: scale(1.02);
        }

        .field-card:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .field-type-badge {
            font-size: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 2px 6px;
            border-radius: 4px;
            width: fit-content;
            text-transform: uppercase;
        }

        .field-mock-input {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 5px;
        }

        .w-100 {
            grid-column: span 12;
        }

        .w-75 {
            grid-column: span 9;
        }

        .w-66 {
            grid-column: span 8;
        }

        .w-50 {
            grid-column: span 6;
        }

        .w-33 {
            grid-column: span 4;
        }

        .w-25 {
            grid-column: span 3;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
        }

        input[type="number"],
        select {
            background: #111827;
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
            width: 100%;
        }

        /* Light Theme Overrides */
        body.light-theme {
            --bg: #f3f4f6;
            --sidebar-bg: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-dim: #6b7280;
            --field-bg: #ffffff;
        }

        body.light-theme .canvas {
            background: #f3f4f6;
        }

        body.light-theme .preview-container {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        body.light-theme .field-card {
            background: #f9fafb;
            border-color: #e5e7eb;
        }

        body.light-theme .field-label {
            color: #111827;
        }

        body.light-theme .sidebar {
            background: white;
            border-right: 1px solid #e5e7eb;
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: #9ca3af;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            margin-left: 5px;
            cursor: help;
        }

        .input-preview {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #9ca3af;
        }

        @keyframes pulseBg {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        /* --- SYNC WITH INDEX.HTML --- */
        .preview-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            position: relative;
        }

        .header-preview {
            margin-bottom: 40px;
            position: relative;
            padding: 20px;
        }

        .logo-preview {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        .logo-preview span {
            color: #fbbf24;
        }

        .subtitle-preview {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .auth-controls-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .settings-btn-preview {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn-preview {
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 900px) {
            .sidebar {
                position: fixed;
                left: -320px !important;
                top: 0;
                bottom: 0;
                transition: left 0.3s ease;
                z-index: 2000;
                box-shadow: 10px 0 50px rgba(0, 0, 0, 0.5);
            }

            .sidebar.active {
                left: 0 !important;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1999;
                backdrop-filter: blur(2px);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .mobile-menu-btn {
                display: flex !important;
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                background: var(--accent);
                color: white;
                border-radius: 50%;
                z-index: 2100;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5);
            }
        }

        .mobile-menu-btn {
            display: none;
        }

        .badge {
            background: #d97706;
            color: white;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            font-weight: 800;
            display: inline-block;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .calc-edit-item.is-placeholder {
            border-color: #d97706 !important;
            background: rgba(217, 119, 6, 0.1) !important;
        }

        .custom-checkbox {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            font-size: 11px;
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 10px;
            border-radius: 6px;
            transition: 0.2s;
        }

        .custom-checkbox:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .custom-checkbox input {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <button class="mobile-menu-btn" onclick="toggleSidebar(true)">üõ†Ô∏è</button>

    <div class="sidebar">
        <div class="sidebar-header">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span style="font-weight:800; font-size:16px;">üé® Designer <span
                        style="font-size:10px; color:var(--accent); background:rgba(255,255,255,0.1); padding:2px 5px; border-radius:4px; margin-left:5px">v5.0</span></span>
                <a href="../index.html" class="nav-btn-back" style="background:rgba(255,255,255,0.1)">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
            </div>

            <select id="contextSwitcher" class="context-select" onchange="switchContext(this.value)">
                <option value="dashboard">üè† –ï–∫—Ä–∞–Ω –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è (Dashboard)</option>
                <optgroup label="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∏" id="calcOptions">
                    <!-- Javascript will populate this -->
                </optgroup>
            </select>
        </div>

        <div class="sidebar-content">
            <!-- === DASHBOARD EDITOR === -->
            <div id="dashboardEditor" style="display:none">
                <div class="section-tab">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ì–æ–ª–æ–≤–Ω–æ—ó</div>

                <div class="control-group">
                    <label class="control-label">–ì–æ–ª–æ–≤–Ω–∏–π –ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="dbTitle" oninput="updateDashboardPreview()" placeholder="Vpoint">
                    <label class="control-label" style="margin-top:10px; font-size:8px">–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É: <span
                            id="dbTitleSizeVal">48</span>px</label>
                    <input type="range" min="20" max="100" id="dbTitleSize" oninput="updateDashboardPreview()">
                </div>

                <div class="control-group">
                    <label class="control-label">–ü—ñ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="dbSubtitle" oninput="updateDashboardPreview()" placeholder="–°–ª–æ–≥–∞–Ω...">
                </div>

                <div class="section-tab">–°–ø–∏—Å–æ–∫ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤</div>
                <button class="btn-save" onclick="addNewCalculatorToConfig()"
                    style="width:100%; background:var(--accent); margin-bottom: 15px; font-weight: 800; border: 2px solid rgba(255,255,255,0.3);">‚ûï
                    –î–û–î–ê–¢–ò –ù–û–í–ò–ô –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†</button>
                <div id="calculatorsListEditor"
                    style="display:flex; flex-direction:column; gap:15px; margin-bottom:20px;">
                    <!-- JS will populate this -->
                </div>
                <button class="btn-save" onclick="saveCalculatorsConfig()"
                    style="width:100%; background:#8b5cf6; margin-bottom: 20px;">üíæ
                    –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤</button>

                <div class="control-group">
                    <label class="control-label">–¢–∏–ø —Ñ–æ–Ω—É</label>
                    <select id="dbBgType" onchange="updateDashboardPreview()">
                        <option value="color">–°—É—Ü—ñ–ª—å–Ω–∏–π –∫–æ–ª—ñ—Ä</option>
                        <option value="gradient">–ì—Ä–∞–¥—ñ—î–Ω—Ç</option>
                        <option value="animation">–ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π (Blobs)</option>
                        <option value="image">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É / –ê–∫—Ü–µ–Ω—Ç</label>
                    <div style="display:flex; gap:10px">
                        <input type="color" id="dbColor" oninput="updateDashboardPreview()"
                            style="width:40px; height:30px; padding:0; border:none">
                        <input type="text" id="dbColorText" oninput="updateDashboardPreview()" style="flex:1"
                            placeholder="#1e88e5">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">–Ü–ª—é—Å—Ç—Ä–∞—Ü—ñ—è –ó–∞–≥–æ–ª–æ–≤–∫–∞ (URL)</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbHeaderIllustration" oninput="updateDashboardPreview()"
                            placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞" style="flex:1">
                        <button class="toggle-btn" onclick="openDbFilePicker('dbHeaderIllustration')"
                            title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                    </div>
                </div>

                <div class="control-group" id="dbBgImageGroup">
                    <label class="control-label">–§–æ–Ω–æ–≤–µ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (URL)</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbBgImage" oninput="updateDashboardPreview()"
                            placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="flex:1">
                        <button class="toggle-btn" onclick="pickDashboardImage('dbBgImage')"
                            title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                    </div>
                </div>

                <div class="section-tab">–ï—Ñ–µ–∫—Ç–∏ Glassmorphism</div>
                <div class="control-group">
                    <label class="control-label">–†–æ–∑–º–∏—Ç—Ç—è (Blur): <span id="dbBlurVal">10</span>px</label>
                    <input type="range" min="0" max="40" id="dbBlur" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å: <span id="dbOpacityVal">0.1</span></label>
                    <input type="range" min="0" max="1" step="0.05" id="dbOpacity" oninput="updateDashboardPreview()">
                </div>

                <div class="section-tab">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Header Box</div>
                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É Header</label>
                    <input type="color" id="dbHeaderBg" oninput="updateDashboardPreview()" value="#ffffff">
                </div>
                <div class="control-group">
                    <label class="control-label">–ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å Header: <span id="dbHeaderOpacityVal">0.1</span></label>
                    <input type="range" min="0" max="1" step="0.05" id="dbHeaderOpacity"
                        oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–†–æ–∑–º–∏—Ç—Ç—è Header (Blur): <span id="dbHeaderBlurVal">10</span>px</label>
                    <input type="range" min="0" max="40" id="dbHeaderBlur" oninput="updateDashboardPreview()">
                </div>

                <div class="section-tab">–ü–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –Ü–ª—é—Å—Ç—Ä–∞—Ü—ñ—ó</div>

                <div class="control-group">
                    <label class="control-label">–õ–æ–≥–æ—Ç–∏–ø (X / Y / Scale)</label>
                    <div style="display:flex; gap:5px; align-items:center">
                        <input type="number" id="dbLogoX" oninput="updateDashboardPreview()" step="5" style="width:50px"
                            title="X Position">
                        <input type="number" id="dbLogoY" oninput="updateDashboardPreview()" step="5" style="width:50px"
                            title="Y Position">
                        <input type="number" id="dbLogoScale" oninput="updateDashboardPreview()" step="0.1"
                            style="width:50px" title="Scale">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">–Ü–ª—é—Å—Ç—Ä–∞—Ü—ñ—è 1 (URL)</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbHeaderIllustration" oninput="updateDashboardPreview()"
                            placeholder="URL" style="flex:1">
                        <button class="toggle-btn" onclick="openDbFilePicker('dbHeaderIllustration')">üìÇ</button>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center; margin-top:5px">
                        <input type="number" id="dbIllus1X" oninput="updateDashboardPreview()" step="5"
                            style="width:50px" title="X">
                        <input type="number" id="dbIllus1Y" oninput="updateDashboardPreview()" step="5"
                            style="width:50px" title="Y">
                        <input type="number" id="dbIllus1Scale" oninput="updateDashboardPreview()" step="0.1"
                            style="width:50px" title="Scale">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">–Ü–ª—é—Å—Ç—Ä–∞—Ü—ñ—è 2 (URL)</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbHeaderIllustration2" oninput="updateDashboardPreview()"
                            placeholder="URL" style="flex:1">
                        <button class="toggle-btn" onclick="openDbFilePicker('dbHeaderIllustration2')">üìÇ</button>
                    </div>
                    <div style="display:flex; gap:5px; align-items:center; margin-top:5px">
                        <input type="number" id="dbIllus2X" oninput="updateDashboardPreview()" step="5"
                            style="width:50px" title="X">
                        <input type="number" id="dbIllus2Y" oninput="updateDashboardPreview()" step="5"
                            style="width:50px" title="Y">
                        <input type="number" id="dbIllus2Scale" oninput="updateDashboardPreview()" step="0.1"
                            style="width:50px" title="Scale">
                    </div>
                </div>

                <div class="section-tab">–°—Ç–∏–ª—å –ö–∞—Ä—Ç–æ–∫</div>
                <div class="control-group">
                    <label class="control-label">–ú—ñ–Ω. —à–∏—Ä–∏–Ω–∞: <span id="dbCardWidthVal">250</span>px</label>
                    <input type="range" min="150" max="500" step="10" id="dbCardWidth"
                        oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–í—ñ–¥—Å—Ç—É–ø–∏ (Padding): <span id="dbCardPaddingVal">20</span>px</label>
                    <input type="range" min="5" max="60" id="dbCardPadding" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–†–æ–∑–º—ñ—Ä —ñ–∫–æ–Ω–æ–∫: <span id="dbCardIconSizeVal">40</span>px</label>
                    <input type="range" min="20" max="100" id="dbCardIconSize" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–®—Ä–∏—Ñ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞: <span id="dbCardTitleSizeVal">16</span>px</label>
                    <input type="range" min="10" max="40" id="dbCardTitleSize" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                    <input type="color" id="dbCardTitleColor" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–®—Ä–∏—Ñ—Ç –æ–ø–∏—Å—É: <span id="dbCardDescSizeVal">12</span>px</label>
                    <input type="range" min="8" max="24" id="dbCardDescSize" oninput="updateDashboardPreview()">
                </div>
                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä –æ–ø–∏—Å—É</label>
                    <input type="color" id="dbCardDescColor" oninput="updateDashboardPreview()">
                </div>

                <div class="control-group">
                    <label class="control-label">–ñ–∏—Ä–Ω—ñ—Å—Ç—å —à—Ä–∏—Ñ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                    <select id="dbCardTitleWeight" onchange="updateDashboardPreview()">
                        <option value="400">Regular (400)</option>
                        <option value="600">SemiBold (600)</option>
                        <option value="800" selected>Bold (800)</option>
                        <option value="900">Black (900)</option>
                    </select>
                </div>

                <div class="section-tab">–ö–∞—Ä—Ç–∫–∏ "–°–∫–æ—Ä–æ" (Placeholders)</div>
                <div class="control-group">
                    <label class="control-label">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É –∑–∞–≥–ª—É—à–∫–∏</label>
                    <input type="color" id="dbPlaceholderBg" oninput="updateDashboardPreview()" value="#cbd5e1">
                </div>
                <div class="control-group">
                    <label class="control-label">–¢–µ–∫—Å—Ç –±–µ–π–¥–∂–∞ (Badge)</label>
                    <input type="text" id="dbPlaceholderBadge" oninput="updateDashboardPreview()" placeholder="–°–∫–æ—Ä–æ">
                </div>

                <div class="section-tab">–ë—Ä–µ–Ω–¥–∏–Ω–≥</div>
                <div class="control-group">
                    <label class="control-label">–¢–µ–∫—Å—Ç –ª–æ–≥–æ—Ç–∏–ø—É</label>
                    <input type="text" id="dbLogoText" oninput="updateDashboardPreview()" placeholder="Vpoint">
                </div>
                <div class="control-group">
                    <label class="control-label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ª–æ–≥–æ—Ç–∏–ø—É (URL)</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbLogoImg" oninput="updateDashboardPreview()" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏"
                            style="flex:1">
                        <button class="toggle-btn" onclick="openDbFilePicker('dbLogoImg')"
                            title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">–§–æ–Ω–æ–≤–µ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
                    <div style="display:flex; gap:5px">
                        <input type="text" id="dbBgImage" oninput="updateDashboardPreview()"
                            placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" style="flex:1">
                        <button class="toggle-btn" onclick="openDbFilePicker('dbBgImage')"
                            title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                    </div>
                </div>

                <input type="file" id="dbFilePicker" style="display:none" onchange="handleDbFileSelection(this)">

            </div>

            <!-- === CALCULATOR EDITOR (Original) === -->
            <div id="calculatorEditor">
                <button class="calc-mode-back" onclick="activateDashboardMode()">
                    <span>‚Üê</span> –î–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å Dashboard
                </button>
                <div id="globalSettings" style="margin-bottom: 25px;">
                    <div class="section-tab">üåê –ì–ª–æ–±–∞–ª—å–Ω—ñ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
                    <div class="control-group" style="padding-bottom:10px">
                        <span class="control-label">–¢–µ–º–∞ –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</span>
                        <div class="toggle-group">
                            <button class="toggle-btn" id="themeDark" onclick="setGlobalTheme('dark')">–¢–µ–º–Ω–∞</button>
                            <button class="toggle-btn" id="themeLight" onclick="setGlobalTheme('light')">–°–≤—ñ—Ç–ª–∞</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <input type="text" id="calcTitleInp" oninput="updateGlobal('title', this.value)"
                            style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; margin-bottom:10px;">
                        <span class="control-label">–í–µ—Ä—Å—ñ—è</span>
                        <input type="text" id="calcVersionInp" oninput="updateGlobal('version', this.value)"
                            style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; margin-bottom:10px;">
                        <span class="control-label">–ê–∫—Ü–µ–Ω—Ç–Ω–∏–π –ö–æ–ª—ñ—Ä</span>
                        <input type="text" id="calcAccentColor" onchange="updateGlobal('accentColor', this.value)"
                            style="width:100%; height:32px; border-radius:6px; border:1px solid var(--border); background:none; padding:2px; margin-bottom:10px;">
                        <span class="control-label">–®—Ä–∏—Ñ—Ç (Base)</span>
                        <input type="number" id="calcBaseFontSize" oninput="updateGlobal('baseFontSize', this.value)"
                            style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; margin-bottom:15px;">

                        <button class="toggle-btn"
                            style="width:100%; border-color: #ef4444; color: #ef4444; margin-top:10px"
                            onclick="resetAllToDefault()">
                            üßπ –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ —Å—Ç–∏–ª—ñ (Reset)
                        </button>
                    </div>
                </div>

                <div id="selectionPanel" style="display: none;">
                    <div id="fieldProperties">
                        <div class="section-tab">üìè –ú–∞–∫–µ—Ç —Ç–∞ –†–æ–∑–º—ñ—Ä–∏</div>
                        <div style="margin-bottom: 20px;">
                            <span class="control-label">–ù–∞–∑–≤–∞ –ø–æ–ª—è</span>
                            <div style="display:flex; gap:8px; align-items:center">
                                <input type="text" id="fieldLabelInp" oninput="updateFieldLabel(this.value)"
                                    style="flex:1; padding:8px; border-radius:6px; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:white; font-weight:600;">
                                <button class="toggle-btn" style="padding:4px 8px; font-size:9px; width:auto"
                                    onclick="applySelectedStyleToAll()" title="–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ü–µ–π —Å—Ç–∏–ª—å –¥–æ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤">–ù–∞
                                    –≤—Å—ñ</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <span class="control-label">–®–∏—Ä–∏–Ω–∞ –±–ª–æ–∫—É</span>
                            <div class="width-btn-group">
                                <button class="width-btn" onclick="setFieldWidth('w-25')">1/4</button>
                                <button class="width-btn" onclick="setFieldWidth('w-33')">1/3</button>
                                <button class="width-btn" onclick="setFieldWidth('w-50')">1/2</button>
                                <button class="width-btn" onclick="setFieldWidth('w-66')">2/3</button>
                                <button class="width-btn" onclick="setFieldWidth('w-75')">3/4</button>
                                <button class="width-btn" onclick="setFieldWidth('w-100')">1/1</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <span class="control-label">–û—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è</span>
                            <div class="toggle-group">
                                <button class="toggle-btn" id="btnDirCol"
                                    onclick="updateStyle('flexDirection', 'column')">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ</button>
                                <button class="toggle-btn" id="btnDirRow"
                                    onclick="updateStyle('flexDirection', 'row')">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</button>
                            </div>
                            <div class="property-row">
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–í—ñ–¥—Å—Ç—É–ø (Gap)</span>
                                    <input type="number" id="gapInp" oninput="updateStyle('gap', this.value)"
                                        style="width:80%">
                                </div>
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–í–Ω—É—Ç—Ä. Padding</span>
                                    <input type="number" id="paddingInp" oninput="updateStyle('padding', this.value)"
                                        style="width:80%">
                                </div>
                            </div>
                            <div style="margin-top:10px">
                                <span class="control-label" style="font-size:8px">–í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –Ω–∞–∑–≤–∏</span>
                                <div class="toggle-group" style="display:grid; grid-template-columns:repeat(3, 1fr)">
                                    <button class="toggle-btn" id="alignLeft"
                                        onclick="updateStyle('textAlign', 'left')">‚¨ÖÔ∏è</button>
                                    <button class="toggle-btn" id="alignCenter"
                                        onclick="updateStyle('textAlign', 'center')">‚ÜîÔ∏è</button>
                                    <button class="toggle-btn" id="alignRight"
                                        onclick="updateStyle('textAlign', 'right')">‚û°Ô∏è</button>
                                </div>
                            </div>

                            <div id="labelWidthControl" style="margin-top:15px; display:none;">
                                <span class="control-label" style="font-size:8px">–®–∏—Ä–∏–Ω–∞ –Ω–∞–∑–≤–∏ (px)</span>
                                <div class="property-row">
                                    <input type="range" min="10" max="400" id="labelWidthRange"
                                        oninput="updateStyle('labelWidth', this.value)" style="flex:1">
                                    <div id="labelWidthVal" style="font-size:10px; width:35px; font-weight:800">120
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Typography Pro -->
                        <div class="section-tab">üî§ –¢–∏–ø–æ–≥—Ä–∞—Ñ—ñ–∫–∞ —Ç–∞ –¢–µ–∫—Å—Ç</div>
                        <div class="control-group">
                            <div class="property-row">
                                <input type="range" min="10" max="40" id="fontSizeRange"
                                    oninput="updateStyle('fontSize', this.value)" style="flex: 2;">
                                <div id="fontSizeVal" style="font-size: 10px; width: 30px; font-weight:800">14</div>
                            </div>
                            <div class="property-row">
                                <select id="fontWeightSelect" onchange="updateStyle('fontWeight', this.value)"
                                    style="flex:2; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; padding:5px; border-radius:5px;">
                                    <option value="400">Regular</option>
                                    <option value="600">SemiBold</option>
                                    <option value="700">Bold</option>
                                    <option value="800">Black</option>
                                </select>
                                <input type="color" id="labelColor" onchange="updateStyle('color', this.value)"
                                    style="flex:1; height:32px; background:none; border:1px solid var(--border); padding:2px; border-radius:5px;">
                            </div>
                            <div style="margin-top:15px">
                                <span class="control-label" style="font-size:8px">–¢–µ–∫—Å—Ç-–ø—ñ–¥–∫–∞–∑–∫–∞ (Placeholder)</span>
                                <input type="text" id="placeholderInp" oninput="updateStyle('placeholder', this.value)"
                                    placeholder="–í–≤–µ–¥—ñ—Ç—å..."
                                    style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                            </div>
                            <div style="margin-top:10px">
                                <span class="control-label" style="font-size:8px">–û–ø–∏—Å / Help Text</span>
                                <input type="text" id="helpInp" oninput="updateStyle('help', this.value)"
                                    placeholder="–ó'—è–≤–∏—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ..."
                                    style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                            </div>
                            <div style="margin-top:10px">
                                <span class="control-label" style="font-size:8px">URL —Ñ–æ—Ç–æ —É –ø—ñ–¥–∫–∞–∑—Ü—ñ</span>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="helpImgInp" oninput="updateStyle('helpImg', this.value)"
                                        placeholder="images/photo.jpg"
                                        style="flex:1; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; font-size:12px;">
                                    <button onclick="document.getElementById('filePicker').click()"
                                        style="padding:0 12px; border-radius:6px; background:var(--accent); border:none; color:white; cursor:pointer;"
                                        title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                                </div>
                                <input type="file" id="filePicker" style="display:none" onchange="pickHelpImg(this)">
                            </div>
                            <div class="toggle-group" style="margin-top:10px">
                                <button class="toggle-btn" id="btnUpper"
                                    onclick="toggleLayoutProp('uppercase')">–ê–ë–í</button>
                                <button class="toggle-btn" id="btnLetterSpacing" onclick="toggleLayoutProp('spaced')">A
                                    B
                                    C</button>
                            </div>
                        </div>

                        <!-- Section 5: Input Aesthetics -->
                        <div class="section-tab">üñºÔ∏è –°—Ç–∏–ª—å –ü–æ–ª—è (Input)</div>
                        <div class="control-group">
                            <div style="margin-bottom:15px">
                                <div style="display:flex; justify-content:space-between; align-items:center">
                                    <span class="control-label" style="font-size:8px">–®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (%)</span>
                                    <button class="toggle-btn" style="padding:2px 5px; font-size:8px"
                                        onclick="updateStyle('inputWidth', 100)">100%</button>
                                </div>
                                <div class="property-row">
                                    <input type="range" min="10" max="100" id="inputWidthRange"
                                        oninput="updateStyle('inputWidth', this.value)" style="flex:1">
                                    <div id="inputWidthVal" style="font-size:10px; width:35px; font-weight:800">100%
                                    </div>
                                </div>
                            </div>
                            <div style="margin-bottom:15px" id="inputOffsetGroup">
                                <div style="display:flex; justify-content:space-between; align-items:center">
                                    <span class="control-label" style="font-size:8px">–ó—Å—É–≤ –≤–ø—Ä–∞–≤–æ (px)</span>
                                    <button class="toggle-btn" style="padding:2px 5px; font-size:8px"
                                        onclick="updateStyle('inputOffset', 0)">Reset</button>
                                </div>
                                <div class="property-row">
                                    <input type="range" min="0" max="400" id="inputOffsetRange"
                                        oninput="updateStyle('inputOffset', this.value)" style="flex:1">
                                    <div id="inputOffsetVal" style="font-size:10px; width:35px; font-weight:800">0</div>
                                </div>
                            </div>
                            <div class="property-row">
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–†–∞–º–∫–∞ (–ö–æ–ª—ñ—Ä)</span>
                                    <input type="color" id="inpBorderColor"
                                        onchange="updateStyle('inpBorder', this.value)" style="width:100%">
                                </div>
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–¢–æ–≤—â–∏–Ω–∞ —Ä–∞–º–∫–∏</span>
                                    <input type="number" id="inpBorderWidthInp"
                                        oninput="updateStyle('inpBorderWidth', this.value)" style="width:100%">
                                </div>
                            </div>
                            <div class="property-row">
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">Background</span>
                                    <input type="color" id="inpBgColor" onchange="updateStyle('inpBg', this.value)"
                                        style="width:100%">
                                </div>
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è (px)</span>
                                    <input type="number" id="inpRadiusInp"
                                        oninput="updateStyle('inpRadius', this.value)" style="width:100%">
                                </div>
                            </div>
                            <div class="property-row">
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–í—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É (Moving)</span>
                                    <input type="number" id="marginTopInp"
                                        oninput="updateStyle('marginTop', this.value)" style="width:100%">
                                </div>
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–í—ñ–¥—Å—Ç—É–ø –∑–ª—ñ–≤–∞</span>
                                    <input type="number" id="marginLeftInp"
                                        oninput="updateStyle('marginLeft', this.value)" style="width:100%">
                                </div>
                            </div>
                            <div class="property-row">
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–í—ñ–¥—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞</span>
                                    <input type="number" id="marginRightInp"
                                        oninput="updateStyle('marginRight', this.value)" style="width:100%">
                                </div>
                                <div style="flex:1">
                                    <span class="control-label" style="font-size:8px">–†–∞–¥—ñ—É—Å –ö–∞—Ä—Ç–∫–∏</span>
                                    <input type="number" id="cardRadiusInp"
                                        oninput="updateStyle('cardRadius', this.value)" style="width:100%">
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Effects -->
                        <div class="section-tab">‚ú® –ï—Ñ–µ–∫—Ç–∏ —Ç–∞ –î–µ–∫–æ—Ä</div>
                        <div class="control-group">
                            <span class="control-label">–ì–ª–∏–±–∏–Ω–∞ (–¢—ñ–Ω—å)</span>
                            <div class="toggle-group" style="display:grid; grid-template-columns:repeat(4, 1fr)">
                                <button class="toggle-btn" id="shNone"
                                    onclick="updateStyle('shadow', 'none')">Off</button>
                                <button class="toggle-btn" id="shSubtle"
                                    onclick="updateStyle('shadow', 'subtle')">S</button>
                                <button class="toggle-btn" id="shDeep"
                                    onclick="updateStyle('shadow', 'deep')">D</button>
                                <button class="toggle-btn" id="shGlow"
                                    onclick="updateStyle('shadow', 'glow')">G</button>
                            </div>
                            <label
                                style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: var(--accent); cursor: pointer; margin-top:10px; font-weight:700;">
                                <input type="checkbox" id="glassToggle" onchange="updateStyle('glass', this.checked)">
                                Glassmorphism (Blur)
                            </label>
                        </div>

                        <!-- Section 4: Action Button -->
                        <div id="actionButtonProperties" style="display: none;">
                            <div class="section-tab">üîò –°—Ç–∏–ª—å –ö–Ω–æ–ø–∫–∏</div>
                            <div class="property-row">
                                <div style="flex:1"><span class="control-label" style="font-size:8px">–§–æ–Ω</span><input
                                        type="color" id="btnBgColor" onchange="updateStyle('btnBg', this.value)"
                                        style="width:100%"></div>
                                <div style="flex:1"><span class="control-label" style="font-size:8px">–¢–µ–∫—Å—Ç</span><input
                                        type="color" id="btnTextColor" onchange="updateStyle('btnColor', this.value)"
                                        style="width:100%"></div>
                            </div>
                            <div class="property-row" style="margin-top: 10px;">
                                <input type="number" id="btnFontSize" placeholder="–®—Ä–∏—Ñ—Ç"
                                    oninput="updateStyle('btnFontSize', this.value)" style="width:45%">
                                <input type="number" id="btnRadius" placeholder="–†–∞–¥—ñ—É—Å"
                                    oninput="updateStyle('btnRadius', this.value)" style="width:45%">
                            </div>
                        </div>

                        <!-- Section: Product Window Style (for buttons/modals) -->
                        <div id="productWindowProperties" style="display: none;">
                            <div class="section-tab">ü™ü –í—ñ–∫–Ω–æ –í–∏—Ä–æ–±—É (–ö–∞—Ä—Ç–∫–∞)</div>
                            <div class="control-group">
                                <span class="control-label" style="font-size:8px">–®–∏—Ä–∏–Ω–∞ –≤—ñ–∫–Ω–∞ (–Ω–∞–ø—Ä: 300px,
                                    150%)</span>
                                <input type="text" id="prodWidthInp" oninput="updateStyle('prodWidth', this.value)"
                                    placeholder="100%"
                                    style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                                <div style="margin-top:10px">
                                    <span class="control-label" style="font-size:8px">–§–æ–Ω –∫–∞—Ä—Ç–∫–∏</span>
                                    <input type="color" id="prodBgColor" onchange="updateStyle('prodBg', this.value)"
                                        style="width:100%">
                                </div>
                            </div>
                        </div>

                        <div class="control-group" style="margin-top: 20px; border: none;">
                            <label
                                style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: #ef4444; cursor: pointer;">
                                <input type="checkbox" id="fieldHidden" onchange="toggleFieldHidden(this.checked)">
                                –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç
                            </label>
                        </div>
                    </div>

                    <!-- Group Properties -->
                    <div id="groupProperties" style="display: none;">
                        <div class="section-tab">üìÇ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ì—Ä—É–ø–∏</div>
                        <div class="control-group">
                            <span class="control-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–∏</span>
                            <input type="text" id="groupTitleInp" oninput="updateGroupStyle('title', this.value)"
                                style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                        </div>
                        <div class="property-row">
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–§–æ–Ω —Å–µ–∫—Ü—ñ—ó</span>
                                <input type="color" id="groupBgColor"
                                    onchange="updateGroupStyle('background', this.value)" style="width:100%">
                            </div>
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–ö–æ–ª—ñ—Ä —Ä–∞–º–∫–∏</span>
                                <input type="color" id="groupBorderColor"
                                    onchange="updateGroupStyle('borderColor', this.value)" style="width:100%">
                            </div>
                        </div>
                        <div class="property-row">
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–¢–æ–≤—â–∏–Ω–∞ —Ä–∞–º–∫–∏ (px)</span>
                                <input type="number" id="groupBorderWidthInp"
                                    oninput="updateGroupStyle('borderWidth', this.value)" style="width:100%">
                            </div>
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–ó–∞–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è (px)</span>
                                <input type="number" id="groupRadiusInp"
                                    oninput="updateGroupStyle('borderRadius', this.value)" style="width:100%">
                            </div>
                        </div>
                        <div class="control-group">
                            <label
                                style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: var(--accent); cursor: pointer; font-weight:700;">
                                <input type="checkbox" id="groupNumbering"
                                    onchange="updateGroupStyle('showNumbering', this.checked)"> –ù—É–º–µ—Ä—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É
                            </label>
                        </div>
                    </div>
                </div>

                <div id="noSelection"
                    style="padding: 30px 20px; text-align: center; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed var(--border); margin-top: 20px;">
                    <div style="font-size: 32px; margin-bottom: 15px; opacity: 0.5;">üëÜ</div>
                    <div style="font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 8px;">
                        –í–∏–±–µ—Ä—ñ—Ç—å –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                    </div>
                    <div style="font-size: 11px; color: var(--text-dim); line-height: 1.5;">
                        –ö–ª–∞—Ü–Ω—ñ—Ç—å –Ω–∞ –±—É–¥—å-—è–∫–µ <b style="color:var(--accent)">–ø–æ–ª–µ</b> –∞–±–æ <b
                            style="color:var(--accent)">–∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–∏</b> –≤ –ø—Ä–µ–∫‚Äô—é —Å–ø—Ä–∞–≤–∞, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                        —Ä–∞–º–æ–∫, –≤—ñ–¥—Å—Ç—É–ø—ñ–≤ —Ç–∞ —Å—Ç–∏–ª—ñ–≤.
                    </div>
                </div>
            </div>

        </div><!-- end calculatorEditor -->
        <div class="sidebar-footer">
            <a href="admin.html" id="matrixLinkBtn" class="nav-btn-back"
                style="background: rgba(255,255,255,0.05); color: var(--text-dim); border: 1px solid var(--border);">–ú–∞—Ç—Ä–∏—Ü—è</a>
            <button class="btn-save" onclick="handleGlobalSave()"
                style="background: #10b981; color: white;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
    </div>

    <div class="canvas" id="mainCanvas">
        <!-- === DASHBOARD PREVIEW === -->
        <div id="dashboardPreview" style="display:none; padding-top:60px; width: 100%;">
            <div class="preview-container">
                <div class="header-preview" id="prevHeader" style="transition:0.3s; position:relative;">
                    <div id="prevLogo" class="logo-preview"><span>V</span>point</div>
                    <div id="prevSubtitle" class="subtitle-preview">–†–æ–∑—Ä–∞—Ö–æ–≤—É–π —ñ —Å—Ç–≤–æ—Ä—é–π</div>

                    <!-- Premium Illustrations -->
                    <img id="prevHeaderIllustration"
                        style="position:absolute; left:50%; top:-20px; right:auto; height:120px; display:none; object-fit:contain; transition: transform 0.1s;">
                    <img id="prevHeaderIllustration2"
                        style="position:absolute; left:50%; top:-20px; right:auto; height:120px; display:none; object-fit:contain; transition: transform 0.1s;">

                    <div class="auth-controls-preview">
                        <button class="logout-btn-preview">–í–∏–π—Ç–∏</button>
                        <button class="settings-btn-preview">‚öôÔ∏è</button>
                    </div>
                </div>

                <div id="dbCardsGrid"
                    style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px;">
                    <!-- Real cards preview -->
                </div>
                <div style="margin-top:20px; opacity:0.5; font-size:12px">* –ö–∞—Ä—Ç–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ñ —Å—Ö–µ–º–∞—Ç–∏—á–Ω–æ</div>
            </div>
        </div>

        <!-- === CALCULATOR PREVIEW === -->
        <div id="calculatorPreview" style="width:100%; display:flex; justify-content:center">
            <div class="preview-container" id="designerCanvas" style="flex:1"></div>
        </div>
    </div>

    <script>
        let selectedIds = []; // Array of selected field IDs
        let selectedGroupId = null;
        let selectedCatId = null; // Currently editing a category?

        let historyStack = [];
        const MAX_HISTORY = 50;

        function saveHistory() {
            if (typeof Schema === 'undefined') return;
            historyStack.push(JSON.stringify(Schema));
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            const btn = document.getElementById('undoBtn');
            if (btn) {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            }
        }

        function undo() {
            if (historyStack.length === 0) return;
            const previous = historyStack.pop();
            const currentSchema = JSON.parse(previous);

            // Restore Schame
            Object.keys(currentSchema).forEach(key => {
                Schema[key] = currentSchema[key];
            });

            if (historyStack.length === 0) {
                const btn = document.getElementById('undoBtn');
                btn.style.opacity = '0.3';
                btn.style.pointerEvents = 'none';
            }
            renderDesigner();
            // Deselect to avoid stale references if IDs changed (though they shouldn't)
            selectedIds = [];
            selectedGroupId = null;
            document.getElementById('noSelection').style.display = 'block';
            document.getElementById('selectionPanel').style.display = 'none';
        }

        // Add Ctrl+Z listener
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        // Explicitly update the link as soon as possible
        function updateMatrixLink() {
            const matrixBtn = document.getElementById('matrixLinkBtn');
            if (matrixBtn) {
                console.log('Update Matrix Link. Mode:', window.currentMode, 'Config:', window.currentConfigFile);
                if (window.currentMode === 'dashboard') {
                    matrixBtn.href = '../index.html';
                    matrixBtn.innerHTML = 'üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É';
                } else if (window.currentConfigFile) {
                    matrixBtn.href = 'admin.html?config=' + encodeURIComponent(window.currentConfigFile);
                }
            } else {
                console.error('Matrix button not found!');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateMatrixLink();
            renderDesigner();
        });

        // Also try running it immediately just in case
        updateMatrixLink();

        function renderDesigner() {
            if (typeof Schema === 'undefined') return;
            const container = document.getElementById('designerCanvas');
            if (!container) return;
            container.innerHTML = '';

            // FIX: Update Back to Matrix Link
            const matrixBtn = document.querySelector('a.nav-btn-back');
            if (matrixBtn && window.currentConfigFile) {
                matrixBtn.href = 'admin.html?config=' + window.currentConfigFile;
            }

            // Sync Global Inputs
            const title = Schema.layout?.title || Schema.meta?.title || '';
            const version = Schema.layout?.version || Schema.meta?.version || 'v1.0';

            const titleInp = document.getElementById('calcTitleInp');
            const versionInp = document.getElementById('calcVersionInp');
            const accentInp = document.getElementById('calcAccentColor');
            const fontInp = document.getElementById('calcBaseFontSize');

            if (titleInp) titleInp.value = title;
            if (versionInp) versionInp.value = version;
            if (accentInp) accentInp.value = Schema.layout?.accentColor || '#6366f1';
            if (fontInp) fontInp.value = Schema.layout?.baseFontSize || 14;

            if (Schema.layout?.accentColor) {
                document.documentElement.style.setProperty('--accent', Schema.layout.accentColor);
            }

            // Render Header Preview
            const headerPreview = document.createElement('div');
            headerPreview.style.padding = '0 10px 20px 10px';
            headerPreview.style.borderBottom = '1px solid var(--border)';
            headerPreview.style.marginBottom = '30px';
            headerPreview.style.display = 'flex';
            headerPreview.style.justifyContent = 'space-between';
            headerPreview.style.alignItems = 'baseline';
            headerPreview.innerHTML = `
            <div style="font-size: 18px; font-weight: 800; color:var(--accent)">${title || '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä'}</div>
             <div style="font-size: 10px; opacity:0.5; text-align: right;">
                 ${version}<br>
                    <span style="color:var(--accent); font-weight:bold;">Ctrl + Click –¥–ª—è –≤–∏–±–æ—Ä—É –¥–µ–∫—ñ–ª—å–∫–æ—Ö</span>
            </div>
            `;
            container.appendChild(headerPreview);

            // New: Category Toggles Preview
            const catSelection = document.createElement('div');
            catSelection.style.marginBottom = '25px';
            catSelection.className = 'categories-preview-container';
            catSelection.innerHTML = `
            <div style="font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="background: var(--accent); width: 4px; height: 12px; border-radius: 2px;"></span>
                –ü—Ä–æ—Ü–µ—Å–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É (–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è)
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;" id="catTogglesGrid"></div>
            `;
            container.appendChild(catSelection);

            const catGrid = catSelection.querySelector('#catTogglesGrid');
            const categories = Schema.categories || {};
            Object.keys(categories).forEach(cid => {
                const cat = categories[cid];
                if (!cat) return;
                const btn = document.createElement('div');
                btn.className = 'cat-preview-toggle';
                btn.draggable = true;
                btn.dataset.cid = cid;
                btn.style.cssText = `
            padding: 6px 14px; border-radius: 999px; font-size: 11px; font-weight: 600;
            border: 2px solid var(--accent); background: var(--accent); color: white;
            display: flex; align-items: center; gap: 6px; cursor: move; transition: 0.2s;
            `;
                btn.innerHTML = `<span style="font-size: 8px;">‚úì</span> ${cat.name}`;
                catGrid.appendChild(btn);
            });
            setupDragEvents(catGrid, '.cat-preview-toggle', updateCategoriesOrder);

            // Create Main Layout (Form + Results)
            const mainLayout = document.createElement('div');
            mainLayout.style.display = 'flex';
            mainLayout.style.gap = '30px';
            mainLayout.style.width = '100%';

            const formPanel = document.createElement('div');
            formPanel.style.flex = '2';
            formPanel.id = 'formPanelPreview';

            const resultsPanel = document.createElement('div');
            resultsPanel.style.flex = '1';
            resultsPanel.style.minWidth = '250px';
            resultsPanel.style.background = 'rgba(255,255,255,0.03)';
            resultsPanel.style.borderRadius = '16px';
            resultsPanel.style.padding = '20px';
            resultsPanel.style.border = '1px solid var(--border)';
            resultsPanel.innerHTML = `
            <h3 style="margin-top:0; font-size: 14px; text-transform:uppercase; color:var(--text-dim)">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
            <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px">
                ${Object.keys(categories).map(cid => `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:var(--text-main)">
                            <span>${categories[cid].name}</span>
                            <span style="font-weight:600; color:var(--accent)">0 –≥—Ä–Ω</span>
                        </div>
                    `).join('')}
            </div>
            <div style="display:flex; flex-direction:column; align-items:center">
                <div style="font-size: 10px; color: var(--text-dim); font-weight:700; margin-bottom: 5px; text-transform:uppercase">–í–°–¨–û–ì–û</div>
                <div style="font-size: 24px; font-weight: 800; color: white;">0 –≥—Ä–Ω</div>
            </div>
            `;

            mainLayout.appendChild(formPanel);
            mainLayout.appendChild(resultsPanel);
            container.appendChild(mainLayout);

            try {
                (Schema.groups || []).forEach((group, idx) => {
                    if (!group) return;
                    const gl = group.layout || {};
                    const groupEl = document.createElement('div');
                    groupEl.className = 'group-box';
                    groupEl.dataset.groupId = group.id;
                    groupEl.draggable = true;
                    if (gl.borderWidth) {
                        groupEl.style.border = `${gl.borderWidth}px solid ${gl.borderColor || 'rgba(255,255,255,0.1)'}`;
                    }
                    if (gl.borderRadius) {
                        groupEl.style.borderRadius = `${gl.borderRadius}px`;
                    }
                    groupEl.style.marginTop = (gl.marginTop || 0) + 'px';

                    const groupCont = document.createElement('div');
                    groupCont.className = 'group-content';
                    groupEl.appendChild(groupCont);

                    const header = document.createElement('div');
                    header.className = 'group-header';
                    const gLayout = group.layout || {};
                    const showNumbers = gLayout.showNumbering;

                    header.textContent = (showNumbers ? `${idx + 1}. ` : '') + (group.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏');
                    header.onclick = (e) => { e.stopPropagation(); selectGroup(group.id); };
                    if (selectedGroupId === group.id) header.classList.add('selected');
                    groupCont.appendChild(header);

                    groupCont.style.background = gLayout.background || (document.body.classList.contains('light-theme') ? '#fff' : '#111827');
                    groupCont.style.padding = '20px';
                    if (gl.borderRadius) { // Apply borderRadius to groupCont here, after it's defined
                        groupCont.style.borderRadius = `${gl.borderRadius}px`;
                    } else {
                        groupCont.style.borderRadius = '12px';
                    }
                    groupCont.style.border = '1px solid var(--border)';

                    const grid = document.createElement('div');
                    grid.className = 'fields-grid';
                    (Schema.fields || []).filter(f => f && f.groupId === group.id).forEach(field => {
                        grid.appendChild(createFieldCard(field));
                    });

                    groupCont.appendChild(grid);
                    formPanel.appendChild(groupEl);
                    setupDragEvents(grid, '.field-card', updateFieldsOrder);
                });
            } catch (err) {
                console.error("Render Group Error:", err);
                container.innerHTML += `<div style="color:#ef4444; padding:20px; background:rgba(239,68,68,0.1); border-radius:10px; border:1px solid #ef4444; margin-top:20px">‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –≥—Ä—É–ø: ${err.message}</div>`;
            }
            setupDragEvents(formPanel, '.group-box', updateGroupsOrder);
        }

        function pickHelpImg(input) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                updateStyle('helpImg', 'images/hints/' + fileName);
                document.getElementById('helpImgInp').value = 'images/hints/' + fileName;
            }
        }

        function createFieldCard(field) {
            const l = field.layout || {};
            const widthClass = l.width || 'w-100';
            const card = document.createElement('div');
            card.className = `field-card ${widthClass}${field.hidden ? ' hidden-card' : ''}`;
            if (selectedIds.includes(field.id)) card.classList.add('selected');
            card.dataset.id = field.id;
            card.draggable = true;

            const isRow = l.flexDirection === 'row';
            card.style.flexDirection = l.flexDirection || 'column';
            card.style.gap = (l.gap || 8) + 'px';
            if (isRow) card.style.alignItems = 'center';
            card.style.marginTop = (l.marginTop || 0) + 'px';
            card.style.marginLeft = (l.marginLeft || 0) + 'px';
            card.style.marginRight = (l.marginRight || 0) + 'px';
            if (l.cardRadius !== undefined) card.style.borderRadius = l.cardRadius + 'px';

            const isLight = document.body.classList.contains('light-theme');
            const defaultColor = isLight ? '#374151' : 'white';

            const labelStyle = `
            display: flex;
            align-items: center;
            gap: 5px;
            font-size:${l.fontSize || 13}px;
            ${isRow ? `flex: 0 0 ${l.labelWidth || 120}px;` : 'none'};
            justify-content: ${l.textAlign === 'center' ? 'center' : (l.textAlign === 'right' ? 'flex-end' : 'flex-start')};
            color:${l.color || defaultColor};
            font-weight:${l.fontWeight || 600};
            ${l.uppercase ? 'text-transform:uppercase;' : ''}
            ${l.spaced ? 'letter-spacing:0.05em;' : ''}
            `;

            card.innerHTML = `
            <div class="field-label" style="${labelStyle}">
                ${field.label || field.default || '–ü–æ–ª–µ'}
                ${l.help ? '<span class="help-icon">?</span>' : ''}
            </div>
            <div style="flex:${isRow ? 1 : 'none'}; width: 100%; display: flex; flex-direction: column; justify-content: center;">
                <div style="width:${l.inputWidth || 100}%; margin-left:${l.inputOffset || 0}px;">
                    <div class="field-type-badge">${field.type}</div>
                    ${field.type === 'action_button' ?
                    `<div class="btn-preview" style="background:${l.btnBg || '#2563eb'}; color:${l.btnColor || '#fff'}; font-size:${l.btnFontSize || 10}px; border-radius:${l.btnRadius || 8}px; padding:${(l.btnPadding || 12) / 2}px; text-align:center; font-weight:700; margin-top:5px;">${field.default || 'BUTTON'}</div>` :
                    field.type === 'select_modal' || field.type === 'select' ?
                        `<div class="input-preview" style="border: ${l.inpBorderWidth !== undefined ? l.inpBorderWidth : 1}px solid ${l.inpBorder || '#d1d5db'}; border-radius: ${l.inpRadius !== undefined ? l.inpRadius : 6}px; background:${l.inpBg || '#fff'}; display: flex; justify-content: space-between; align-items: center; padding: 6px 10px;"><span>${field.placeholderText || field.label || '–í–∏–±–µ—Ä—ñ—Ç—å...'}</span><span style="font-size: 8px;">‚ñº</span></div>` :
                        `<div class="input-preview" style="border: ${l.inpBorderWidth !== undefined ? l.inpBorderWidth : 1}px solid ${l.inpBorder || '#d1d5db'}; border-radius: ${l.inpRadius !== undefined ? l.inpRadius : 6}px; background:${l.inpBg || '#fff'}; color:${l.inpBg ? (parseInt(l.inpBg.replace('#', ''), 16) > 0xffffff / 2 ? '#000' : '#fff') : '#9ca3af'}">${field.placeholderText || l.placeholder || 'Placeholder...'}</div>`
                }
                </div>
            </div>
            `;
            card.onclick = (e) => {
                e.stopPropagation();
                const isMulti = e.ctrlKey || e.metaKey || e.shiftKey;
                selectField(field.id, isMulti);
            };
            return card;
        }

        function updateGlobal(prop, val) {
            if (!Schema.layout) Schema.layout = {};
            if (prop === 'title' || prop === 'version' || prop === 'accentColor' || prop === 'baseFontSize') {
                Schema.layout[prop] = (prop.includes('Size')) ? parseInt(val) : val;
                if (prop === 'accentColor') document.documentElement.style.setProperty('--accent', val);
            } else {
                Schema.layout[prop] = val;
            }
            renderDesigner();
        }

        function setGlobalTheme(theme) {
            saveHistory();
            Schema.layout = Schema.layout || {};
            Schema.layout.theme = theme;
            document.body.classList.toggle('light-theme', theme === 'light');
            document.getElementById('themeDark').classList.toggle('active', theme === 'dark' || !theme);
            document.getElementById('themeLight').classList.toggle('active', theme === 'light');
            renderDesigner();
        }

        function resetAllToDefault() {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤?')) return;
            saveHistory();
            Schema.fields.forEach(f => {
                f.layout = {};
            });
            renderDesigner();
            alert('–°—Ç–∏–ª—ñ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤ –±—É–ª–æ —Å–∫–∏–Ω—É—Ç–æ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö.');
        }

        function applySelectedStyleToAll() {
            if (selectedIds.length === 0) return;
            if (!confirm('–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Å—Ç–∏–ª—å –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–æ–ª—è –¥–æ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –ø–æ–ª—ñ–≤?')) return;
            saveHistory();
            const sourceField = Schema.fields.find(f => f.id === selectedIds[0]);
            const styleToCopy = JSON.parse(JSON.stringify(sourceField.layout || {}));

            Schema.fields.forEach(f => {
                f.layout = JSON.parse(JSON.stringify(styleToCopy));
            });
            renderDesigner();
            alert('–°—Ç–∏–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –¥–æ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤.');
        }

        function selectField(id, multi = false) {
            if (multi) {
                const idx = selectedIds.indexOf(id);
                if (idx > -1) selectedIds.splice(idx, 1);
                else selectedIds.push(id);
            } else {
                selectedIds = [id];
            }
            selectedGroupId = null;

            if (selectedIds.length === 0) {
                document.getElementById('noSelection').style.display = 'block';
                document.getElementById('selectionPanel').style.display = 'none';
                renderDesigner();
                return;
            }

            const field = Schema.fields.find(f => f.id === selectedIds[0]);
            const l = field.layout || {};

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('selectionPanel').style.display = 'block';
            document.getElementById('fieldProperties').style.display = 'block';
            document.getElementById('groupProperties').style.display = 'none';

            // Sync UI for the first/main selected field
            const labelInp = document.getElementById('fieldLabelInp');
            if (labelInp) labelInp.value = field.label || field.default || '';

            document.getElementById('fontSizeRange').value = l.fontSize || 13;
            document.getElementById('fontSizeVal').textContent = l.fontSize || 13;
            // ... (sync other inputs as usual, they will show first item state)
            document.getElementById('fontWeightSelect').value = l.fontWeight || 400;
            document.getElementById('labelColor').value = l.color || (document.body.classList.contains('light-theme') ? '#111827' : '#ffffff');
            document.getElementById('placeholderInp').value = l.placeholder || '';
            document.getElementById('helpInp').value = l.help || '';
            document.getElementById('helpImgInp').value = l.helpImg || '';
            document.getElementById('inputWidthRange').value = l.inputWidth || 100;
            document.getElementById('inputWidthVal').textContent = (l.inputWidth || 100) + '%';
            document.getElementById('inputOffsetRange').value = l.inputOffset || 0;
            document.getElementById('inputOffsetVal').textContent = l.inputOffset || 0;
            document.getElementById('inpBorderColor').value = l.inpBorder || '#d1d5db';
            document.getElementById('inpBorderWidthInp').value = l.inpBorderWidth !== undefined ? l.inpBorderWidth : 1;
            document.getElementById('inpBgColor').value = l.inpBg || '#ffffff';
            document.getElementById('inpRadiusInp').value = l.inpRadius !== undefined ? l.inpRadius : 6;
            document.getElementById('marginTopInp').value = l.marginTop || 0;
            document.getElementById('marginLeftInp').value = l.marginLeft || 0;
            document.getElementById('marginRightInp').value = l.marginRight || 0;
            document.getElementById('cardRadiusInp').value = l.cardRadius !== undefined ? l.cardRadius : 12;
            document.getElementById('gapInp').value = l.gap || 8;
            document.getElementById('paddingInp').value = l.padding || 15;
            document.getElementById('glassToggle').checked = !!l.glass;
            document.getElementById('fieldHidden').checked = !!field.hidden;

            const lwCtrl = document.getElementById('labelWidthControl');
            if (l.flexDirection === 'row') {
                lwCtrl.style.display = 'block';
                document.getElementById('labelWidthRange').value = l.labelWidth || 120;
                document.getElementById('labelWidthVal').textContent = (l.labelWidth || 120) + 'px';
            } else {
                lwCtrl.style.display = 'none';
            }

            document.getElementById('btnUpper').classList.toggle('active', !!l.uppercase);
            document.getElementById('btnLetterSpacing').classList.toggle('active', !!l.spaced);
            document.getElementById('btnDirCol').classList.toggle('active', (l.flexDirection || 'column') === 'column');
            document.getElementById('btnDirRow').classList.toggle('active', l.flexDirection === 'row');

            document.getElementById('alignLeft').classList.toggle('active', (l.textAlign || 'left') === 'left');
            document.getElementById('alignCenter').classList.toggle('active', l.textAlign === 'center');
            document.getElementById('alignRight').classList.toggle('active', l.textAlign === 'right');

            ['none', 'subtle', 'deep', 'glow'].forEach(s => {
                const btn = document.getElementById('sh' + s.charAt(0).toUpperCase() + s.slice(1));
                if (btn) btn.classList.toggle('active', (l.shadow || 'none') === s);
            });

            const btnProps = document.getElementById('actionButtonProperties');
            const prodProps = document.getElementById('productWindowProperties');
            if (field.type === 'action_button' || field.type === 'select_modal') {
                if (field.type === 'action_button') {
                    btnProps.style.display = 'block';
                    document.getElementById('btnBgColor').value = l.btnBg || '#2563eb';
                    document.getElementById('btnTextColor').value = l.btnColor || '#ffffff';
                    document.getElementById('btnFontSize').value = l.btnFontSize || 14;
                    document.getElementById('btnRadius').value = l.btnRadius || 8;
                } else {
                    btnProps.style.display = 'none';
                }
                prodProps.style.display = 'block';
                document.getElementById('prodWidthInp').value = l.prodWidth || '';
                document.getElementById('prodBgColor').value = l.prodBg || '#ffffff';
            } else {
                btnProps.style.display = 'none';
                prodProps.style.display = 'none';
            }

            renderDesigner();
        }

        function selectGroup(id) {
            selectedGroupId = id; selectedIds = [];
            const group = Schema.groups.find(g => g.id === id);
            const gl = group.layout || {};

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('selectionPanel').style.display = 'block';
            document.getElementById('fieldProperties').style.display = 'none';
            document.getElementById('groupProperties').style.display = 'block';

            document.getElementById('groupTitleInp').value = group.title || '';
            document.getElementById('groupBgColor').value = gl.background || (document.body.classList.contains('light-theme') ? '#ffffff' : '#111827');
            document.getElementById('groupBorderColor').value = gl.borderColor || 'rgba(255,255,255,0.1)';
            document.getElementById('groupBorderWidthInp').value = gl.borderWidth || 0;
            document.getElementById('groupRadiusInp').value = gl.borderRadius || 16;
            document.getElementById('groupNumbering').checked = !!gl.showNumbering;

            renderDesigner();
        }

        function updateGroupStyle(prop, val) {
            const group = Schema.groups.find(g => g.id === selectedGroupId);
            saveHistory();
            if (prop === 'title') {
                group.title = val;
            } else {
                if (!group.layout) group.layout = {};
                group.layout[prop] = val;
            }
            renderDesigner();
        }
        function toggleLayoutProp(prop) {
            saveHistory();
            selectedIds.forEach(id => {
                const field = Schema.fields.find(f => f.id === id);
                if (!field.layout) field.layout = {};
                field.layout[prop] = !field.layout[prop];
            });
            renderDesigner();
            selectField(selectedIds[0], true); // Refresh UI state based on first item
            // Note: multi selection refresh logic might needs refinement for toggle buttons
        }

        function updateStyle(prop, val) {
            if (selectedIds.length === 0) return;
            saveHistory();
            selectedIds.forEach(id => {
                const field = Schema.fields.find(f => f.id === id);
                if (!field.layout) field.layout = {};

                const intProps = ['fontSize', 'inputWidth', 'btnFontSize', 'btnRadius', 'gap', 'padding', 'labelWidth', 'inputOffset', 'inpBorderWidth', 'inpRadius', 'marginTop', 'marginLeft', 'marginRight', 'cardRadius'];
                field.layout[prop] = intProps.includes(prop) ? parseInt(val) : val;
            });

            // Immediate UI update for sliders (based on value passed)
            if (prop === 'inputWidth') document.getElementById('inputWidthVal').textContent = val + '%';
            if (prop === 'inputOffset') document.getElementById('inputOffsetVal').textContent = val;
            if (prop === 'labelWidth') document.getElementById('labelWidthVal').textContent = val + 'px';

            renderDesigner();
            if (prop === 'shadow' || prop === 'flexDirection') selectField(selectedIds[0], true);
        }

        function setFieldWidth(w) { updateStyle('width', w); }
        function updateFieldLabel(val) {
            if (selectedIds.length === 0) return;
            selectedIds.forEach(id => {
                const field = Schema.fields.find(f => f.id === id);
                field.label = val;
            });
            renderDesigner();
        }
        function toggleFieldHidden(v) {
            selectedIds.forEach(id => {
                Schema.fields.find(f => f.id === id).hidden = v;
            });
            renderDesigner();
        }

        function updateCategoriesOrder() {
            saveHistory();
            const newOrder = {};
            [...document.querySelectorAll('.cat-preview-toggle')].forEach(el => {
                const cid = el.dataset.cid;
                newOrder[cid] = Schema.categories[cid];
            });
            Schema.categories = newOrder;
            renderDesigner(); // Re-render to show updated results order
        }

        function updateGroupStyle(prop, val) {
            const group = Schema.groups.find(g => g.id === selectedGroupId);
            if (!group.layout) group.layout = {};
            group.layout[prop] = prop === 'borderWidth' ? parseInt(val) : val;
            renderDesigner();
        }

        function setupDragEvents(cont, sel, onDrop) {
            cont.onsubmit = e => e.preventDefault();
            cont.addEventListener('dragstart', e => { if (e.target.matches(sel)) e.target.classList.add('dragging'); });
            cont.addEventListener('dragend', e => { if (e.target.matches(sel)) e.target.classList.remove('dragging'); });
            cont.addEventListener('dragover', e => {
                e.preventDefault();
                const drag = document.querySelector('.dragging');
                if (!drag || !drag.matches(sel)) return;

                // Improved 2D proximity sorting
                const others = [...cont.querySelectorAll(`${sel}:not(.dragging)`)];
                const after = others.reduce((clos, child) => {
                    const box = child.getBoundingClientRect();
                    const centerX = box.left + box.width / 2;
                    const centerY = box.top + box.height / 2;

                    // Simple logic: if mouse is before the center of the element, place before it
                    const isBefore = e.clientX < centerX && e.clientY < (box.top + box.height + 10);
                    const isTrulyBefore = e.clientY < box.top || (e.clientY < (box.top + box.height) && e.clientX < centerX);

                    const off = isTrulyBefore ? -1 : 1;
                    // This is still a bit simple, but better than vertical-only
                    // Let's use distance to box center to find the insertion point
                    const dist = Math.sqrt(Math.pow(e.clientX - centerX, 2) + Math.pow(e.clientY - centerY, 2));

                    if (e.clientX < centerX || e.clientY < box.top) {
                        if (dist < clos.dist) return { dist, el: child };
                    }
                    return clos;
                }, { dist: Infinity }).el;

                if (after) cont.insertBefore(drag, after);
                else cont.appendChild(drag);
            });
            cont.addEventListener('drop', (e) => {
                if (typeof Schema !== 'undefined') saveHistory();
                setTimeout(onDrop, 10);
            });
        }

        function updateFieldsOrder() {
            if (typeof Schema === 'undefined') return;
            const sorted = [];
            document.querySelectorAll('.group-box').forEach(gb => {
                const gid = gb.dataset.groupId;
                gb.querySelectorAll('.field-card').forEach(fc => {
                    const f = Schema.fields.find(x => x.id === fc.dataset.id);
                    if (f) {
                        f.groupId = gid;
                        sorted.push(f);
                    }
                });
            });
            Schema.fields = [...sorted, ...Schema.fields.filter(f => !sorted.includes(f))];
        }

        function updateGroupsOrder() {
            if (typeof Schema === 'undefined') return;
            Schema.groups = [...document.querySelectorAll('.group-box')].map(gb => Schema.groups.find(g => g.id === gb.dataset.groupId)).filter(g => g);
        }

        async function saveLayout() {
            const defaultName = window.currentConfigFile ? window.currentConfigFile.split('/').pop() : 'schema.js';
            const filename = window.currentConfigFile ? window.currentConfigFile : 'data/' + defaultName;
            const fileContent = `const Schema = ${JSON.stringify(Schema, null, 4)};\nwindow.Schema = Schema;`;

            // –°–ø—Ä–æ–±–∞Ëá™Âãï—á–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, content: fileContent })
                });
                if (response.ok) {
                    console.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —á–µ—Ä–µ–∑ Local Saver");
                    alert('‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                    return;
                }
            } catch (e) { }

            try {
                const handle = await window.showSaveFilePicker({ suggestedName: defaultName, types: [{ accept: { 'text/javascript': ['.js'] } }] });
                const writ = await handle.createWritable();
                await writ.write(fileContent);
                await writ.close(); alert('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
            } catch (e) { if (e.name !== 'AbortError') console.error(e); }
        }
    </script>
    <script>
        // --- Centralized Designer Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            initContextSwitcher();
            if (window.currentMode === 'dashboard') {
                activateDashboardMode();
            } else {
                activateCalculatorMode();
            }
        });

        async function initContextSwitcher() {
            // Robust loading: if config is missing, try fetching it
            if (!window.CalculatorConfig) {
                try {
                    const response = await fetch('data/config_calculators.js?v=' + new Date().getTime());
                    if (response.ok) {
                        const text = await response.text();
                        eval(text); // Manually execute config script
                    }
                } catch (e) {
                    console.error("Failed to load config manually", e);
                }
            }

            const select = document.getElementById('contextSwitcher');
            const group = document.getElementById('calcOptions');
            if (window.CalculatorConfig) {
                // Clear existing just in case
                group.innerHTML = '';
                window.CalculatorConfig.forEach(conf => {
                    const opt = document.createElement('option');
                    opt.value = conf.file;
                    const isImg = conf.icon && (conf.icon.includes('/') || conf.icon.includes('.'));
                    const iconDisplay = isImg ? 'üñºÔ∏è' : conf.icon;
                    opt.textContent = `${iconDisplay} ${conf.title}`;
                    if (window.currentConfigFile === conf.file) opt.selected = true;
                    group.appendChild(opt);
                });
            } else {
                // Fallback if absolutely nothing works
                const opt = document.createElement('option');
                opt.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó";
                group.appendChild(opt);
            }
            if (window.currentMode === 'dashboard') select.value = 'dashboard';
        }

        function switchContext(val) {
            if (val === 'dashboard') window.location.href = 'designer.html?mode=dashboard';
            else window.location.href = 'designer.html?config=' + val;
        }

        function handleSave() {
            if (window.currentMode === 'dashboard') saveDashboardConfig();
            else saveLayout();
        }

        function activateDashboardMode() {
            document.getElementById('dashboardEditor').style.display = 'block';
            document.getElementById('calculatorEditor').style.display = 'none';
            document.getElementById('dashboardPreview').style.display = 'block';
            document.getElementById('calculatorPreview').style.display = 'none';
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) undoBtn.style.display = 'none';
            loadDashboardValues();
            // CRITICAL: Render the calculator list editor so user can edit titles
            renderCalculatorsEditorUI();
        }

        function activateCalculatorMode() {
            document.getElementById('dashboardEditor').style.display = 'none';
            document.getElementById('calculatorEditor').style.display = 'block';
            document.getElementById('dashboardPreview').style.display = 'none';
            document.getElementById('calculatorPreview').style.display = 'flex';
            const backBtn = document.querySelector('.calc-mode-back');
            if (backBtn) backBtn.style.display = 'flex';
            if (typeof renderDesigner === 'function') renderDesigner();
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function loadDashboardValues() {
            const cfg = window.DashboardConfig || {};
            document.getElementById('dbTitle').value = cfg.siteTitle || '';
            document.getElementById('dbSubtitle').value = cfg.siteSubtitle || '';
            document.getElementById('dbColor').value = cfg.themeColor || '#1e88e5';
            document.getElementById('dbColorText').value = cfg.themeColor || '#1e88e5';
            document.getElementById('dbLogoText').value = cfg.logoText || '';
            document.getElementById('dbLogoImg').value = cfg.logoImage || '';
            document.getElementById('dbBgImage').value = cfg.backgroundImage || '';

            document.getElementById('dbBgType').value = cfg.bgType || 'color';
            document.getElementById('dbBlur').value = cfg.glassBlur ?? 10;
            document.getElementById('dbOpacity').value = cfg.glassOpacity ?? 0.1;

            // New Card Styles
            document.getElementById('dbCardWidth').value = cfg.cardMinWidth ?? 280;
            document.getElementById('dbCardPadding').value = cfg.cardPadding ?? 30;
            document.getElementById('dbCardIconSize').value = cfg.cardIconSize ?? 64;
            document.getElementById('dbCardTitleSize').value = cfg.cardTitleSize ?? 24;
            document.getElementById('dbCardTitleColor').value = cfg.cardTitleColor || '#ffffff';
            document.getElementById('dbCardDescSize').value = cfg.cardDescSize ?? 14;
            document.getElementById('dbCardDescColor').value = cfg.cardDescColor || '#9ca3af';

            // Premium Styles
            document.getElementById('dbTitleSize').value = cfg.siteTitleSize ?? 48;
            document.getElementById('dbHeaderIllustration').value = cfg.headerIllustration || '';
            document.getElementById('dbCardTitleWeight').value = cfg.cardTitleWeight || '800';
            document.getElementById('dbPlaceholderBg').value = cfg.placeholderBg || '#cbd5e1';
            document.getElementById('dbPlaceholderBadge').value = cfg.placeholderBadgeText || '–°–∫–æ—Ä–æ';

            // Coordinates & Header Style
            document.getElementById('dbLogoX').value = cfg.logoX ?? 0;
            document.getElementById('dbLogoY').value = cfg.logoY ?? 0;
            document.getElementById('dbLogoScale').value = cfg.logoScale ?? 1;

            document.getElementById('dbIllus1X').value = cfg.illus1X ?? 0;
            document.getElementById('dbIllus1Y').value = cfg.illus1Y ?? 0;
            document.getElementById('dbIllus1Scale').value = cfg.illus1Scale ?? 1;

            document.getElementById('dbHeaderIllustration2').value = cfg.headerIllustration2 || '';
            document.getElementById('dbIllus2X').value = cfg.illus2X ?? 0;
            document.getElementById('dbIllus2Y').value = cfg.illus2Y ?? 0;
            document.getElementById('dbIllus2Scale').value = cfg.illus2Scale ?? 1;

            document.getElementById('dbHeaderBg').value = cfg.headerBgColor || '#ffffff';
            document.getElementById('dbHeaderOpacity').value = cfg.headerOpacity ?? 0.15;
            document.getElementById('dbHeaderBlur').value = cfg.headerBlur ?? 10;

            updateDashboardPreview();
        }

        function updateDashboardPreview() {
            const title = document.getElementById('dbTitle').value;
            const subtitle = document.getElementById('dbSubtitle').value;
            const color = document.getElementById('dbColor').value;
            const logoText = document.getElementById('dbLogoText').value;
            const logoImg = document.getElementById('dbLogoImg').value;
            const bgImage = document.getElementById('dbBgImage').value;
            const bgType = document.getElementById('dbBgType').value;
            const glassBlur = parseInt(document.getElementById('dbBlur').value);
            const glassOpacity = parseFloat(document.getElementById('dbOpacity').value);
            const titleSize = document.getElementById('dbTitleSize').value;
            const headerIllus = document.getElementById('dbHeaderIllustration').value;
            const headerIllus2 = document.getElementById('dbHeaderIllustration2').value;

            const hBg = document.getElementById('dbHeaderBg').value;
            const hBlur = parseInt(document.getElementById('dbHeaderBlur').value);
            const hOpacity = parseFloat(document.getElementById('dbHeaderOpacity').value);

            document.getElementById('dbBlurVal').innerText = glassBlur;
            document.getElementById('dbOpacityVal').innerText = glassOpacity.toFixed(2);
            document.getElementById('dbHeaderOpacityVal').innerText = hOpacity.toFixed(2);
            document.getElementById('dbHeaderBlurVal').innerText = hBlur;
            document.getElementById('dbTitleSizeVal').innerText = titleSize;

            document.getElementById('dbCardWidthVal').textContent = document.getElementById('dbCardWidth').value;
            document.getElementById('dbCardPaddingVal').textContent = document.getElementById('dbCardPadding').value;
            document.getElementById('dbCardIconSizeVal').textContent = document.getElementById('dbCardIconSize').value;
            document.getElementById('dbCardTitleSizeVal').textContent = document.getElementById('dbCardTitleSize').value;
            document.getElementById('dbCardDescSizeVal').textContent = document.getElementById('dbCardDescSize').value;

            const canvas = document.getElementById('mainCanvas');
            const prevHeader = document.getElementById('prevHeader');
            const prevLogo = document.getElementById('prevLogo');
            const prevSubtitle = document.getElementById('prevSubtitle');

            prevHeader.style.background = hexToRgba(hBg, hOpacity);
            prevHeader.style.backdropFilter = `blur(${hBlur}px)`;
            prevHeader.style.webkitBackdropFilter = `blur(${hBlur}px)`;
            prevHeader.style.border = '2px solid rgba(255,255,255,0.15)';

            prevLogo.style.fontSize = titleSize + 'px';

            // Illustrations
            const prevIllus = document.getElementById('prevHeaderIllustration');
            const i1X = document.getElementById('dbIllus1X').value;
            const i1Y = document.getElementById('dbIllus1Y').value;
            const i1S = document.getElementById('dbIllus1Scale').value;

            if (headerIllus) {
                let src1 = headerIllus;
                if (src1 && src1.startsWith('images/')) src1 = '../' + src1;
                const finalSrc1 = (src1.startsWith('blob:') || src1.startsWith('data:')) ? src1 : encodeURI(src1);
                prevIllus.src = finalSrc1;
                prevIllus.style.display = 'block';
                prevIllus.style.transform = `translateX(-50%) translate(${i1X}px, ${i1Y}px) scale(${i1S})`;
            } else {
                prevIllus.style.display = 'none';
            }

            const prevIllus2 = document.getElementById('prevHeaderIllustration2');
            const i2X = document.getElementById('dbIllus2X').value;
            const i2Y = document.getElementById('dbIllus2Y').value;
            const i2S = document.getElementById('dbIllus2Scale').value;

            if (headerIllus2) {
                let src2 = headerIllus2;
                if (src2 && src2.startsWith('images/')) src2 = '../' + src2;
                const finalSrc2 = (src2.startsWith('blob:') || src2.startsWith('data:')) ? src2 : encodeURI(src2);
                prevIllus2.src = finalSrc2;
                prevIllus2.style.display = 'block';
                prevIllus2.style.transform = `translateX(-50%) translate(${i2X}px, ${i2Y}px) scale(${i2S})`;
            } else {
                prevIllus2.style.display = 'none';
            }

            const lX = document.getElementById('dbLogoX').value;
            const lY = document.getElementById('dbLogoY').value;
            const lS = document.getElementById('dbLogoScale').value;
            prevLogo.style.transform = `translate(${lX}px, ${lY}px) scale(${lS})`;
            prevLogo.style.transformOrigin = 'center';

            // Apply Logo Image with Preview support
            const displayLogo = window._dbLogoPreview || logoImg;
            if (displayLogo) {
                let dLogo = displayLogo;
                if (dLogo && dLogo.startsWith('images/')) dLogo = '../' + dLogo;
                const finalLogoSrc = (dLogo && (dLogo.startsWith('blob:') || dLogo.startsWith('data:'))) ? dLogo : encodeURI(dLogo);
                prevLogo.innerHTML = `<img src="${finalLogoSrc}" style="height: 60px; display: block; margin: 0 auto;">`;
            } else {
                prevLogo.textContent = logoText || title || "Vpoint";
                prevLogo.classList.add('logo-glow');
            }

            prevSubtitle.textContent = subtitle;

            // Background Type with Preview support
            const displayBg = window._dbBgPreview || bgImage;
            if (bgType === 'animation') {
                canvas.style.backgroundImage = 'none';
                canvas.style.backgroundColor = '#0f172a';
                // Sync Blobs
                canvas.querySelectorAll('.blob').forEach(b => b.remove());
                for (let i = 0; i < 3; i++) {
                    const blob = document.createElement('div');
                    blob.className = 'blob';
                    blob.style.left = Math.random() * 100 + '%';
                    blob.style.top = Math.random() * 100 + '%';
                    blob.style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
                    blob.style.animationDuration = (10 + Math.random() * 20) + 's';
                    blob.style.animationDelay = (Math.random() * -20) + 's';
                    canvas.appendChild(blob);
                }
            } else if (bgType === 'gradient') {
                canvas.style.backgroundImage = 'none';
                canvas.style.background = `linear-gradient(135deg, ${color} 0%, #0f172a 100%)`;
            } else if (bgType === 'image' && displayBg) {
                canvas.style.background = `url('${displayBg}') center/cover no-repeat`;
            } else {
                canvas.style.backgroundImage = 'none';
                canvas.style.background = color;
            }

            renderDashboardCardsPreview();
            renderCalculatorsEditorUI();
        }

        function renderDashboardCardsPreview() {
            const grid = document.getElementById('dbCardsGrid');
            if (!grid) return;
            grid.innerHTML = '';

            if (!window.CalculatorConfig) return;

            const glassBlur = document.getElementById('dbBlur').value;
            let glassOpacity = parseFloat(document.getElementById('dbOpacity').value);

            window.CalculatorConfig.forEach((conf, idx) => {
                const card = document.createElement('div');
                card.className = 'dashboard-card-drag';
                card.draggable = true;
                card.dataset.idx = idx;
                const cardWidth = document.getElementById('dbCardWidth').value;
                const cardPadding = document.getElementById('dbCardPadding').value;
                const cardIconSize = document.getElementById('dbCardIconSize').value;
                const cardTitleSize = document.getElementById('dbCardTitleSize').value;
                const cardTitleColor = document.getElementById('dbCardTitleColor').value;
                const cardDescSize = document.getElementById('dbCardDescSize').value;
                const cardDescColor = document.getElementById('dbCardDescColor').value;
                const cardTitleWeight = document.getElementById('dbCardTitleWeight').value;
                const placeholderBg = document.getElementById('dbPlaceholderBg').value;
                const placeholderBadge = document.getElementById('dbPlaceholderBadge').value;

                grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${cardWidth}px, 1fr))`;
                grid.style.gridAutoRows = '1fr';
                grid.style.alignItems = 'stretch';
                grid.style.justifyItems = 'stretch';

                const colSpan = conf.colSpan || 1;
                const isPlaceholder = conf.isPlaceholder;

                let bgStyle = `background: rgba(255, 255, 255, ${glassOpacity});`;
                if (isPlaceholder && placeholderBg) {
                    bgStyle = `background: ${placeholderBg}; color: #334155 !important;`;
                }

                card.style.cssText = `
                    ${bgStyle}
                    border: 2px solid rgba(255, 255, 255, 0.15) !important;
                    border-radius: 20px;
                    padding: ${cardPadding}px;
                    text-align: center;
                    cursor: pointer;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                    height: 100%;
                    width: 100%;
                    grid-column: span ${colSpan};
                    transition: 0.3s;
                    box-sizing: border-box;
                    position: relative;
                `;
                if (idx === window.selectedCalcIdx) card.classList.add('selected-db-card');

                let badgeHtml = '';
                if (isPlaceholder) {
                    badgeHtml = `<div class="badge" style="background:#d97706; margin-bottom:10px">${placeholderBadge}</div>`;
                } else if (conf.badge) {
                    badgeHtml = `<div class="badge" style="margin-bottom:10px">${conf.badge}</div>`;
                }

                const isImage = (conf.icon && (conf.icon.includes('/') || conf.icon.includes('.')));
                const displayIcon = conf._previewIcon || conf.icon;
                let dIcon = displayIcon;
                if (dIcon && dIcon.startsWith('images/')) dIcon = '../' + dIcon;

                // [FIX] Encode URI for Cyrillic support
                const finalSrc = (dIcon && (dIcon.startsWith('blob:') || dIcon.startsWith('data:'))) ? dIcon : encodeURI(dIcon);
                const iconHtml = isImage ? `<img src="${finalSrc}" style="height:${cardIconSize}px; display:block; margin: 0 auto; object-fit: contain;">` : `<div style="font-size:${cardIconSize}px">${conf.icon}</div>`;

                card.innerHTML = `
                    <button onclick="removeCalcFromConfig(${idx}); event.stopPropagation();" 
                        style="position:absolute; top:12px; right:12px; background:#ef4444; border:none; color:white; width:28px; height:28px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; z-index:10; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s;" 
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="–í–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>
                    <div style="flex-grow: 1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        ${badgeHtml}
                        <div style="height: ${cardIconSize}px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                            ${iconHtml}
                        </div>
                        <div style="font-size:${cardTitleSize}px; color:${isPlaceholder ? 'inherit' : cardTitleColor}; font-weight:${cardTitleWeight}; margin-bottom: 8px; line-height: 1.2;">${conf.title}</div>
                        <div style="font-size:${cardDescSize}px; color:${isPlaceholder ? 'inherit' : cardDescColor}; opacity:0.8; line-height: 1.4; max-width: 250px;">${conf.desc || ''}</div>
                    </div>
                    <button class="btn-logic" onclick="event.stopPropagation(); window.location.href='admin.html?config=${conf.file}'" 
                        style="margin-top:20px; font-size:10px; padding:6px 12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:99px; cursor:pointer; color:inherit;">
                        ‚öôÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É
                    </button>
                `;

                card.onclick = (e) => {
                    if (card.classList.contains('dragging')) return;
                    selectCalculatorCard(idx);
                };

                card.onmouseenter = () => { if (card.querySelector('.edit-hint')) card.querySelector('.edit-hint').style.opacity = '1'; };
                card.onmouseleave = () => { if (card.querySelector('.edit-hint')) card.querySelector('.edit-hint').style.opacity = '0'; };

                card.addEventListener('dragstart', () => card.classList.add('dragging'));
                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    const dragItems = [...grid.querySelectorAll('.dashboard-card-drag')];
                    const newOrderIndices = dragItems.map(el => parseInt(el.dataset.idx));
                    window.CalculatorConfig = newOrderIndices.map(i => window.CalculatorConfig[i]);
                    updateDashboardPreview();
                });

                grid.appendChild(card);
            });

            // –ö–Ω–æ–ø–∫–∞ "+" –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
            const addCard = document.createElement('div');
            addCard.className = 'dashboard-card-add';
            addCard.style.cssText = `
                background: rgba(255, 255, 255, ${glassOpacity * 0.8});
                border: 3px dashed var(--accent) !important;
                border-radius: 20px;
                padding: 40px;
                text-align: center;
                cursor: pointer;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 200px;
                transition: 0.3s;
                box-sizing: border-box;
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
            `;
            addCard.innerHTML = `
                <div style="font-size: 60px; color: rgba(255,255,255,0.5); font-weight: 300; transition: 0.3s;" class="plus-icon">+</div>
                <div style="color: rgba(255,255,255,0.4); font-size: 14px; margin-top: 10px;">–î–æ–¥–∞—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
            `;
            addCard.onmouseover = () => {
                addCard.style.background = `rgba(255, 255, 255, ${glassOpacity})`;
                addCard.style.borderColor = 'rgba(255, 255, 255, 0.6)';
                addCard.querySelector('.plus-icon').style.color = 'white';
                addCard.querySelector('.plus-icon').style.transform = 'scale(1.1)';
            };
            addCard.onmouseout = () => {
                addCard.style.background = `rgba(255, 255, 255, ${glassOpacity * 0.5})`;
                addCard.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                addCard.querySelector('.plus-icon').style.color = 'rgba(255,255,255,0.5)';
                addCard.querySelector('.plus-icon').style.transform = 'scale(1)';
            };
            addCard.onclick = () => {
                addNewCalculatorToConfig();
                // Scroll to newly added item in sidebar
                setTimeout(() => {
                    const list = document.getElementById('calculatorsListEditor');
                    if (list && list.lastChild) list.lastChild.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            };

            // Add at the END of the grid
            grid.appendChild(addCard);

            grid.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;
                const afterElement = getDragAfterElementX(grid, e.clientX); // Search by X for grid
                if (afterElement == null) {
                    grid.appendChild(dragging);
                } else {
                    grid.insertBefore(dragging, afterElement);
                }
            });
        }

        function selectCalculatorCard(idx) {
            window.selectedCalcIdx = idx;
            renderDashboardCardsPreview();
            renderCalculatorsEditorUI();

            // Scroll sidebar to this item
            const item = document.querySelector(`.calc-edit-item[data-idx="${idx}"]`);
            if (item) {
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                item.style.borderColor = 'var(--accent)';
                setTimeout(() => item.style.borderColor = 'var(--border)', 2000);
            }
        }

        async function editCalculatorFromDashboard(calcId) {
            const conf = window.CalculatorConfig.find(c => c.id === calcId);
            if (!conf) return;

            if (!confirm(`–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ —Ç–∞ –ø–æ–ª—ñ–≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ "${conf.title}" ? `)) return;

            // Load script dynamically
            try {
                // Remove old script if exists
                const oldScript = document.getElementById('calc-schema-script');
                if (oldScript) oldScript.remove();

                const script = document.createElement('script');
                script.id = 'calc-schema-script';
                let sSrc = conf.file;
                if (sSrc.startsWith('data/')) sSrc = '../' + sSrc;
                script.src = sSrc + '?v=' + Date.now();

                script.onload = () => {
                    activateCalculatorMode();
                    alert(`–û–±—Ä–∞–Ω–æ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: ${conf.title} `);
                };

                document.head.appendChild(script);
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ö–µ–º–∏: ' + e.message);
            }
        }

        function getDragAfterElementX(container, x) {
            const draggableElements = [...container.querySelectorAll('.dashboard-card-drag:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function renderCalculatorsEditorUI() {
            const list = document.getElementById('calculatorsListEditor');
            if (!list) return;

            // Forces refresh
            list.innerHTML = '';

            if (!window.CalculatorConfig) return;

            window.CalculatorConfig.forEach((conf, idx) => {
                const item = document.createElement('div');
                item.className = 'calc-edit-item';
                item.draggable = true;
                item.dataset.idx = idx;

                // Highlight if selected
                const isSelected = window.selectedDbIdx === idx;

                const isPlaceholder = !!conf.isPlaceholder;

                item.style.cssText = `
                background: ${isSelected ? 'rgba(99, 102, 241, 0.2)' : 'rgba(0, 0, 0, 0.2)'};
                border: 2px solid ${isSelected ? 'var(--accent)' : (isPlaceholder ? '#d97706' : 'var(--border)')};
                border-radius: 10px;
                padding: 12px;
                cursor: move;
                transition: 0.2s;
                position: relative;
                `;
                if (isPlaceholder) item.style.background = 'rgba(217, 119, 6, 0.05)';

                const colSpan = conf.colSpan || 1;

                item.innerHTML = `
                    <button onclick="removeCalcFromConfig(${idx}); event.stopPropagation();" 
                            style="position:absolute; right:8px; top:8px; background:#ef4444; border:none; color:white; cursor:pointer; width:24px; height:24px; border-radius:6px; display:flex; align-items:center; justify-content:center; transition:0.2s; z-index:10" 
                            onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>

                    <div style="display:flex; gap:8px; margin-bottom:10px; align-items:center; padding-right:25px">
                        <div style="position:relative">
                            <input type="text" id="calcIcon_${idx}" value="${conf.icon}" 
                                oninput="updateCalcInConfig(${idx}, 'icon', this.value)" 
                                onclick="event.stopPropagation()"
                                style="width:45px; text-align:center; font-size:14px" placeholder="Icon">
                            <button class="toggle-btn" onclick="openDbFilePicker('calcIcon_${idx}'); event.stopPropagation();" 
                                style="position:absolute; right:-5px; top:-5px; padding:2px; font-size:10px; background:var(--accent); color:white; border-radius:50%; width:20px; height:20px; border:2px solid var(--bg)" title="–§–∞–π–ª">üìÇ</button>
                        </div>
                        
                        <input type="text" value="${conf.title}" 
                            oninput="updateCalcInConfig(${idx}, 'title', this.value)" 
                            onclick="event.stopPropagation()"
                            onfocus="this.select()"
                            style="flex:1; font-weight:bold; min-width:0" placeholder="–ù–∞–∑–≤–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞">
                        
                        <select onchange="updateCalcInConfig(${idx}, 'colSpan', parseInt(this.value))" 
                                onclick="event.stopPropagation()"
                                style="width:50px; background:rgba(255,255,255,0.1); border:1px solid var(--border); color:white; border-radius:6px; font-size:11px; padding:4px; cursor:pointer; flex-shrink:0">
                            <option value="1" ${colSpan === 1 ? 'selected' : ''}>1x</option>
                            <option value="2" ${colSpan === 2 ? 'selected' : ''}>2x</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:8px">
                        <label class="custom-checkbox">
                            <input type="checkbox" ${isPlaceholder ? 'checked' : ''} 
                                onchange="updateCalcInConfig(${idx}, 'isPlaceholder', this.checked); renderCalculatorsEditorUI();"
                                onclick="event.stopPropagation()">
                            <span>üîí –ó–∞–≥–ª—É—à–∫–∞ (–°–∫–æ—Ä–æ)</span>
                        </label>
                    </div>
                    <textarea oninput="updateCalcInConfig(${idx}, 'desc', this.value)"
                        onclick="event.stopPropagation()"
                        style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--text-dim); border-radius:6px; font-size:11px; resize:vertical; padding:8px; min-height:40px" placeholder="–û–ø–∏—Å –¥–ª—è –∫–∞—Ä—Ç–∫–∏...">${conf.desc || ''}</textarea>
                `;
                list.appendChild(item);

                item.addEventListener('dragstart', () => item.classList.add('dragging-calc'));
                item.addEventListener('dragend', () => item.classList.remove('dragging-calc'));
                item.onclick = () => selectCalculatorCard(idx);
            });

            // Reorder logic
            list.addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging-calc');
                if (!dragging) return;
                const afterElement = getDragAfterSidebarElement(list, e.clientY);
                if (afterElement == null) {
                    list.appendChild(dragging);
                } else {
                    list.insertBefore(dragging, afterElement);
                }
            });

            list.addEventListener('drop', () => {
                const dragItems = [...list.querySelectorAll('.calc-edit-item')];
                const newOrderIndices = dragItems.map(el => parseInt(el.dataset.idx));
                const newConfig = newOrderIndices.map(i => window.CalculatorConfig[i]);
                window.CalculatorConfig = newConfig;
                updateDashboardPreview();
            });
        }

        function getDragAfterSidebarElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.calc-edit-item:not(.dragging-calc)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateCalcInConfig(idx, prop, val, previewUrl = null) {
            window.CalculatorConfig[idx][prop] = val;
            if (previewUrl) {
                // Temporary store preview URL for live rendering
                window.CalculatorConfig[idx]._previewIcon = previewUrl;
            } else {
                delete window.CalculatorConfig[idx]._previewIcon;
            }
            renderDashboardCardsPreview();
            // NOTE: Do NOT call renderCalculatorsEditorUI() here - it destroys the input field you're typing in!
            // Exception: if we toggle placeholder, we might want to refresh the card status visually in the list too if there's other logic, 
            // but for now isPlaceholder is just a flag.
        }

        function removeCalcFromConfig(idx) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑—ñ —Å–ø–∏—Å–∫—É?')) return;
            window.CalculatorConfig.splice(idx, 1);
            updateDashboardPreview();
            renderCalculatorsEditorUI(); // Re-render list after deletion
        }

        async function addNewCalculatorToConfig() {
            const userTitle = prompt('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞:', '–ù–æ–≤–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä');
            if (!userTitle) return;

            // Transliterate for filename
            function translit(str) {
                const map = {
                    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—î': 'ye', '–∂': 'zh', '–∑': 'z', '–∏': 'y', '—ñ': 'i', '—ó': 'yi', '–π': 'y',
                    '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'kh', '—Ü': 'ts',
                    '—á': 'ch', '—à': 'sh', '—â': 'shch', '—å': '', '—é': 'yu', '—è': 'ya'
                };
                return str.toLowerCase().split('').map(c => map[c] || (/[a-z0-9]/.test(c) ? c : '_')).join('').replace(/_+/g, '_');
            }

            const slug = translit(userTitle);
            const id = 'schema_' + slug + '_' + Math.floor(Math.random() * 1000);
            const filename = 'data/' + id + '.js';

            const newCalc = {
                id: id,
                title: userTitle,
                icon: 'üì¶',
                file: filename,
                desc: '–û–ø–∏—Å –Ω–æ–≤–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞'
            };

            // 1. Create default schema file content
            const defaultSchema = {
                "meta": {
                    "version": "2.2",
                    "title": userTitle,
                    "lastUpdated": new Date().toISOString().split('T')[0]
                },
                "categories": {
                    "cat_construction": { "name": "–ö–æ–Ω—Å—Ç—Ä—É—é–≤–∞–Ω–Ω—è", "color": "#e0f2fe" },
                    "cat_design": { "name": "–ü—Ä–æ—î–∫—Ç—É–≤–∞–Ω–Ω—è", "color": "#f3e8ff" },
                    "cat_assembly": { "name": "–ó–±—ñ—Ä–∫–∞", "color": "#fef9c3" },
                    "cat_installation": { "name": "–ú–æ–Ω—Ç–∞–∂", "color": "#dcfce7" }
                },
                "processes": [
                    { "id": "pr_c1", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ –¢–ó", "category": "cat_construction" },
                    { "id": "pr_c2", "name": "–º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_construction" },
                    { "id": "pr_c3", "name": "–ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_construction" },
                    { "id": "pr_c4", "name": "–≤–∏—Å—Ç–∞–≤–∏—Ç–∏ –≤ –º–æ–¥–µ–ª—å", "category": "cat_construction" },
                    { "id": "pr_c5", "name": "—Ä–æ–∑—Å—Ç–∞–≤–∏—Ç–∏ —Ñ-—Ä—É", "category": "cat_construction" },
                    { "id": "pr_c6", "name": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ä–æ–±—É", "category": "cat_construction" },
                    { "id": "pr_c7", "name": "–∫—Ä–µ—Å–ª–µ–Ω–Ω—è –°–ë", "category": "cat_construction" },
                    { "id": "pr_c8", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –Ω–∞ —ñ–Ω–¥–∏–≤—ñ–¥. –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è", "category": "cat_construction" },
                    { "id": "pr_c9", "name": "–º–æ–Ω—Ç–∞–∂–Ω–∞ —Å—Ö–µ–º–∞", "category": "cat_construction" },
                    { "id": "pr_c10", "name": "–ø—Ä–æ–¥–∂–µ–∫—Ç –Ω–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª", "category": "cat_construction" },
                    { "id": "pr_c11", "name": "–ö—Ñ. –¥–æ—Ä–æ–≤–∞—Ä—Ç—ñ—Å–Ω–æ–≥–æ –º–∞—Ç.", "category": "cat_construction" },
                    { "id": "pr_c12", "name": "—Ñ-—Ä–∞ –ø—Ä–æ–¥–∂–µ–∫—Ç", "category": "cat_construction" },
                    { "id": "pr_c13", "name": "–û–î–ö", "category": "cat_construction" },
                    { "id": "pr_c14", "name": "–ó–∞–º—ñ–Ω–∞-–∫–æ—Ä–µ–≥—É–≤. –º–∞—Ç–µ—Ä—ñ–∞–ª—É", "category": "cat_construction" },
                    { "id": "pr_d1", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ –¢–ó", "category": "cat_design" },
                    { "id": "pr_d2", "name": "–í–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ—Ç—Ä–µ–±–∏, –ø–∏—Ç–∞–Ω–Ω—è, –ø–æ—à—É–∫ –∫—Ä—ñ—à–µ–Ω—å, –Ω–µ—Ä–æ–∑—É–º—ñ–Ω–Ω—è", "category": "cat_design" },
                    { "id": "pr_d3", "name": "–º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_design" },
                    { "id": "pr_d4", "name": "–ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_design" },
                    { "id": "pr_d5", "name": "–≤–∏—Å—Ç–∞–≤–∏—Ç–∏ –≤ –º–æ–¥–µ–ª—å", "category": "cat_design" },
                    { "id": "pr_d6", "name": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ä–æ–±—É -?", "category": "cat_design" },
                    { "id": "pr_d7", "name": "–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ–º, –ø–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è", "category": "cat_design" },
                    { "id": "pr_d8", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –≤—É–∑–ª–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_design" },
                    { "id": "pr_d9", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è", "category": "cat_design" },
                    { "id": "pr_d10", "name": "–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è", "category": "cat_design" },
                    { "id": "pr_d11", "name": "–ö–æ–ª—å–æ—Ä–æ–≤–∞ —Å—Ö–µ–º–∞", "category": "cat_design" },
                    { "id": "pr_a1", "name": "–ö–æ–º–ø–ª–µ–∫—Ç—É–≤–∞–Ω–Ω—è", "category": "cat_assembly" },
                    { "id": "pr_a2", "name": "–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è", "category": "cat_assembly" },
                    { "id": "pr_a3", "name": "–î–æ–¥–∞—Ç–∫–æ–≤–∞ –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ –ø–æ—Å–ª—É–≥–∞", "category": "cat_assembly" },
                    { "id": "pr_a4", "name": "–ó–±—ñ—Ä–∫–∞", "category": "cat_assembly" },
                    { "id": "pr_a5", "name": "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –º–æ–Ω—Ç–∞–∂", "category": "cat_assembly" },
                    { "id": "pr_a6", "name": "–î–µ–º–æ–Ω—Ç–∞–∂", "category": "cat_assembly" },
                    { "id": "pr_a7", "name": "–î–µ–º–æ–Ω—Ç–∞–∂ –ø–æ–¥–µ—Ç–∞–ª—å–Ω–∏–π", "category": "cat_assembly" },
                    { "id": "pr_a8", "name": "–ü–∞–∫—É–≤–∞–Ω–Ω—è –ø–æ–º–æ–¥—É–ª—å–Ω–µ", "category": "cat_assembly" },
                    { "id": "pr_a9", "name": "–ü–∞–∫—É–≤–∞–Ω–Ω—è –ø–æ–¥–µ—Ç–∞–ª—å–Ω–µ", "category": "cat_assembly" },
                    { "id": "pr_i1", "name": "–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_installation" },
                    { "id": "pr_i2", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è —ñ–∑ –∫—Ä–µ—Å–ª–µ–Ω—è–º", "category": "cat_installation" },
                    { "id": "pr_i3", "name": "—Ä–æ–∑–ø–∞–∫–æ–≤–∫–∞", "category": "cat_installation" },
                    { "id": "pr_i4", "name": "–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥—É–ª—ñ–≤", "category": "cat_installation" },
                    { "id": "pr_i5", "name": "—Ä–æ–∑–º—ñ—Ç–∫–∞ —Ç–∞ —Å–≤–µ—Ä–ª—ñ–Ω–Ω—è –ø–æ–¥ –º–æ–Ω—Ç–∞–∂–Ω—É –ø–ª–∞–Ω–∫—É", "category": "cat_installation" },
                    { "id": "pr_i6", "name": "–ú–æ–Ω—Ç–∞–∂", "category": "cat_installation" },
                    { "id": "pr_i7", "name": "–ü–Ü–î–†–Ü–ó–ö–ê –ü–†–û–§–Ü–õ–Æ –¢–ê –§–ê–õ–¨–®–Ü–í –Ü –ö–ê–†–ù–Ü–ó–Ü–í", "category": "cat_installation" },
                    { "id": "pr_i8", "name": "–º–æ–Ω—Ç–∞–∂ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏", "category": "cat_installation" },
                    { "id": "pr_i9", "name": "–í–∏—Ä—ñ–∑ –æ—Ç–≤–æ—Ä—ñ–≤ –ø—ñ–¥ —Ä–æ–∑–µ—Ç–∫–∏", "category": "cat_installation" },
                    { "id": "pr_i10", "name": "–ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è —Ç–∞ –≤–∏–Ω–æ—Å —Å–º—ñ—Ç—Ç—è", "category": "cat_installation" },
                    { "id": "pr_i11", "name": "–≤–∏—Ä—ñ–∑–∏ / –∑–∞—Ä—ñ–∑–∏", "category": "cat_installation" }
                ],
                "groups": [
                    { "id": "g_main", "title": "–û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏" }
                ],
                "fields": [],
                "products": { "groups": [], "fields": [] },
                "rules": {}
            };
            const fileContent = `const Schema = ${JSON.stringify(defaultSchema, null, 4)};\nwindow.Schema = Schema;`;

            // 2. Try to save the new file immediately through Local Saver
            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, content: fileContent })
                });
                if (response.ok) {
                    console.log("‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π —Ñ–∞–π–ª —Å—Ö–µ–º–∏:", filename);
                }
            } catch (e) {
                console.warn("–õ–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, —Ñ–∞–π–ª –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.");
            }

            // 3. Add to config and update UI
            window.CalculatorConfig.push(newCalc);
            updateDashboardPreview();
            renderCalculatorsEditorUI(); // Show new calculator in list immediately

            // 4. Save config to disk immediately too
            await saveCalculatorsConfig();
        }

        async function saveCalculatorsConfig() {
            const configToSave = window.CalculatorConfig.map(conf => {
                const clean = { ...conf };
                delete clean._previewIcon;
                return clean;
            });
            const content = `window.CalculatorConfig = ${JSON.stringify(configToSave, null, 4)}; `;
            const filename = 'data/config_calculators.js';

            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, content: content })
                });
                if (response.ok) {
                    alert('‚úÖ –°–ø–∏—Å–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!\nüåê –ó–º—ñ–Ω–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ GitHub!\nüîÑ –°—Ç–æ—Ä—ñ–Ω–∫–∞ –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏...');
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    return;
                }
            } catch (e) { }

            try {
                const handle = await window.showSaveFilePicker({ suggestedName: 'config_calculators.js', types: [{ accept: { 'text/javascript': ['.js'] } }] });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                alert('‚úÖ –°–ø–∏—Å–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
            } catch (e) { if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message); }
        }

        async function saveDashboardConfig() {
            const newConfig = {
                siteTitle: document.getElementById('dbTitle').value,
                siteSubtitle: document.getElementById('dbSubtitle').value,
                themeColor: document.getElementById('dbColor').value,
                logoText: document.getElementById('dbLogoText').value,
                logoImage: document.getElementById('dbLogoImg').value,
                backgroundImage: document.getElementById('dbBgImage').value,
                bgType: document.getElementById('dbBgType').value,
                glassBlur: parseInt(document.getElementById('dbBlur').value),
                glassOpacity: parseFloat(document.getElementById('dbOpacity').value),
                cardMinWidth: parseInt(document.getElementById('dbCardWidth').value),
                cardPadding: parseInt(document.getElementById('dbCardPadding').value),
                cardIconSize: parseInt(document.getElementById('dbCardIconSize').value),
                cardTitleSize: parseInt(document.getElementById('dbCardTitleSize').value),
                cardTitleColor: document.getElementById('dbCardTitleColor').value,
                cardDescSize: parseInt(document.getElementById('dbCardDescSize').value),
                cardDescColor: document.getElementById('dbCardDescColor').value,
                // Premium fields
                siteTitleSize: parseInt(document.getElementById('dbTitleSize').value),
                headerIllustration: document.getElementById('dbHeaderIllustration').value,
                cardTitleWeight: document.getElementById('dbCardTitleWeight').value,
                placeholderBg: document.getElementById('dbPlaceholderBg').value,
                placeholderBadgeText: document.getElementById('dbPlaceholderBadge').value,
                // v5.0
                logoX: parseInt(document.getElementById('dbLogoX').value),
                logoY: parseInt(document.getElementById('dbLogoY').value),
                logoScale: parseFloat(document.getElementById('dbLogoScale').value),
                illus1X: parseInt(document.getElementById('dbIllus1X').value),
                illus1Y: parseInt(document.getElementById('dbIllus1Y').value),
                illus1Scale: parseFloat(document.getElementById('dbIllus1Scale').value),
                headerIllustration2: document.getElementById('dbHeaderIllustration2').value,
                illus2X: parseInt(document.getElementById('dbIllus2X').value),
                illus2Y: parseInt(document.getElementById('dbIllus2Y').value),
                illus2Scale: parseFloat(document.getElementById('dbIllus2Scale').value),
                headerBgColor: document.getElementById('dbHeaderBg').value,
                headerOpacity: parseFloat(document.getElementById('dbHeaderOpacity').value),
                headerBlur: parseInt(document.getElementById('dbHeaderBlur').value)
            };
            window.DashboardConfig = newConfig;
            const content = `window.DashboardConfig = ${JSON.stringify(newConfig, null, 4)};`;
            const filename = 'data/config_dashboard.js';

            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, content: content })
                });
                if (response.ok) {
                    window.DashboardConfig = newConfig;
                    alert('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥–æ–ª–æ–≤–Ω–æ—ó –∑–±–µ—Ä–µ–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!');
                    return;
                }
            } catch (e) { }

            try {
                const handle = await window.showSaveFilePicker({ suggestedName: 'config_dashboard.js', types: [{ accept: { 'text/javascript': ['.js'] } }] });
                const writable = await handle.createWritable();
                await writable.write(content);
                await writable.close();
                window.DashboardConfig = newConfig;
                alert('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
            } catch (e) { if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message); }
        }

        async function handleGlobalSave() {
            if (window.currentMode === 'dashboard') {
                // Save both without showing individual alerts if possible, or handle here
                const oldAlert = window.alert;
                window.alert = () => { }; // Suppress individual alerts
                try {
                    await saveDashboardConfig();
                    await saveCalculatorsConfig();
                } finally {
                    window.alert = oldAlert; // Restore alert
                }
                alert('‚úÖ –í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ —Å–ø–∏—Å–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
            } else {
                await saveLayout();
            }
        }

        let currentDbTargetId = '';
        function openDbFilePicker(targetId) {
            currentDbTargetId = targetId;
            document.getElementById('dbFilePicker').click();
        }

        function handleDbFileSelection(input) {
            if (input.files && input.files[0] && currentDbTargetId) {
                const file = input.files[0];
                const fileName = file.name;
                const fullPath = 'images/' + fileName;
                const previewUrl = URL.createObjectURL(file);

                // Auto-upload the image file to the local server
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Content = e.target.result;
                    try {
                        const resp = await fetch('http://localhost:5005', {
                            method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: fullPath, content: base64Content })
                        });
                        if (resp.ok) console.log("‚úÖ Image uploaded to server:", fullPath);
                    } catch (err) {
                        console.warn("Could not auto-save image to server disk. Preview still works though.");
                    }
                };
                reader.readAsDataURL(file);

                const el = document.getElementById(currentDbTargetId);
                if (el) {
                    el.value = fullPath;
                    if (currentDbTargetId.startsWith('calcIcon_')) {
                        const idx = parseInt(currentDbTargetId.split('_')[1]);
                        updateCalcInConfig(idx, 'icon', fullPath, previewUrl);
                    } else if (currentDbTargetId === 'dbLogoImg') {
                        window._dbLogoPreview = previewUrl;
                        updateDashboardPreview();
                    } else if (currentDbTargetId === 'dbBgImage') {
                        window._dbBgPreview = previewUrl;
                        updateDashboardPreview();
                    }
                }
                updateDashboardPreview();
            }
        }

        async function pickDashboardImage(targetId) {
            // Keep for compatibility but redirect to new logic if called
            openDbFilePicker(targetId);
        }

        function toggleSidebar(show) {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            if (show) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }
    </script>
</body>

</html>