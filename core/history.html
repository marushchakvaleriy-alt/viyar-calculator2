<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ü—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ | Vpoint</title>

    <!-- Firebase Logic -->
    <script src="../data/config_firebase.js?v=2"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="auth.js?v=4"></script>

    <style>
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            margin: 0;
            padding: 20px;
            color: #1f2937;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 28px;
            font-weight: 800;
            color: #111827;
        }

        .btn-home {
            text-decoration: none;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            color: #4b5563;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-home:hover {
            background: #f3f4f6;
        }

        /* TABLE LAYOUT */
        .history-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            /* Ensures column widths are respected */
        }

        .history-table th,
        .history-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .history-table th {
            background: #f9fafb;
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            height: 48px;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-row:hover {
            background: #fdfdfd;
        }

        .history-row.selected {
            background: #eff6ff;
        }

        /* Column specific styling inside cells */
        .col-check {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .col-project {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Alignment Classes */
        .text-left {
            text-align: left;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }


        .badge-ver {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }

        .points-pill {
            background: #ecfdf5;
            color: #059669;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            display: inline-block;
        }

        .meta-tag {
            font-size: 11px;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 5px;
            display: inline-block;
        }

        /* Checkbox Style */
        .custom-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        /* Actions */
        .action-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            opacity: 0.6;
            transition: 0.2s;
            font-size: 16px;
        }

        .action-icon:hover {
            opacity: 1;
            background: #f3f4f6;
        }

        .ico-view {
            color: #2563eb;
        }

        .ico-del {
            color: #ef4444;
        }

        /* Bulk Action Bar */
        #bulkBar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #111827;
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }

        #bulkBar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .bulk-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
        }

        .bulk-cancel {
            background: transparent;
            color: #9ca3af;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6b7280;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <div class="title">–Ü—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤</div>
                <div style="color:#6b7280; font-size:14px; margin-top:5px">–ü–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∞—à–∏–º–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–º–∏
                    —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞–º–∏</div>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <!-- Auth UI -->
                <div id="authUserArea"
                    style="display:none; align-items:center; gap:10px; background:white; padding:4px 12px 4px 4px; border-radius:30px; border:1px solid #e5e7eb;">
                    <img id="authUserAvatar" src="" style="width:28px; height:28px; border-radius:50%;">
                    <div id="authUserName" style="font-size:12px; font-weight:700;"></div>
                </div>

                <a href="../index.html" class="btn-home">üè† –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
                <button id="authLoginBtn" onclick="window.Auth.login()"
                    style="display:none; padding:8px 16px; border-radius:20px; border:none; background:#2563eb; color:white; cursor:pointer; font-weight:600">
                    –£–≤—ñ–π—Ç–∏</button>
            </div>
        </div>

        <!-- SEARCH / TOOLBAR -->
        <div style="margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center">
            <input type="text" placeholder="üîç –ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é –ø—Ä–æ–µ–∫—Ç—É –∞–±–æ –ø—Ä–∏–º—ñ—Ç–∫–∞–º–∏..."
                oninput="filterHistory(this.value)"
                style="width:100%; max-width:500px; padding:12px 20px; border:1px solid #e5e7eb; border-radius:10px; outline:none; font-size:14px; box-shadow:0 1px 2px rgba(0,0,0,0.05)">
        </div>

        <!-- TABLE -->
        <table class="history-table">
            <thead>
                <tr>
                    <th style="width: 40px" class="text-center">
                        <input type="checkbox" id="selectAllBox" class="custom-checkbox" onchange="toggleSelectAll()">
                    </th>
                    <th class="text-left">–ù–∞–∑–≤–∞ –ü—Ä–æ–µ–∫—Ç—É</th>
                    <th style="width: 25%" class="text-left">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</th>
                    <th style="width: 80px" class="text-center">–í–µ—Ä—Å—ñ—è</th>
                    <th style="width: 120px" class="text-center">–ü–æ—ñ–Ω—Ç–∏</th>
                    <th style="width: 130px" class="text-center">–û–Ω–æ–≤–ª–µ–Ω–æ</th>
                    <th style="width: 150px" class="text-center">–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody id="historyList">
                <tr>
                    <td colspan="7" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- BULK BAR -->
    <div id="bulkBar">
        <span id="bulkCount" style="font-weight:700; font-size:13px">0 –≤–∏–±—Ä–∞–Ω–æ</span>
        <button class="bulk-btn" onclick="deleteSelected()">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
        <button class="bulk-cancel" onclick="clearSelection()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>

    <script>
        let fullList = [];
        let currentList = [];
        let selectedIds = new Set();

        const checkAuth = setInterval(() => {
            if (window.Auth && window.Auth.auth) {
                clearInterval(checkAuth);
                window.Auth.auth.onAuthStateChanged(user => {
                    if (user) {
                        window.Auth.user = user;
                        loadHistory();
                    } else {
                        document.getElementById('historyList').innerHTML = '<tr><td colspan="7" class="loading">–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é.<br><br><button onclick="window.Auth.login()" style="padding:10px 20px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">–£–≤—ñ–π—Ç–∏</button></td></tr>';
                    }
                });
            }
        }, 100);

        async function loadHistory() {
            if (!window.Auth.user) return;
            selectedIds.clear();
            updateBulkBar();

            try {
                const list = await window.Auth.getHistory();
                fullList = list;
                currentList = list;
                renderList(currentList);
            } catch (e) {
                document.getElementById('historyList').innerHTML =
                    `<tr><td colspan="7" class="loading" style="color:#ef4444">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${e.message}<br><button onclick="location.reload()">–û–Ω–æ–≤–∏—Ç–∏</button></td></tr>`;
            }
        }

        function filterHistory(query) {
            if (!query) {
                currentList = fullList;
            } else {
                const q = query.toLowerCase();
                currentList = fullList.filter(item => {
                    const title = (item.title || '').toLowerCase();
                    const meta = item.metadata || {};
                    const mgr = (meta.manager || '').toLowerCase();
                    const prod = (meta.productName || '').toLowerCase();
                    const cmt = (meta.comment || '').toLowerCase();
                    return title.includes(q) || mgr.includes(q) || prod.includes(q) || cmt.includes(q);
                });
            }
            renderList(currentList);
        }

        function renderList(list) {
            const container = document.getElementById('historyList');

            if (!list || list.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="loading">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ ü§∑‚Äç‚ôÇÔ∏è</td></tr>';
                return;
            }

            container.innerHTML = '';

            list.forEach(item => {
                const date = new Date(item.savedAt).toLocaleString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const cost = (item.totalCost || 0).toLocaleString(undefined, { minimumFractionDigits: 2 });
                const isSelected = selectedIds.has(item.id);

                const meta = item.metadata || {};
                const calcName = meta.calcName || '–ú—ñ–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä';
                const calcVer = meta.calcVersion || 'v1';

                // Fallback for old records
                const manager = meta.manager ? `<span class="meta-tag">üë§ ${meta.manager}</span>` : '';
                const product = meta.productName ? `<span class="meta-tag">ü™ë ${meta.productName}</span>` : '';

                const el = document.createElement('tr');
                el.className = `history-row ${isSelected ? 'selected' : ''}`;
                el.onclick = (e) => {
                    if (e.target.closest('button') || e.target.closest('input')) return;
                    toggleSelection(item.id);
                };

                el.innerHTML = `
                    <td class="text-center">
                        <div class="col-check">
                            <input type="checkbox" class="custom-checkbox" 
                                ${isSelected ? 'checked' : ''} 
                                onclick="event.stopPropagation(); toggleSelection('${item.id}')">
                        </div>
                    </td>
                    <td>
                        <div class="col-project">
                            <div style="font-weight:600; font-size:14px; color:#111827">${item.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                            <div style="display:flex; flex-wrap:wrap; gap:4px">
                                ${manager} ${product}
                            </div>
                            ${meta.comment ? `<div style="font-size:11px; color:#6b7280; font-style:italic; max-width:90%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${meta.comment}">${meta.comment}</div>` : ''}
                        </div>
                    </td>
                    <td class="text-left" style="font-weight:500; font-size:13px; color:#374151">${calcName}</td>
                    <td class="text-center"><span class="badge-ver">${calcVer}</span></td>
                    <td class="text-center"><span class="points-pill">${cost} ViPoint</span></td>
                    <td class="text-center" style="font-size:12px; color:#6b7280">${date}</td>
                    <td class="text-center">
                        <div class="flex-center" style="gap:8px">
                             <button class="action-icon ico-view" onclick="loadCalculation('${item.id}')" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                             <button class="action-icon ico-del" onclick="deleteSingle('${item.id}', event)" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                container.appendChild(el);
            });

            const allBox = document.getElementById('selectAllBox');
            if (allBox) allBox.checked = list.length > 0 && selectedIds.size === list.length;
        }

        function toggleSelection(id) {
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            renderList(currentList);
            updateBulkBar();
        }

        function toggleSelectAll() {
            const allBox = document.getElementById('selectAllBox');
            if (allBox.checked) {
                currentList.forEach(item => selectedIds.add(item.id));
            } else {
                selectedIds.clear();
            }
            renderList(currentList);
            updateBulkBar();
        }

        function clearSelection() {
            selectedIds.clear();
            renderList(currentList);
            updateBulkBar();
        }

        function updateBulkBar() {
            const bar = document.getElementById('bulkBar');
            const count = document.getElementById('bulkCount');
            if (selectedIds.size > 0) {
                bar.classList.add('visible');
                count.innerText = `${selectedIds.size} –≤–∏–±—Ä–∞–Ω–æ`;
            } else {
                bar.classList.remove('visible');
            }
        }

        async function deleteSingle(id, e) {
            e.stopPropagation();
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫?')) return;
            try {
                await window.Auth.deleteCalculation(id);
                loadHistory();
            } catch (e) { alert(e.message); }
        }

        async function deleteSelected() {
            if (selectedIds.size === 0) return;
            if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ (${selectedIds.size} —à—Ç)?`)) return;
            try {
                const ids = Array.from(selectedIds);
                await window.Auth.deleteCalculations(ids);
                loadHistory();
            } catch (e) { alert(e.message); }
        }

        function loadCalculation(id) {
            window.location.href = `calculator.html?id=${id}`;
        }
    </script>
</body>

</html>