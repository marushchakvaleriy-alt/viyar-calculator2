<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viyar Calculator V2.1 - –£–Ω—ñ–∫–∞–ª—å–Ω—ñ –ú–æ–¥–∞–ª–∫–∏</title>
    <!-- Dynamic Schema Loader -->
    <script>
        window.isEngineInitialized = false;

        function checkDependencies() {
            if (window.isEngineInitialized) return;

            if (window.Engine && window.Schema) {
                console.log('üöÄ Dependencies ready. Initializing Engine via Polling...');
                // Correct arguments: formContainer, productsList, totalScore
                Engine.init('formContainer', 'productsList', 'totalScore');
                window.isEngineInitialized = true;

                if (window.initInterval) clearInterval(window.initInterval);
            }
        }

        // Start polling immediately
        window.initInterval = setInterval(checkDependencies, 50);

        window.addEventListener('DOMContentLoaded', async function () {
            const params = new URLSearchParams(window.location.search);
            const calcId = params.get('id');
            // Default to a safe existing file if param is missing
            let configFile = params.get('config') || '../data/schema_novyy_kal_kulyator_733.js';
            window.currentConfigFile = configFile; // GLOBAL for Save

            if (calcId) {
                console.log("‚òÅÔ∏è Cloud Load Mode: Waiting for Auth...");
                // Show loading overlay
                const overlay = document.createElement('div');
                overlay.id = 'cloudLoader';
                overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;';
                overlay.innerHTML = '<div style="font-size:40px; margin-bottom:20px; animation:bounce 1s infinite">‚òÅÔ∏è</div><div style="font-size:18px; color:#4b5563; font-weight:600">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É...</div>';
                document.body.appendChild(overlay);

                // Wait for Auth to be ready (it's loaded async)
                let attempts = 0;
                while (!window.Auth && attempts < 50) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }

                if (window.Auth) {
                    // Check if User is logged in
                    if (!window.Auth.user) {
                        const doLogin = confirm("üîí –¶–µ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ —Ö–º–∞—Ä—ñ.\n–î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –Ω—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —É–≤—ñ–π—Ç–∏ –≤ —Å–≤—ñ–π Google –∞–∫–∞—É–Ω—Ç.\n\n–£–≤—ñ–π—Ç–∏ –∑–∞—Ä–∞–∑?");
                        if (doLogin) {
                            window.Auth.login();
                            // Wait for user to actually login (polling)
                            let loginAttempts = 0;
                            while (!window.Auth.user && loginAttempts < 600) { // Wait up to 60s
                                await new Promise(r => setTimeout(r, 100));
                                loginAttempts++;
                            }
                        }
                    }

                    if (window.Auth.user) {
                        try {
                            const doc = await window.Auth.getCalculation(calcId);
                            if (doc) {
                                console.log("‚úÖ Cloud data loaded:", doc);
                                if (doc.configPath) {
                                    configFile = doc.configPath;
                                }
                                window.cloudDataToImport = doc; // Save for Engine to use
                            } else {
                                alert("‚ùå –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ —É –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É.");
                            }
                        } catch (err) {
                            console.error("Cloud load error:", err);
                            alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: " + err.message);
                        }
                    } else {
                        console.warn("User declined login or login failed.");
                        // Proceed to load default empty calc? Or stay on overlay?
                        // Let's remove overlay so they can at least use empty calc
                    }
                } else {
                    alert("‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó.");
                }

                if (document.getElementById('cloudLoader')) document.getElementById('cloudLoader').remove();
            }

            const script = document.createElement('script');
            let cfgPath = configFile;
            // Handle relative path adjustment
            if (cfgPath.startsWith('data/')) {
                cfgPath = '../' + cfgPath;
            }

            // Log path for debugging
            console.log('Attempting to load schema from:', cfgPath);

            script.src = cfgPath + '?v=' + new Date().getTime();

            script.onload = function () {
                console.log('‚úÖ Schema script loaded');
                checkDependencies();

                // If we have cloud data, import it after Engine is ready
                if (window.cloudDataToImport) {
                    const checkEngine = setInterval(() => {
                        if (window.isEngineInitialized && window.Engine) {
                            clearInterval(checkEngine);
                            console.log("üîÑ Importing state into Engine...");
                            Engine.importState(window.cloudDataToImport);
                        }
                    }, 100);
                }
            };

            script.onerror = function () {
                console.error('‚ùå Failed to load schema:', cfgPath);
                document.body.innerHTML = '<div style="text-align:center; padding:50px;">' +
                    '<h1 style="color:#ef4444">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h1>' +
                    '<p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: <b>' + configFile + '</b></p>' +
                    '<p>–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —ñ—Å–Ω—É—î —Ü–µ–π —Ñ–∞–π–ª —É –ø–∞–ø—Ü—ñ data.</p>' +
                    '</div>';
                if (window.initInterval) clearInterval(window.initInterval);
            };

            document.head.appendChild(script);
        });
    </script>
    <script>
        document.write('<script src="engine.js?v=' + Date.now() + '"><\/script>');
    </script>

    <!-- Firebase Logic -->
    <script src="../data/config_firebase.js?v=2"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="auth.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background: #f3f4f6;
            color: #1f2937;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 80vh;
        }

        h1 {
            color: #111827;
            margin-top: 0;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        .layout {
            display: flex;
            gap: 30px;
        }

        .form-panel {
            flex: 2;
            padding-right: 30px;
            border-right: 1px solid #e5e7eb;
        }

        .results-panel {
            flex: 1;
            min-width: 300px;
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-box {
            background: white;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 24px;
            max-height: calc(80vh - 140px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .pg-field {
            margin-bottom: 16px;
        }

        .pg-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }

        .pg-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: 0.2s;
            box-sizing: border-box;
        }

        .pg-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pg-check-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .pg-check-label {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #374151;
        }

        .pg-check-qty {
            width: 80px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 6px;
            transition: 0.2s;
        }

        .checkbox-item:hover {
            background: #f1f5f9;
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            font-size: 14px;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* === PRODUCT ITEMS === */
        .product-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .product-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .product-details {
            font-size: 12px;
            color: #6b7280;
        }

        .product-score {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-left: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .results-header {
            background: #f9fafb;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .total-score {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }

        /* --- RESPONSIVE UPDATES --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .layout {
                flex-direction: column;
                gap: 20px;
            }

            .form-panel {
                padding-right: 0;
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
                padding-bottom: 20px;
            }

            .results-panel {
                min-width: 100%;
            }

            .product-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .product-score {
                margin-left: 0;
                font-size: 18px;
            }

            .modal-box {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }

            .modal-body {
                max-height: calc(100vh - 120px);
            }
        }
    </style>
</head>

<body>
    <div style="position:fixed; top:20px; left:20px; z-index:100; display:flex; gap:10px">
        <a href="../index.html"
            style="text-decoration:none; background:white; padding:8px 12px; border-radius:30px; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-weight:600; color:#4b5563; display:flex; align-items:center; gap:5px; font-size:13px; border:1px solid #e5e7eb; transition:0.2s">
            <span style="font-size:16px">üè†</span> –ù–∞ –≥–æ–ª–æ–≤–Ω—É
        </a>
        <button onclick="showAiModal()"
            style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); color:white; border:none; padding:8px 15px; border-radius:30px; box-shadow:0 2px 5px rgba(0,0,0,0.2); font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px; font-size:13px; transition:transform 0.2s">
            ‚ú® AI Magic
        </button>
    </div>

    <!-- Auth Controls (Fixed Top Right) -->
    <div class="auth-controls"
        style="position:fixed; top:20px; right:20px; z-index:100; display:flex; align-items:center; gap:10px;">
        <button id="authLoginBtn" onclick="window.Auth.login()"
            style="background:#fff; color:#333; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:13px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border:1px solid #e5e7eb;">
            <span>G</span> –£–≤—ñ–π—Ç–∏
        </button>

        <div id="authUserArea"
            style="display:none; align-items:center; gap:10px; background:white; padding:4px 12px 4px 4px; border-radius:30px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border:1px solid #e5e7eb;">
            <img id="authUserAvatar" src=""
                style="width:32px; height:32px; border-radius:50%; border:2px solid #f3f4f6;">
            <div style="text-align:right; line-height:1.2; margin-right:5px;">
                <div id="authUserName" style="font-size:12px; font-weight:700; color:#333;">User</div>
                <div style="font-size:10px; opacity:0.6; cursor:pointer; text-decoration:underline"
                    onclick="window.Auth.logout()">–í–∏–π—Ç–∏</div>
            </div>
        </div>
    </div>
    <div class="container">
        <div id="calcHeader"></div>
        <div class="layout">
            <div class="form-panel">
                <div id="categorySelection" style="margin-bottom: 25px;"></div>
                <div id="formContainer"></div>
            </div>

            <div class="results-panel">
                <h3 style="margin-top:0">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
                <!-- Breakdown by Process -->
                <div id="resultsContainer"
                    style="margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:15px">
                    <!-- Dynamic breakdown will be rendered here -->
                </div>

                <div class="results-header">
                    <div
                        style="font-size: 12px; color: #111827; font-weight:700; margin-bottom: 8px; text-transform:uppercase">
                        –í–°–¨–û–ì–û</div>
                    <div class="total-score" id="totalScore">0 ViPoint</div>
                </div>

                <div id="productsList"></div>
            </div>
        </div>
    </div>

    <!-- PRODUCT MODAL -->
    <div class="modal" id="prodModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 id="modalTitle">üì¶ –î–æ–¥–∞—Ç–∏ –≤–∏—Ä—ñ–±</h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalDynamicBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProductModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-primary" onclick="submitProduct()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- SAVE CALCULATION MODAL -->
    <div class="modal" id="saveModal" style="display:none; align-items:center; justify-content:center; z-index:1001;">
        <div class="modal-box"
            style="width:450px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); padding: 20px;">
                <h3 style="color:white; margin:0; font-size:18px;">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫</h3>
                <button class="modal-close" onclick="closeSaveModal()"
                    style="font-size:24px; opacity:0.8;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 25px;">
                <p style="margin: 0 0 20px 0; font-size:13px; color:#6b7280;">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤
                    —ñ—Å—Ç–æ—Ä—ñ—ó.</p>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#374151;">üè∑Ô∏è –ù–∞–∑–≤–∞
                        –ü—Ä–æ–µ–∫—Ç—É</label>
                    <input type="text" id="saveTitle" class="pg-input" placeholder="–ù–∞–ø—Ä: –ö—É—Ö–Ω—è –≤ –ñ–ö –°–æ—Ñ—ñ—è"
                        style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                </div>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#374151;">üë§ –ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                    <input type="text" id="saveManager" class="pg-input" placeholder="–Ü–º'—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"
                        style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                </div>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#374151;">ü™ë –í–∏—Ä—ñ–± /
                        –¢–∏–ø</label>
                    <input type="text" id="saveProduct" class="pg-input" placeholder="–ù–∞–ø—Ä: –®–∞—Ñ–∞-–∫—É–ø–µ"
                        style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px;">
                </div>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:5px; font-weight:600; color:#374151;">üí¨
                        –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</label>
                    <textarea id="saveComment" class="pg-input" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏..."
                        style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-family:sans-serif;"></textarea>
                </div>
            </div>
            <div class="modal-footer"
                style="padding: 15px 25px; background: #f9fafb; border-top: 1px solid #e5e7eb; display:flex; justify-content: flex-end; gap:10px;">
                <button class="btn btn-secondary" onclick="closeSaveModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-primary" onclick="Engine.finalizeSave()" style="background: #2563eb;">üíæ
                    –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- AI MAGIC MODAL -->
    <div id="aiModal" class="modal" style="display:none; align-items:center; justify-content:center; z-index:2000;">
        <div class="modal-box"
            style="width: 600px; max-width: 90%; background:white; border-radius:12px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); padding: 20px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:white; margin:0; font-size:18px;">‚ú® AI –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ (Gemini)</h3>
                <button onclick="document.getElementById('aiModal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:24px; cursor:pointer; opacity:0.8">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px; max-height:70vh; overflow-y:auto;">

                <div class="pg-field">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:13px; color:#374151;">üîë
                        Gemini API Key <a href="https://aistudio.google.com/app/apikey" target="_blank"
                            style="font-size:11px; color:#3b82f6">(–û—Ç—Ä–∏–º–∞—Ç–∏ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</a></label>
                    <div style="display:flex; gap:8px">
                        <input type="password" id="aiKey" class="pg-input"
                            value="AIzaSyBMvARr6WSKdS3SV_-oDAauxmLeA-7eWkM" placeholder="–í—Å—Ç–∞–≤—Ç–µ –≤–∞—à –∫–ª—é—á API —Ç—É—Ç"
                            style="flex:1;" oninput="localStorage.setItem('gemini_api_key', this.value)">
                        <button
                            onclick="const el=document.getElementById('aiKey'); el.type = el.type==='password'?'text':'password'; this.innerText = el.type==='password'?'üëÅÔ∏è':'üîí'"
                            style="background:#f3f4f6; border:1px solid #d1d5db; border-radius:8px; padding:0 10px; cursor:pointer;"
                            title="–ü–æ–∫–∞–∑–∞—Ç–∏/–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏">üëÅÔ∏è</button>
                        <button
                            onclick="document.getElementById('aiKey').value=''; localStorage.removeItem('gemini_api_key');"
                            style="background:#fee2e2; border:1px solid #fca5a5; border-radius:8px; padding:0 10px; cursor:pointer; color:#b91c1c"
                            title="–û—á–∏—Å—Ç–∏—Ç–∏">‚ùå</button>
                    </div>
                </div>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:13px; color:#374151;">üñºÔ∏è
                        –§–æ—Ç–æ –º–µ–±–ª—ñ–≤ / –ï—Å–∫—ñ–∑</label>
                    <div id="aiDropzone"
                        style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #f8fafc; position: relative"
                        onclick="document.getElementById('aiImgInput').click()">
                        <div id="aiDropText">
                            <div style="font-size: 32px; margin-bottom: 10px">üì∏</div>
                            <span style="color: #64748b; font-weight: 500">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ —Å—é–¥–∏ –∞–±–æ (Ctrl+V)</span>
                        </div>
                        <img id="aiPreview"
                            style="max-width: 100%; max-height: 200px; display: none; margin: 0 auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1)">
                        <button id="aiRemoveImg" onclick="event.stopPropagation(); clearAiImage()"
                            style="display:none; position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer">&times;</button>
                    </div>
                    <input type="file" id="aiImgInput" accept="image/*" style="display:none"
                        onchange="processAiFile(this.files[0])">
                </div>

                <div class="pg-field">
                    <label style="display:block; margin-bottom:6px; font-weight:600; font-size:13px; color:#374151;">üìù
                        –¢–µ—Ö–Ω—ñ—á–Ω–µ –ó–∞–≤–¥–∞–Ω–Ω—è (–¢–ó)</label>
                    <textarea id="aiPrompt" class="pg-input" rows="4"
                        placeholder="–û–ø–∏—à—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ: –º–∞—Ç–µ—Ä—ñ–∞–ª–∏, —Ñ—É—Ä–Ω—ñ—Ç—É—Ä–∞, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ (" –§–∞—Å–∞–¥–∏ –ú–î–§, 4 —è—â–∏–∫–∞")..."
                        style="width:100%; font-family:sans-serif;"></textarea>
                </div>

                <div id="aiLog"
                    style="display:none; background:#1f2937; color:#10b981; padding:12px; border-radius:8px; font-family:monospace; font-size:11px; margin-bottom:15px; white-space: pre-wrap; margin-top:15px;">
                </div>

            </div>
            <div class="modal-footer"
                style="padding: 16px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; display:flex; justify-content: flex-end; gap: 10px;">
                <button onclick="document.getElementById('aiModal').style.display='none'"
                    class="btn btn-secondary">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="runAiAnalysis()" id="aiRunBtn" class="btn btn-primary"
                    style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border: none;">ü§ñ
                    –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        let editingProductId = null;
        let currentButtonId = null;

        // Initialize Engine when loaded
        // window.addEventListener('DOMContentLoaded', () => {
        //     // Logic moved to script onload handler in head
        // });

        // Open modal function (called from Engine)
        window.openProductModal = function (buttonId, product = null) {
            console.log('openProductModal called:', buttonId, product);

            if (!buttonId) {
                console.error('buttonId is missing!');
                return;
            }

            currentButtonId = buttonId;
            editingProductId = product ? product.id : null;

            const modal = document.getElementById('prodModal');
            if (!modal) {
                console.error('Modal element not found!');
                return;
            }

            const button = Schema.fields.find(f => f.id === buttonId);
            const modalTitle = product ? '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : (button?.default || button?.label || 'üì¶ –î–æ–¥–∞—Ç–∏ –≤–∏—Ä—ñ–±');

            const titleEl = document.getElementById('modalTitle');
            if (titleEl) {
                titleEl.innerText = modalTitle;
            }

            renderModalContent(buttonId, product ? product.data : null);
            modal.style.display = 'flex';
        };

        function closeProductModal() {
            // Revert select_modal if it was just opened and no product exists
            if (currentButtonId) {
                const field = Schema.fields.find(f => f.id === currentButtonId);
                if (field && field.type === 'select_modal') {
                    const existing = Engine.addedProducts.find(p => p.buttonId === currentButtonId);
                    if (!existing) {
                        if (Engine.state[currentButtonId] === 'yes') {
                            Engine.state[currentButtonId] = 'placeholder';
                        }
                        Engine.renderForm(); // Re-render to be safe and clean
                    }
                }
            }
            document.getElementById('prodModal').style.display = 'none';
            editingProductId = null;
            currentButtonId = null;
        }

        function renderModalContent(buttonId, editData = null) {
            const container = document.getElementById('modalDynamicBody');
            if (!container) {
                console.error('Modal container not found!');
                return;
            }

            container.innerHTML = '';

            const button = Schema.fields.find(f => f.id === buttonId);
            if (!button) {
                console.error('Button not found:', buttonId);
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå –ü–æ–º–∏–ª–∫–∞: –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ö–µ–º—ñ</div>';
                return;
            }

            if (!button.modalFields || button.modalFields.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">–£ —Ü—ñ—î—ó –∫–Ω–æ–ø–∫–∏ —â–µ –Ω–µ–º–∞—î –ø–æ–ª—ñ–≤. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ —ó—Ö –≤ –∞–¥–º—ñ–Ω—Ü—ñ (‚öôÔ∏è).</div>';
                return;
            }

            console.log('Rendering modal for button:', button.label || button.default, 'Fields:', button.modalFields.length);

            // Extract Modal Typography Settings
            const layout = button.layout || {};
            const mSize = layout.modalFieldSize ? `font-size:${layout.modalFieldSize}px;` : '';
            const mWeight = layout.modalFieldWeight ? `font-weight:${layout.modalFieldWeight};` : '';
            const mColor = layout.modalFieldColor ? `color:${layout.modalFieldColor};` : '';
            const mStyle = layout.modalFieldStyle ? `font-style:${layout.modalFieldStyle};` : '';
            const mLineHeight = layout.modalFieldLineHeight ? `line-height:${layout.modalFieldLineHeight};` : '';

            const labelStyle = `display:block; margin-bottom:5px; ${mSize} ${mWeight} ${mColor} ${mStyle} ${mLineHeight}`;
            const checkLabelStyle = `flex:1; display:flex; align-items:center; gap:6px; cursor:pointer; margin:0; ${mSize} ${mWeight} ${mColor} ${mStyle} ${mLineHeight}`;

            button.modalFields.forEach(f => {
                const row = document.createElement('div');
                row.className = 'pg-field';

                const currentVal = editData ? editData[f.id] : null;

                if (f.type === 'select') {
                    let opts = (f.options || []).map(o => `<option value="${o.value}" ${currentVal === o.value ? 'selected' : ''}>${o.label}</option>`).join('');
                    row.innerHTML = `<label style="${labelStyle}">${f.label}</label><select class="pg-input" id="inp_${f.id}" data-fid="${f.id}" onchange="recalcModalTotal()">${opts}</select>`;
                }
                else if (f.type === 'multiselect') {
                    const selectedVals = Array.isArray(currentVal) ? currentVal : [];
                    let items = (f.options || []).map(o => {
                        const isSelected = selectedVals.some(v => v.value === o.value || v === o.value);
                        const qty = selectedVals.find(v => v.value === o.value)?.qty || 1;

                        return `
                        <div class="multiselect-item" style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb;">
                            <label style="${checkLabelStyle}">
                                <input type="checkbox" class="ms-check" data-fid="${f.id}" value="${o.value}" ${isSelected ? 'checked' : ''} onchange="recalcModalTotal()">
                                <span>${o.label}</span>
                            </label>
                            <input type="number" class="ms-qty" data-value="${o.value}" data-fid="${f.id}" value="${qty}" min="1" 
                                   oninput="recalcModalTotal()" 
                                   style="width:70px; padding:4px 8px; border:1px solid #d1d5db; border-radius:6px; text-align:center;">
                        </div>
                    `;
                    }).join('');

                    let labelHtml = f.label;
                    if (f.helpContent) {
                        labelHtml += ` <span style="cursor:help; color:#3b82f6; font-size:16px; margin-left:5px;" title="${f.helpContent.replace(/"/g, '&quot;')}">‚ìò</span>`;
                    }

                    row.innerHTML = `<label style="${labelStyle.replace('display:block', 'display:flex').replace('margin-bottom:5px', 'margin-bottom:10px; align-items:center')}">${labelHtml}</label>
                                     <div class="checkbox-list" style="background:white; border:none; padding:0; max-height:none; box-shadow:none;">${items}</div>`;
                }
                else if (f.type === 'multiselect_qty') {
                    const selectedVals = Array.isArray(currentVal) ? currentVal : [];
                    let items = (f.options || []).map(o => {
                        const isSelected = selectedVals.some(v => v.value === o.value || v === o.value);
                        const qty = selectedVals.find(v => v.value === o.value)?.qty || 1;

                        return `
                        <div class="multiselect-item" style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #e5e7eb;">
                            <label style="${checkLabelStyle}">
                                <input type="checkbox" class="ms-qty-check" data-fid="${f.id}" value="${o.value}" ${isSelected ? 'checked' : ''} onchange="recalcModalTotal()">
                                <span>${o.label}</span>
                            </label>
                            <input type="number" class="ms-qty-input" data-value="${o.value}" data-fid="${f.id}" value="${qty}" min="1" 
                                   oninput="recalcModalTotal()" 
                                   style="width:70px; padding:4px 8px; border:1px solid #d1d5db; border-radius:6px; text-align:center;">
                        </div>
                    `;
                    }).join('');

                    let labelHtml = f.label;
                    if (f.helpContent) {
                        labelHtml += ` <span style="cursor:help; color:#3b82f6; font-size:16px; margin-left:5px;" title="${f.helpContent.replace(/"/g, '&quot;')}">‚ìò</span>`;
                    }

                    row.innerHTML = `<label style="${labelStyle.replace('display:block', 'display:flex').replace('margin-bottom:5px', 'margin-bottom:10px; align-items:center')}">${labelHtml}</label>
                                     <div class="checkbox-list" style="background:white; border:none; padding:0; max-height:none; box-shadow:none;">${items}</div>`;
                }
                else if (f.type === 'number') {
                    const val = currentVal !== null ? currentVal : (f.default || 0);
                    row.innerHTML = `<label style="${labelStyle}">${f.label}</label><input type="number" class="pg-input" id="inp_${f.id}" name="field_n_${f.id}_${Date.now()}" data-fid="${f.id}" value="${val}" oninput="recalcModalTotal()" autocomplete="new-password">`;
                }
                else if (f.type === 'checkbox_qty') {
                    row.className = 'pg-check-row';
                    const isChecked = currentVal ? currentVal.checked : false;
                    const qVal = currentVal ? currentVal.qty : 1;
                    row.innerHTML = `
                        <label class="pg-check-label"><input type="checkbox" id="chk_${f.id}" data-fid="${f.id}" ${isChecked ? 'checked' : ''} onchange="recalcModalTotal()"> ${f.label}</label>
                        <input type="number" class="pg-check-qty" id="qty_${f.id}" name="field_q_${f.id}_${Date.now()}" value="${qVal}" oninput="recalcModalTotal()" autocomplete="new-password">
                    `;
                }
                else if (f.type === 'checkbox') {
                    row.className = 'pg-check-row';
                    const isChecked = currentVal || false;
                    row.innerHTML = `<label class="pg-check-label"><input type="checkbox" id="chk_${f.id}" data-fid="${f.id}" ${isChecked ? 'checked' : ''} onchange="recalcModalTotal()"> ${f.label}</label>`;
                }

                container.appendChild(row);
            });

            // Initial Calc
            setTimeout(recalcModalTotal, 50);
        }

        function recalcModalTotal() {
            if (!currentButtonId) return;
            const button = Schema.fields.find(f => f.id === currentButtonId);
            if (!button || !button.modalFields) return;

            let total = 0;

            button.modalFields.forEach(f => {
                let isActive = false;
                let multiplier = 1;

                if (f.type === 'checkbox_qty') {
                    const chk = document.getElementById(`chk_${f.id}`);
                    const qty = document.getElementById(`qty_${f.id}`);
                    if (chk && chk.checked) {
                        isActive = true;
                        multiplier = Math.max(0, parseInt(qty?.value || 1));
                    }
                }
                else if (f.type === 'checkbox') {
                    const chk = document.getElementById(`chk_${f.id}`);
                    if (chk && chk.checked) isActive = true;
                }
                else if (f.type === 'number') {
                    const inp = document.getElementById(`inp_${f.id}`);
                    if (inp) {
                        isActive = true;
                        multiplier = parseFloat(inp.value) || 0;
                    }
                }
                else if (f.type === 'multiselect') {
                    // Collect all checked values for this field
                    const checked = Array.from(container.querySelectorAll(`.ms-check[data-fid="${f.id}"]:checked`)).map(el => el.value);
                    const ruleKey = `${currentButtonId}_${f.id}`;

                    checked.forEach(optVal => {
                        Schema.processes.forEach(p => {
                            if (Schema.modalFieldRules?.[ruleKey]?.[optVal]?.[p.id]) {
                                total += Number(Schema.modalFieldRules[ruleKey][optVal][p.id]) || 0;
                            }
                        });
                    });
                    // multiselect points are added directly to total, so we don't set isActive
                }

                if (isActive) {
                    // Sum up points from all processes for this field
                    // Using Schema.modalFieldRules for action button sub-fields
                    const ruleKey = `${currentButtonId}_${f.id}`;

                    Schema.processes.forEach(p => {
                        let pts = 0;
                        if (Schema.modalFieldRules && Schema.modalFieldRules[ruleKey] && Schema.modalFieldRules[ruleKey][p.id]) {
                            pts = Number(Schema.modalFieldRules[ruleKey][p.id]) || 0;
                        }
                        // If it's a number field, the rule is usually 'per unit', so multiply by value
                        // BUT in this system, often the rule IS the points.
                        // Let's assume for Checkbox/CheckboxQty it's fixed points per unit.
                        // For Number field, usually the user enters a quantity.

                        if (f.type === 'number') {
                            total += pts * multiplier;
                        } else {
                            total += pts * multiplier;
                        }
                    });
                }
            });

            const scoreEl = document.getElementById('modalTotalScore');
            if (scoreEl) {
                scoreEl.innerText = `${total.toLocaleString()} ViPoint`;
            }
        }

        function submitProduct() {
            const data = {};
            const button = Schema.fields.find(f => f.id === currentButtonId);

            if (!button || !button.modalFields) return;

            button.modalFields.forEach(f => {
                if (f.type === 'checkbox_qty') {
                    const chk = document.getElementById(`chk_${f.id}`);
                    const qty = document.getElementById(`qty_${f.id}`);
                    data[f.id] = { checked: chk?.checked || false, qty: parseInt(qty?.value || 1) };
                }
                else if (f.type === 'checkbox') {
                    data[f.id] = document.getElementById(`chk_${f.id}`)?.checked || false;
                }
                else if (f.type === 'multiselect') {
                    const checked = Array.from(document.querySelectorAll(`.ms-check[data-fid="${f.id}"]:checked`)).map(el => el.value);
                    data[f.id] = checked;
                }
                else {
                    const inp = document.getElementById(`inp_${f.id}`);
                    if (inp) {
                        data[f.id] = inp.value || f.default || '';
                    } else {
                        data[f.id] = f.default || '';
                    }
                }
            });

            if (editingProductId) {
                Engine.updateProduct(editingProductId, data);
            } else {
                Engine.addProduct(currentButtonId, data);
            }

            closeProductModal();
        }
    </script>
    <script>
        // ============================================
        // AI MAGIC IMPLEMENTATION CS (Client Side)
        // ============================================
        let geminiImageBase64 = null;

        function showAiModal() {
            document.getElementById('aiModal').style.display = 'flex';
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('aiKey').value = savedKey;

            // Setup Dropzone Drag & Drop
            const dz = document.getElementById('aiDropzone');
            if (!dz.dataset.init) {
                dz.dataset.init = "true";
                dz.ondragover = (e) => { e.preventDefault(); dz.style.background = '#e0e7ff'; dz.style.borderColor = '#818cf8'; };
                dz.ondragleave = (e) => { e.preventDefault(); dz.style.background = '#f8fafc'; dz.style.borderColor = '#cbd5e1'; };
                dz.ondrop = (e) => {
                    e.preventDefault();
                    dz.style.background = '#f8fafc'; dz.style.borderColor = '#cbd5e1';
                    if (e.dataTransfer.files[0]) processAiFile(e.dataTransfer.files[0]);
                };
            }
            // Global Paste Handler
            window.removeEventListener('paste', processPasteImage);
            window.addEventListener('paste', processPasteImage);
        }

        function processPasteImage(e) {
            if (document.getElementById('aiModal').style.display !== 'flex') return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    processAiFile(item.getAsFile());
                }
            }
        }

        function processAiFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                geminiImageBase64 = e.target.result.split(',')[1]; // Remove prefix
                document.getElementById('aiPreview').src = e.target.result;
                document.getElementById('aiPreview').style.display = 'block';
                document.getElementById('aiDropText').style.display = 'none';
                document.getElementById('aiRemoveImg').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearAiImage() {
            geminiImageBase64 = null;
            document.getElementById('aiPreview').src = '';
            document.getElementById('aiPreview').style.display = 'none';
            document.getElementById('aiDropText').style.display = 'block';
            document.getElementById('aiRemoveImg').style.display = 'none';
            document.getElementById('aiImgInput').value = '';
        }

        function getCompactSchema() {
            // Get fields from Global Schema
            if (!window.Schema || !window.Schema.fields) return [];
            return window.Schema.fields.map(f => {
                const simple = { id: f.id, label: f.label, type: f.type };
                if (f.options) simple.options = f.options.map(o => ({ v: o.value, l: o.label }));
                if (f.modalFields) simple.modalFields = f.modalFields.map(mf => {
                    const smf = { id: mf.id, label: mf.label, type: mf.type };
                    if (mf.options) smf.options = mf.options.map(o => ({ v: o.value, l: o.label }));
                    return smf;
                });
                return simple;
            });
        }

        async function runAiAnalysis() {
            const apiKey = document.getElementById('aiKey').value.trim();
            const promptText = document.getElementById('aiPrompt').value.trim();
            const log = document.getElementById('aiLog');
            const btn = document.getElementById('aiRunBtn');

            if (!apiKey) { alert('–í–≤–µ–¥—ñ—Ç—å Gemini API Key!'); return; }
            localStorage.setItem('gemini_api_key', apiKey);

            if (!geminiImageBase64 && !promptText) { alert('–î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ –∞–±–æ –æ–ø–∏—Å –¢–ó!'); return; }

            btn.innerHTML = '‚è≥ –î—É–º–∞—é...';
            btn.disabled = true;
            log.style.display = 'block';
            log.innerText = '> –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö...\n';

            try {
                // 1. AUTO-DETECT BEST MODEL
                log.innerText += '> –ü–æ—à—É–∫ –¥–æ—Å—Ç—É–ø–Ω–æ—ó AI –º–æ–¥–µ–ª—ñ...\n';
                let bestModel = 'models/gemini-1.5-flash';
                let apiVersion = 'v1beta';

                try {
                    const modelsResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (modelsResp.ok) {
                        const mData = await modelsResp.json();
                        if (mData.models) {
                            // Priority: Flash 1.5 -> Pro 1.5 -> Pro Vision -> Pro
                            const capableModels = mData.models.filter(m => m.supportedGenerationMethods.includes('generateContent'));

                            const flash15 = capableModels.find(m => m.name.includes('gemini-1.5-flash'));
                            const pro15 = capableModels.find(m => m.name.includes('gemini-1.5-pro'));
                            const proVision = capableModels.find(m => m.name.includes('gemini-pro-vision'));

                            if (flash15) bestModel = flash15.name;
                            else if (pro15) bestModel = pro15.name;
                            else if (proVision) bestModel = proVision.name;
                            else if (capableModels.length > 0) bestModel = capableModels[0].name;

                            log.innerText += `> –û–±—Ä–∞–Ω–æ –º–æ–¥–µ–ª—å: ${bestModel.replace('models/', '')}\n`;
                        }
                    } else {
                        log.innerText += '> –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π. –ü—Ä–æ–±—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É...\n';
                    }
                } catch (e) {
                    console.warn('Model list failed', e);
                }

                // 2. PREPARE REQUEST
                const compactSchema = getCompactSchema();
                const schemaStr = JSON.stringify(compactSchema);

                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: `–¢–∏ - –µ–∫—Å–ø–µ—Ä—Ç –∑ –æ—Ü—ñ–Ω–∫–∏ –º–µ–±–ª—ñ–≤. –¢–≤–æ—è —Ü—ñ–ª—å - –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ–æ—Ç–æ —Ç–∞ –¢–ó.
–û—Å—å —Å–∫–æ—Ä–æ—á–µ–Ω–∞ —Å—Ö–µ–º–∞ –ø–æ–ª—ñ–≤ (JSON): ${schemaStr}.
–¢–ó –∫–ª—ñ—î–Ω—Ç–∞: "${promptText}".

–í–ê–ñ–õ–ò–í–û –ü–†–û –ì–ï–û–ú–ï–¢–†–Ü–Æ –ö–£–•–ù–Ü:
1. –£–≤–∞–∂–Ω–æ –≤–∏–∑–Ω–∞—á–∏ —Ç–∏–ø –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è:
   - –ü—Ä—è–º–∞ (Linear): –ú–µ–±–ª—ñ –≤ –æ–¥–Ω—É –ª—ñ–Ω—ñ—é.
   - –ì-–ø–æ–¥—ñ–±–Ω–∞ (L-shape): –ú–µ–±–ª—ñ –≤–∑–¥–æ–≤–∂ –¥–≤–æ—Ö —Å—É–º—ñ–∂–Ω–∏—Ö —Å—Ç—ñ–Ω (1 –∫—É—Ç).
   - –ü-–ø–æ–¥—ñ–±–Ω–∞ (U-shape): –ú–µ–±–ª—ñ –≤–∑–¥–æ–≤–∂ —Ç—Ä—å–æ—Ö —Å—Ç—ñ–Ω (2 –∫—É—Ç–∏).
2. –Ø–∫—â–æ –Ω–∞ —Ñ–æ—Ç–æ –≤–∏–¥–Ω–æ —à–∞—Ñ–∏ –∑–ª—ñ–≤–∞, –ø–æ —Ü–µ–Ω—Ç—Ä—É (–ø—ñ–¥ –≤—ñ–∫–Ω–æ–º) —ñ —Å–ø—Ä–∞–≤–∞ -> —Ü–µ –ü-–ø–æ–¥—ñ–±–Ω–∞.
3. –ù–µ –ø–ª—É—Ç–∞–π –ü-–ø–æ–¥—ñ–±–Ω—É –∑ –ì-–ø–æ–¥—ñ–±–Ω–æ—é.

–ó–ê–í–î–ê–ù–ù–Ø: 
1. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ñ–æ—Ç–æ (—è–∫—â–æ —î) —Ç–∞ —Ç–µ–∫—Å—Ç.
2. –í–∏–∑–Ω–∞—á–∏, —è–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –º–∞—é—Ç—å –±—É—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ.
3. –ü–æ–≤–µ—Ä–Ω–∏ –¢–Ü–õ–¨–ö–ò —á–∏—Å—Ç–∏–π JSON –æ–±'—î–∫—Ç —É —Ñ–æ—Ä–º–∞—Ç—ñ:
{
  "fieldId": value, // –î–ª—è number
  "fieldId": "optionValue", // –î–ª—è select (—è–∫—â–æ string)
  "fieldId": ["val1", "val2"] // –î–ª—è multiselect
}
–Ø–∫—â–æ —Ü–µ select_modal / action_button:
- –ó–∞–ø–æ–≤–Ω–∏ —ó—Ö modalFields.
- –î–ª—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –ø–æ–ª—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∫–ª—é—á—ñ: "ButtonId_ModalFieldId".
–ü—Ä–∏–∫–ª–∞–¥:
{
  "width": 3000,
  "depth": 600,
  "material_body": "dsp_white",
  "drawers_btn_count": 4 
}
–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò JSON. –ë–µ–∑ markdown.` },
                            ...(geminiImageBase64 ? [{ inline_data: { mime_type: "image/jpeg", data: geminiImageBase64 } }] : [])
                        ]
                    }]
                };

                // 3. EXECUTE
                log.innerText += '> –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É...\n';
                const response = await fetch(`https://generativelanguage.googleapis.com/${apiVersion}/${bestModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    const errMsg = errData.error ? errData.error.message : response.statusText;
                    throw new Error(`API Error (${response.status}): ${errMsg}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content) throw new Error('No content from AI');

                let aiText = data.candidates[0].content.parts[0].text;
                log.innerText += '> –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –û–±—Ä–æ–±–∫–∞ JSON...\n';

                aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                let result;
                try {
                    result = JSON.parse(aiText);
                } catch (e) {
                    console.log('Raw AI:', aiText);
                    throw new Error('–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON –≤—ñ–¥ AI');
                }

                // APPLY
                let changesCount = 0;
                Object.keys(result).forEach(key => {
                    if (result[key] !== null && result[key] !== undefined) {
                        Engine.state[key] = result[key];
                        changesCount++;
                    }
                });

                log.innerText += `‚úÖ –£—Å–ø—ñ—à–Ω–æ! –û–Ω–æ–≤–ª–µ–Ω–æ ${changesCount} –ø–æ–ª—ñ–≤.`;
                Engine.renderForm();
                Engine.calculate();

                alert(`‚ú® AI –ó–∞–ø–æ–≤–Ω–∏–≤ ${changesCount} –ø–æ–ª—ñ–≤!`);
                setTimeout(() => { document.getElementById('aiModal').style.display = 'none'; }, 2000);

            } catch (err) {
                log.innerText += '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message;
                console.error(err);
                alert('–ü–æ–º–∏–ª–∫–∞ AI: ' + err.message);
            } finally {
                btn.innerHTML = 'ü§ñ –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏';
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>