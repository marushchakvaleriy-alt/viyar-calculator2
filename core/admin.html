<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Matrix V14 (Separated Totals)</title>
    <!-- Config Loaders -->
    <script src="../data/config_calculators.js"></script>
    <script src="../data/config_dashboard.js"></script>
    <!-- Dynamic Schema Loader -->
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            // Default to kitchen for backward compatibility if no config param
            const configFile = params.get('config') || '../data/schema_kitchen.js';
            window.currentConfigFile = configFile; // Global for save function

            const script = document.createElement('script');
            let cfgPath = configFile;
            // If the config file path is relative (starts with data/) and we are in core/, prepend ../
            if (cfgPath.startsWith('data/')) {
                cfgPath = '../' + cfgPath;
            }
            script.src = cfgPath + '?v=' + new Date().getTime();
            script.onload = function () {
                console.log('Schema loaded:', configFile);
                if (window.renderMatrix) window.renderMatrix(); // Auto-render if admin
                if (window.renderDesigner) window.renderDesigner(); // Auto-render if designer
            };
            script.onerror = function () {
                document.body.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; gap:20px; font-family:sans-serif; background:#f1f5f9;">
                        <div style="background:white; padding:40px; border-radius:24px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.1); text-align:center; max-width:400px">
                            <div style="font-size:48px; margin-bottom:20px">üìÇ</div>
                            <h2 style="color:#1e293b; margin:0 0 10px 0">–§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h2>
                            <p style="color:#64748b; margin:0 0 25px 0; font-size:14px; line-height:1.5">
                                –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è <code>${configFile.split('/').pop()}</code> –≤—ñ–¥—Å—É—Ç–Ω—è –Ω–∞ –¥–∏—Å–∫—É. –¶–µ —á–∞—Å—Ç–æ —Å—Ç–∞—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞.
                            </p>
                            <button onclick="createMissingFile('${configFile}')" 
                                style="width:100%; padding:14px; background:#3b82f6; color:white; border:none; border-radius:12px; font-weight:700; font-size:14px; cursor:pointer; transition:background 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);">
                                üõ†Ô∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                            </button>
                            <a href="../index.html" style="display:block; margin-top:15px; color:#64748b; text-decoration:none; font-size:13px">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—É</a>
                        </div>
                    </div>
                `;
            };
            window.createMissingFile = async function (filename) {
                const defaultSchema = {
                    "meta": {
                        "version": "2.2",
                        "title": "–ù–æ–≤–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
                        "lastUpdated": new Date().toISOString().split('T')[0]
                    },
                    "categories": {
                        "cat_construction": { "name": "–ö–æ–Ω—Å—Ç—Ä—É—é–≤–∞–Ω–Ω—è", "color": "#e0f2fe" },
                        "cat_design": { "name": "–ü—Ä–æ—î–∫—Ç—É–≤–∞–Ω–Ω—è", "color": "#f3e8ff" },
                        "cat_assembly": { "name": "–ó–±—ñ—Ä–∫–∞", "color": "#fef9c3" },
                        "cat_installation": { "name": "–ú–æ–Ω—Ç–∞–∂", "color": "#dcfce7" }
                    },
                    "processes": [
                        { "id": "pr_c1", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ –¢–ó", "category": "cat_construction" },
                        { "id": "pr_c2", "name": "–º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_construction" },
                        { "id": "pr_c3", "name": "–ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_construction" },
                        { "id": "pr_c4", "name": "–≤–∏—Å—Ç–∞–≤–∏—Ç–∏ –≤ –º–æ–¥–µ–ª—å", "category": "cat_construction" },
                        { "id": "pr_c5", "name": "—Ä–æ–∑—Å—Ç–∞–≤–∏—Ç–∏ —Ñ-—Ä—É", "category": "cat_construction" },
                        { "id": "pr_c6", "name": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ä–æ–±—É", "category": "cat_construction" },
                        { "id": "pr_c7", "name": "–∫—Ä–µ—Å–ª–µ–Ω–Ω—è –°–ë", "category": "cat_construction" },
                        { "id": "pr_c8", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –Ω–∞ —ñ–Ω–¥–∏–≤—ñ–¥. –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è", "category": "cat_construction" },
                        { "id": "pr_c9", "name": "–º–æ–Ω—Ç–∞–∂–Ω–∞ —Å—Ö–µ–º–∞", "category": "cat_construction" },
                        { "id": "pr_c10", "name": "–ø—Ä–æ–¥–∂–µ–∫—Ç –Ω–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª", "category": "cat_construction" },
                        { "id": "pr_c11", "name": "–ö—Ñ. –¥–æ—Ä–æ–≤–∞—Ä—Ç—ñ—Å–Ω–æ–≥–æ –º–∞—Ç.", "category": "cat_construction" },
                        { "id": "pr_c12", "name": "—Ñ-—Ä–∞ –ø—Ä–æ–¥–∂–µ–∫—Ç", "category": "cat_construction" },
                        { "id": "pr_c13", "name": "–û–î–ö", "category": "cat_construction" },
                        { "id": "pr_c14", "name": "–ó–∞–º—ñ–Ω–∞-–∫–æ—Ä–µ–≥—É–≤. –º–∞—Ç–µ—Ä—ñ–∞–ª—É", "category": "cat_construction" },
                        { "id": "pr_d1", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è –∑ –¢–ó", "category": "cat_design" },
                        { "id": "pr_d2", "name": "–í–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ—Ç—Ä–µ–±–∏, –ø–∏—Ç–∞–Ω–Ω—è, –ø–æ—à—É–∫ –∫—Ä—ñ—à–µ–Ω—å, –Ω–µ—Ä–æ–∑—É–º—ñ–Ω–Ω—è", "category": "cat_design" },
                        { "id": "pr_d3", "name": "–º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_design" },
                        { "id": "pr_d4", "name": "–ú–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_design" },
                        { "id": "pr_d5", "name": "–≤–∏—Å—Ç–∞–≤–∏—Ç–∏ –≤ –º–æ–¥–µ–ª—å", "category": "cat_design" },
                        { "id": "pr_d6", "name": "—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∏—Ä–æ–±—É -?", "category": "cat_design" },
                        { "id": "pr_d7", "name": "–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ–º, –ø–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è", "category": "cat_design" },
                        { "id": "pr_d8", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –≤—É–∑–ª–æ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç—É", "category": "cat_design" },
                        { "id": "pr_d9", "name": "–ö—Ä–µ—Å–ª–µ–Ω–Ω—è –Ω–∞ –ø–æ–≥–æ–¥–∂–µ–Ω–Ω—è", "category": "cat_design" },
                        { "id": "pr_d10", "name": "–°–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è", "category": "cat_design" },
                        { "id": "pr_d11", "name": "–ö–æ–ª—å–æ—Ä–æ–≤–∞ —Å—Ö–µ–º–∞", "category": "cat_design" },
                        { "id": "pr_a1", "name": "–ö–æ–º–ø–ª–µ–∫—Ç—É–≤–∞–Ω–Ω—è", "category": "cat_assembly" },
                        { "id": "pr_a2", "name": "–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è", "category": "cat_assembly" },
                        { "id": "pr_a3", "name": "–î–æ–¥–∞—Ç–∫–æ–≤–∞ –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ –ø–æ—Å–ª—É–≥–∞", "category": "cat_assembly" },
                        { "id": "pr_a4", "name": "–ó–±—ñ—Ä–∫–∞", "category": "cat_assembly" },
                        { "id": "pr_a5", "name": "–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –º–æ–Ω—Ç–∞–∂", "category": "cat_assembly" },
                        { "id": "pr_a6", "name": "–î–µ–º–æ–Ω—Ç–∞–∂", "category": "cat_assembly" },
                        { "id": "pr_a7", "name": "–î–µ–º–æ–Ω—Ç–∞–∂ –ø–æ–¥–µ—Ç–∞–ª—å–Ω–∏–π", "category": "cat_assembly" },
                        { "id": "pr_a8", "name": "–ü–∞–∫—É–≤–∞–Ω–Ω—è –ø–æ–º–æ–¥—É–ª—å–Ω–µ", "category": "cat_assembly" },
                        { "id": "pr_a9", "name": "–ü–∞–∫—É–≤–∞–Ω–Ω—è –ø–æ–¥–µ—Ç–∞–ª—å–Ω–µ", "category": "cat_assembly" },
                        { "id": "pr_i1", "name": "–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏–º—ñ—â–µ–Ω–Ω—è", "category": "cat_installation" },
                        { "id": "pr_i2", "name": "–æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è —ñ–∑ –∫—Ä–µ—Å–ª–µ–Ω—è–º", "category": "cat_installation" },
                        { "id": "pr_i3", "name": "—Ä–æ–∑–ø–∞–∫–æ–≤–∫–∞", "category": "cat_installation" },
                        { "id": "pr_i4", "name": "–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥—É–ª—ñ–≤", "category": "cat_installation" },
                        { "id": "pr_i5", "name": "—Ä–æ–∑–º—ñ—Ç–∫–∞ —Ç–∞ —Å–≤–µ—Ä–ª—ñ–Ω–Ω—è –ø–æ–¥ –º–æ–Ω—Ç–∞–∂–Ω—É –ø–ª–∞–Ω–∫—É", "category": "cat_installation" },
                        { "id": "pr_i6", "name": "–ú–æ–Ω—Ç–∞–∂", "category": "cat_installation" },
                        { "id": "pr_i7", "name": "–ü–Ü–î–†–Ü–ó–ö–ê –ü–†–û–§–Ü–õ–Æ –¢–ê –§–ê–õ–¨–®–Ü–í –Ü –ö–ê–†–ù–Ü–ó–Ü–í", "category": "cat_installation" },
                        { "id": "pr_i8", "name": "–º–æ–Ω—Ç–∞–∂ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏", "category": "cat_installation" },
                        { "id": "pr_i9", "name": "–í–∏—Ä—ñ–∑ –æ—Ç–≤–æ—Ä—ñ–≤ –ø—ñ–¥ —Ä–æ–∑–µ—Ç–∫–∏", "category": "cat_installation" },
                        { "id": "pr_i10", "name": "–ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è —Ç–∞ –≤–∏–Ω–æ—Å —Å–º—ñ—Ç—Ç—è", "category": "cat_installation" },
                        { "id": "pr_i11", "name": "–≤–∏—Ä—ñ–∑–∏ / –∑–∞—Ä—ñ–∑–∏", "category": "cat_installation" }
                    ],
                    "groups": [
                        { "id": "g_main", "title": "–û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏" }
                    ],
                    "fields": [],
                    "products": { "groups": [], "fields": [] },
                    "rules": {}
                };
                const fileContent = `const Schema = ${JSON.stringify(defaultSchema, null, 4)};\nwindow.Schema = Schema;`;
                try {
                    const response = await fetch('http://localhost:5005', {
                        method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: filename, content: fileContent })
                    });
                    if (response.ok) {
                        alert('‚úÖ –§–∞–π–ª —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
                        location.reload();
                    } else {
                        alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É.');
                    }
                } catch (e) {
                    alert('‚ùå –õ–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä (Python) –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ! –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—É—Å—Ç—ñ—Ç—å local_saver.py.');
                }
            };
            document.head.appendChild(script);
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>

<body>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar" id="mainSidebar">
        <div class="sidebar-header" style="display:flex; flex-direction:column; gap:10px; padding-bottom:15px">
            <div style="display:flex; align-items:center; width:100%">
                üõ†Ô∏è Admin
                <button class="btn-mini" style="margin-left:auto; display:none" id="closeSidebarBtn"
                    onclick="toggleSidebar(false)">√ó</button>
            </div>
            <button class="nav-btn" onclick="window.location.href='../index.html'"
                style="background: #3b82f6; border: 1px solid rgba(255,255,255,0.2); font-weight: 800; color: white; width:100%; justify-content:center">üè†
                –ù–ê –ì–û–õ–û–í–ù–£</button>
            <button class="nav-btn" onclick="openMarkupModal()"
                style="margin-top:10px; background:rgba(16, 185, 129, 0.15); border: 2px solid #10b981; color: #10b981; font-size:14px; font-weight:800; padding:15px; text-transform:uppercase; letter-spacing:0.05em">
                üìà –ö–æ—Ä. –∫–æ–µ—Ñ.
            </button>
        </div>
        <div class="sidebar-nav" id="sidebarNav"></div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="openActionModal('ADD_GROUP_CALC')">+ –ì—Ä—É–ø–∞ (–ö–∞–ª–∫)</button>
            <button class="nav-btn" onclick="document.getElementById('csvIn').click()" style="margin-top:10px">üìÇ –Ü–º–ø–æ—Ä—Ç
                CSV</button>

            <button class="nav-btn" onclick="goToDesigner()"
                style="margin-top:10px; background: #6366f1; border: 1px solid rgba(255,255,255,0.2)">üé®
                –î–ò–ó–ê–ô–ù–ï–†</button>
            <button class="nav-btn" onclick="openAIModal()"
                style="margin-top:10px; background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border: none; font-weight: 800; color: white; display:flex; align-items:center; justify-content:center; gap:8px">
                ‚ú® AI MAGIC
            </button>
            <input type="file" id="csvIn" style="display:none" onchange="handleCSV(this)">
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:8px">
                <button class="mobile-menu-btn" onclick="toggleSidebar(true)">‚ò∞</button>
                <a href="../index.html" style="text-decoration:none;font-size:20px; transition:transform 0.2s;"
                    onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"
                    title="–ù–∞ –≥–æ–ª–æ–≤–Ω—É">üè†</a>
                <div style="font-weight:700; color:var(--text-main); font-size: 11px; white-space: nowrap; opacity: 0.6;"
                    class="top-bar-title">–ü–†–ê–¶–Æ–Ñ–ú–û –ó:</div>
                <select id="calcSwitcher" onchange="switchCalculator(this.value)"
                    style="padding: 6px 12px; border-radius: 10px; border: 2px solid var(--accent); background: white; font-size: 13px; font-weight: 700; cursor: pointer; color: var(--accent); outline: none; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.1); transition: 0.2s;">
                    <!-- Javascript will populate this -->
                </select>
            </div>
            <div style="display:flex; align-items:center; gap:12px">
                <div
                    style="display:flex; align-items:center; background:#f1f5f9; padding:4px; border-radius:8px; gap:4px">
                    <button class="btn-mini" style="font-size:16px; width:32px; height:32px" onclick="undo()"
                        title="–ù–∞–∑–∞–¥ (Ctrl+Z)">‚Ü©Ô∏è</button>
                    <button class="btn-mini" style="font-size:16px; width:32px; height:32px" onclick="redo()"
                        title="–í–ø–µ—Ä–µ–¥ (Ctrl+Y)">‚Ü™Ô∏è</button>
                </div>
                <span id="unsavedHint"
                    style="display:none; color:var(--danger); font-size:12px; font-weight:700; background:#fee2e2; padding:4px 10px; border-radius:20px; border:1px solid #fecaca">‚ö†Ô∏è
                    –Ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏!</span>
                <button class="btn"
                    style="background:#6366f1; color:white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);"
                    onclick="togglePreview(true)">üëÅÔ∏è –¢–µ—Å—Ç–æ–≤–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ –ú–æ–¥–∞–ª–æ–∫</button>
                <button id="mainSaveBtn" class="btn btn-save"
                    style="box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);" onclick="saveData()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
                    –∑–º—ñ–Ω–∏</button>
            </div>
        </div>
        <div class="matrix-container" id="matrixContainer"></div>
    </div>

    <!-- AI MAGIC MODAL -->
    <div id="aiModal" class="modal">
        <div class="modal-card"
            style="max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); color: white;">
                <h3>‚ú® AI –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ (Gemini 1.5)</h3>
                <button onclick="closeModal('aiModal')"
                    style="background:none; border:none; color:white; font-size:24px; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1;">

                <div class="form-group">
                    <label class="form-label">üîë Gemini API Key <a href="https://aistudio.google.com/app/apikey"
                            target="_blank" style="font-size:11px; color:#3b82f6">(–û—Ç—Ä–∏–º–∞—Ç–∏ –∫–ª—é—á)</a></label>
                    <input type="password" id="aiKey" class="form-input"
                        placeholder="–í—Å—Ç–∞–≤—Ç–µ –≤–∞—à API –∫–ª—é—á —Ç—É—Ç (–∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)">
                </div>

                <div class="form-group">
                    <label class="form-label">üñºÔ∏è –§–æ—Ç–æ –º–µ–±–ª—ñ–≤ / –ï—Å–∫—ñ–∑</label>
                    <div id="aiDropzone"
                        style="border: 2px dashed #cbd5e1; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; background: #f8fafc; position: relative"
                        onclick="document.getElementById('aiImgInput').click()">
                        <div id="aiDropText">
                            <div style="font-size: 32px; margin-bottom: 10px">üì∏</div>
                            <span style="color: #64748b; font-weight: 500">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ
                                —Å—é–¥–∏</span><br>
                            <span style="color: #94a3b8; font-size: 11px">(–¢–∞–∫–æ–∂ –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–≤–∏—Ç–∏ Ctrl+V)</span>
                        </div>
                        <img id="aiPreview"
                            style="max-width: 100%; max-height: 200px; display: none; margin: 0 auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1)">
                        <button id="aiRemoveImg" onclick="event.stopPropagation(); clearAiImage()"
                            style="display:none; position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer">&times;</button>
                    </div>
                    <input type="file" id="aiImgInput" accept="image/*" style="display:none"
                        onchange="handleAiFile(this.files[0])">
                </div>

                <div class="form-group">
                    <label class="form-label">üìù –¢–µ—Ö–Ω—ñ—á–Ω–µ –ó–∞–≤–¥–∞–Ω–Ω—è (–¢–ó)</label>
                    <textarea id="aiPrompt" class="form-input" rows="4"
                        placeholder="–û–ø–∏—à—ñ—Ç—å –¥–µ—Ç–∞–ª—ñ: –º–∞—Ç–µ—Ä—ñ–∞–ª–∏, —Ñ—É—Ä–Ω—ñ—Ç—É—Ä–∞, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: '–§–∞—Å–∞–¥–∏ –ú–î–§ —Ñ–∞—Ä–±–æ–≤–∞–Ω–∏–π, —Ñ—É—Ä–Ω—ñ—Ç—É—Ä–∞ Blum, —Å—Ç—ñ–ª—å–Ω–∏—Ü—è Egger')"></textarea>
                </div>

                <div id="aiLog"
                    style="display:none; background:#1e293b; color:#10b981; padding:10px; border-radius:8px; font-family:monospace; font-size:11px; margin-bottom:15px; white-space: pre-wrap;">
                </div>

            </div>
            <div class="modal-footer"
                style="padding: 15px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeModal('aiModal')" class="btn"
                    style="background: #f1f5f9; color: #64748b">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="runAiAnalysis()" id="aiRunBtn" class="btn"
                    style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3)">ü§ñ
                    –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- UNIVERSAL ACTION MODAL (Replaces Prompts) -->
    <div id="actionModal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="actionTitle">–î—ñ—è</h3>
                <button onclick="closeModal('actionModal')"
                    style="background:none; border:none; font-size:24px; color:#94a3b8; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="actionType">
                <input type="hidden" id="actionId">
                <input type="hidden" id="actionIsP">
                <div class="form-group">
                    <label class="form-label" id="actionLabel">–ù–∞–∑–≤–∞</label>
                    <input type="text" id="actionInput" class="form-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:none; color:#64748b"
                    onclick="closeModal('actionModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-save" onclick="handleActionSubmit()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- FIELD SETTINGS MODAL -->
    <div id="fieldModal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ü–æ–ª—è</h3>
                <button onclick="closeModal('fieldModal')"
                    style="background:none; border:none; font-size:24px; color:#94a3b8; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fId">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞ –ü–æ–ª—è</label>
                    <input type="text" id="fName" class="form-input" placeholder="–ù–∞–∑–≤–∞ –ø–æ–ª—è (Label)">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –ü–æ–ª—è</label>
                    <select id="fType" class="form-input" onchange="toggleFieldSettings(this.value)">
                        <option value="number">–ß–∏—Å–ª–æ / –ö—ñ–ª—å–∫—ñ—Å—Ç—å</option>
                        <option value="select">–í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ (–†—è–¥–∫–∏)</option>
                        <option value="multiselect">–ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä (Checkboxes)</option>
                        <option value="multiselect_qty">–ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä + –ö—ñ–ª—å–∫—ñ—Å—Ç—å</option>
                        <option value="select_yes_no">–í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ (–¢–∞–∫/–ù—ñ)</option>
                        <option value="checkbox_qty">–ì–∞–ª–æ—á–∫–∞ + –ö—ñ–ª—å–∫—ñ—Å—Ç—å</option>
                        <option value="action_button">–ö–Ω–æ–ø–∫–∞ –≤–∏–∫–ª–∏–∫—É —Ñ–æ—Ä–º–∏ (–ú–æ–¥–∞–ª–∫–∞)</option>
                        <option value="select_modal">–°–ø–∏—Å–æ–∫ (–¢–∞–∫/–ù—ñ) + –ú–æ–¥–∞–ª–∫–∞</option>
                    </select>
                </div>
                <div class="form-group" id="btnTextInput" style="display:none">
                    <label class="form-label" id="btnTextLabel">–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø—Ü—ñ</label>
                    <input type="text" id="fDefault" class="form-input" placeholder="+ –î–æ–¥–∞—Ç–∏ –≤–∏—Ä—ñ–±">
                </div>
                <div class="form-group" id="selectLabels" style="display:none">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                        <div>
                            <label class="form-label">–ú—ñ—Ç–∫–∞ "–¢–∞–∫"</label>
                            <input type="text" id="fLabelYes" class="form-input" placeholder="–¢–∞–∫">
                        </div>
                        <div>
                            <label class="form-label">–ú—ñ—Ç–∫–∞ "–ù—ñ"</label>
                            <input type="text" id="fLabelNo" class="form-input" placeholder="–ù—ñ">
                        </div>
                    </div>
                </div>
                <div class="form-group" id="selectPlaceholder" style="display:none">
                    <label class="form-label">–¢–µ–∫—Å—Ç-–∑–∞–ø–æ–≤–Ω—é–≤–∞—á (-- –í–∏–±–µ—Ä—ñ—Ç—å --)</label>
                    <input type="text" id="fPlaceholder" class="form-input" placeholder="-- –í–∏–±–µ—Ä—ñ—Ç—å --">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—ñ–¥–∫–∞–∑–∫–∞ (Tooltip)</label>
                    <textarea id="fHelp" class="form-input" rows="4"
                        placeholder="–¢–µ–∫—Å—Ç, —è–∫–∏–π –∑'—è–≤–∏—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ [?]"></textarea>
                </div>
                <div class="form-group" id="numberSettings" style="display:none">
                    <label
                        style="display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0">
                        <input type="checkbox" id="fAllowDecimal" style="width:18px; height:18px">
                        <div>
                            <span style="font-weight:600">–î–æ–∑–≤–æ–ª–∏—Ç–∏ –¥—Ä–æ–±–æ–≤—ñ —á–∏—Å–ª–∞</span>
                            <div style="font-size:11px; color:#64748b">–ú–æ–∂–Ω–∞ –≤–≤–æ–¥–∏—Ç–∏ 1.5, 2,7 —Ç–æ—â–æ. –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –≤–≤–µ—Ä—Ö.
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:none" onclick="closeModal('fieldModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button class="btn btn-save" onclick="saveFModal()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- FORMULA EDITOR MODAL -->
    <div id="formulaModal" class="modal">
        <div class="modal-card" style="width: 700px;">
            <div class="modal-header">
                <h3>üìú –†–µ–¥–∞–∫—Ç–æ—Ä –§–æ—Ä–º—É–ª–∏</h3>
                <button onclick="closeModal('formulaModal')"
                    style="background:none; border:none; font-size:24px; color:#94a3b8; cursor:pointer">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="formFI">
                <input type="hidden" id="formPI">
                <input type="hidden" id="formOV">
                <p id="formulaDesc" style="font-size: 13px; color: #64748b; margin-bottom: 15px;"></p>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏—à–≤–∏–¥—à–µ–Ω–µ –≤–≤–µ–¥–µ–Ω–Ω—è (—à–∞–±–ª–æ–Ω–∏)</label>
                    <select id="formulaTemplate" onchange="applyFormulaTemplate(this.value)">
                        <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å —à–∞–±–ª–æ–Ω --</option>
                        <option value="linear">–õ—ñ–Ω—ñ–π–Ω–µ –º–Ω–æ–∂–µ–Ω–Ω—è: @qty * X</option>
                        <option value="maxlimit">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –ª—ñ–º—ñ—Ç: min(@qty, 2) * 15</option>
                        <option value="base_plus">–ë–∞–∑–∞ + –ø—Ä–∏—Ä—ñ—Å—Ç: 10 + (@qty * 0.5)</option>
                        <option value="tiered">–°—Ç—É–ø—ñ–Ω—á–∞—Å—Ç–∞ —Ü—ñ–Ω–∞: @qty <= 5 ? @qty*10 : 5*10+(@qty-5)*8</option>
                        <option value="grad_5_7_9">–ì—Ä–∞–¥–∞—Ü—ñ—è (0-5-10-15): 0‚Üí0, ‚â§5‚Üí5, ‚â§10‚Üí7, ‚â§15‚Üí9...</option>
                        <option value="fixed">–§—ñ–∫—Å–æ–≤–∞–Ω–∞ + –∑–º—ñ–Ω–Ω–∞: 50 + (@qty-1)*20</option>
                        <option value="percent">–í—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥ —ñ–Ω—à–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: @sum_zbira * 0.15</option>
                    </select>
                </div>
                <div class="formula-hints">
                    <h4>üìù –î–æ—Å—Ç—É–ø–Ω—ñ –∑–º—ñ–Ω–Ω—ñ:</h4>
                    <code>@qty</code> - –∫—ñ–ª—å–∫—ñ—Å—Ç—å (—è–∫—É –≤–≤—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á)<br>
                    <code>@raw</code> - —Å—É–º–∞ –±–∞–ª—ñ–≤ <b>—Ç—ñ–ª—å–∫–∏ —Ü—å–æ–≥–æ —Ä—è–¥–∫–∞</b> (–±—ñ–ª—ñ –∫–ª—ñ—Ç–∏–Ω–∫–∏)<br>
                    <code>@sum</code> - —Å—É–º–∞ —Ä—è–¥–∫–∞ √ó –∫—ñ–ª—å–∫—ñ—Å—Ç—å (@raw * @qty)<br>
                    <code>@sum_konst</code>, <code>@sum_proekt</code>... - <b>–ó–ê–ì–ê–õ–¨–ù–ê</b> —Å—É–º–∞ –≤—Å—å–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É<br>
                    <code>min(a, b)</code>, <code>max(a, b)</code> - –º–∞—Ç. —Ñ—É–Ω–∫—Ü—ñ—ó
                </div>
                <div class="form-group">
                    <label class="form-label">–§–æ—Ä–º—É–ª–∞ (–ø–æ—á–∏–Ω–∞–π—Ç–µ –∑ =)</label>
                    <textarea id="formulaInput" class="form-input formula-box" rows="5"
                        oninput="updateFormulaPreview()"></textarea>
                </div>
                <div class="formula-preview">
                    <h4>üëÅÔ∏è –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥:</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å (@qty)</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç (—Ö–≤/–±–∞–ª–∏)</th>
                            </tr>
                        </thead>
                        <tbody id="formulaPreviewBody">
                            <tr>
                                <td>1</td>
                                <td id="prev_1">-</td>
                            </tr>
                            <tr>
                                <td>5</td>
                                <td id="prev_5">-</td>
                            </tr>
                            <tr>
                                <td>10</td>
                                <td id="prev_10">-</td>
                            </tr>
                            <tr>
                                <td>20</td>
                                <td id="prev_20">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <details class="formula-help">
                    <summary>üìö –ü—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—è</summary>
                    <div class="example">
                        <strong>–í–∞—à –∫–µ–π—Å (–Ø—â–∏–∫–∏): –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ 5 —Ö–≤</strong>
                        <code>=min(@qty, 3) * 5</code>
                        <p>–Ø–∫—â–æ 10 —è—â–∏–∫—ñ–≤ ‚Üí –ø–æ—Ä–∞—Ö—É—î —è–∫ 3 * 5 = 15 —Ö–≤.</p>
                    </div>
                    <div class="example">
                        <strong>–ó–∞ –∫–æ–∂–Ω—É –æ–¥–∏–Ω–∏—Ü—é –ø–æ 10 –±–∞–ª—ñ–≤</strong>
                        <code>=@qty * 10</code>
                    </div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:none" onclick="closeModal('formulaModal')">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button class="btn btn-save" onclick="saveFormula()">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ä–º—É–ª—É</button>
            </div>
        </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="prodModal" class="modal" onclick="event.target==this && closeModal('prodModal')">
        <div class="modal-card">
            <div class="modal-header">
                <h3>üß™ –¢–µ—Å—Ç–æ–≤–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ –ú–æ–¥–∞–ª–æ–∫</h3>
                <button onclick="closeModal('prodModal')"
                    style="background:none; border:none; font-size:24px; color:#94a3b8; cursor:pointer">&times;</button>
            </div>
            <div id="prodBody" class="modal-body" style="max-height:60vh; overflow-y:auto"></div>
            <div class="modal-footer">
                <button class="btn" style="background:var(--accent); color:white"
                    onclick="closeModal('prodModal')">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
            </div>
        </div>
    </div>

    <script>
        const UIState = {
            collapsed: [],
            collapsedGroups: [],
            history: [],
            redoStack: [],
            lastSchema: null,
            selectedCells: [], // {fieldId, processId, optionValue, isModal, mfId}
            isSelecting: false,
            isBulkUpdating: false,
            highlightedCat: null,
            clearSelectionOnNextUpdate: false
        };

        window.onkeydown = (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
            if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
            if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); saveData(); }
        };

        const CatAliases = {
            'cat_construction': 'konst',
            'cat_design': 'proekt',
            'cat_assembly': 'zbira',
            'cat_install': 'montaz'
        };

        function pushHistory() {
            const snapshot = JSON.stringify(Schema);
            if (UIState.lastSchema === snapshot) return;
            UIState.history.push(UIState.lastSchema);
            UIState.redoStack = [];
            UIState.lastSchema = snapshot;
            if (UIState.history.length > 50) UIState.history.shift();
            markDirty();
        }

        function undo() {
            if (UIState.history.length === 0) return;
            UIState.redoStack.push(JSON.stringify(Schema));
            const prev = UIState.history.pop();
            Object.assign(Schema, JSON.parse(prev));
            UIState.lastSchema = prev;
            refresh();
        }

        function redo() {
            if (UIState.redoStack.length === 0) return;
            UIState.history.push(JSON.stringify(Schema));
            const next = UIState.redoStack.pop();
            Object.assign(Schema, JSON.parse(next));
            UIState.lastSchema = next;
            refresh();
        }

        function goToDesigner() {
            const config = window.currentConfigFile || 'data/schema_kitchen.js';
            window.location.href = 'designer.html?config=' + config;
        }

        function initCalcSwitcher() {
            const select = document.getElementById('calcSwitcher');
            if (!select || !window.CalculatorConfig) return;

            select.innerHTML = '';
            window.CalculatorConfig.forEach(conf => {
                const opt = document.createElement('option');
                opt.value = conf.file;
                opt.textContent = conf.title;
                // Normalize for comparison
                const currentRel = window.currentConfigFile.replace('../', '');
                const confRel = conf.file.replace('../', '');
                if (currentRel === confRel) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function switchCalculator(file) {
            const hasUnsaved = document.getElementById('unsavedHint').style.display !== 'none';
            if (hasUnsaved) {
                if (!confirm('–£ –≤–∞—Å —î –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏! –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è?')) {
                    // Reset select to current
                    document.getElementById('calcSwitcher').value = window.currentConfigFile;
                    return;
                }
            }
            window.location.href = 'admin.html?config=' + file;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCalcSwitcher();
            refresh();
        });

        function refresh() {
            if (!UIState.lastSchema) UIState.lastSchema = JSON.stringify(Schema);
            renderSidebar();
            renderMatrix();
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebarNav');
            if (!nav) return;
            nav.innerHTML = '';


            // 1. –ü–æ–ª—è —Ç–∞ –ì—Ä—É–ø–∏ (–ù–∞–≤—ñ–≥–∞—Ü—ñ—è)
            const hFields = document.createElement('div');
            hFields.className = 'sidebar-section-header';
            hFields.innerText = '–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–∞ –ì—Ä—É–ø–∏';
            nav.appendChild(hFields);

            Schema.groups.forEach(g => {
                const i = document.createElement('div');
                i.className = 'nav-item';
                i.innerHTML = `üìÅ ${g.title}`;
                i.onclick = () => {
                    const el = document.getElementById(`group-${g.id}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                nav.appendChild(i);
            });

            // 2. –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ –ü—Ä–æ—Ü–µ—Å–∏ (–í–∏–¥–∞–ª–µ–Ω–æ –∑ —Å–∞–π–¥–±–∞—Ä—É –∑–∞ –∑–∞–ø–∏—Ç–æ–º)



            if (Schema.products && Schema.products.groups && Schema.products.groups.length > 0) {
                const hProd = document.createElement('div');
                hProd.className = 'sidebar-section-header';
                hProd.innerText = '–í–∏—Ä–æ–±–∏ (–ê—Ä—Ö—ñ–≤)';
                nav.appendChild(hProd);
                Schema.products.groups.forEach(g => {
                    const i = document.createElement('div');
                    i.className = 'nav-item'; i.innerHTML = `üì¶ ${g.title}`;
                    nav.appendChild(i);
                });
            }
        }

        function scrollToProc(pid) {
            // Find the header for this process
            const ths = document.querySelectorAll('.th-proc');
            let found = false;
            ths.forEach(th => {
                if (th.innerHTML.includes(`'${pid}'`) || th.innerHTML.includes(`"${pid}"`)) {
                    th.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    th.style.background = '#fde047';
                    setTimeout(() => th.style.background = '', 2000);
                    found = true;
                }
            });
            if (!found) alert('–ü—Ä–æ—Ü–µ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü—ñ (–º–æ–∂–ª–∏–≤–æ, –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –∑–≥–æ—Ä–Ω—É—Ç–∞)');
        }

        // --- NEW CUSTOM MODAL LOGIC ---
        function openActionModal(type, id = '', isP = false) {
            document.getElementById('actionType').value = type;
            document.getElementById('actionId').value = id;
            document.getElementById('actionIsP').value = isP ? '1' : '0';

            let title = '–î—ñ—è';
            let currentVal = '';

            if (type === 'ADD_CAT') {
                title = '–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª';
            } else if (type === 'ADD_PROC') {
                const cat = Schema.categories[id];
                title = `–î–æ–¥–∞—Ç–∏ –ü—Ä–æ—Ü–µ—Å –¥–æ "${cat ? cat.name : id}"`;
            } else if (type === 'RENAME_CAT') {
                const cat = Schema.categories[id];
                title = '–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—É';
                currentVal = cat ? cat.name : '';
            } else if (type === 'RENAME_PROC') {
                const proc = Schema.processes.find(p => p.id === id);
                title = '–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É';
                currentVal = proc ? proc.name : '';
            } else if (type === 'RENAME_GROUP') {
                const group = (isP ? Schema.products.groups : Schema.groups).find(g => g.id === id);
                title = '–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏';
                currentVal = group ? group.title : '';
            } else if (type === 'ADD_GROUP_CALC') {
                title = '–î–æ–¥–∞—Ç–∏ –≥—Ä—É–ø—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞';
            }

            document.getElementById('actionTitle').innerText = title;
            document.getElementById('actionInput').value = currentVal;
            document.getElementById('actionModal').style.display = 'flex';
            setTimeout(() => document.getElementById('actionInput').focus(), 100);
        }

        function closeModal(mId) { document.getElementById(mId).style.display = 'none'; }

        function handleActionSubmit() {
            const type = document.getElementById('actionType').value;
            const val = document.getElementById('actionInput').value.trim();
            const id = document.getElementById('actionId').value;
            const isP = document.getElementById('actionIsP').value === '1';

            if (!val) return closeModal('actionModal');
            pushHistory();

            if (type === 'RENAME_CAT') { Schema.categories[id].name = val; refresh(); }
            else if (type === 'RENAME_PROC') { Schema.processes.find(x => x.id === id).name = val; refresh(); }
            else if (type === 'RENAME_GROUP') { (isP ? Schema.products.groups : Schema.groups).find(x => x.id === id).title = val; refresh(); }
            else if (type === 'ADD_CAT') {
                const nid = 'cat_' + Date.now();
                const colors = ['#eff6ff', '#f0fdf4', '#faf5ff', '#fff7ed', '#f0fdfa'];
                const color = colors[Object.keys(Schema.categories).length % colors.length];
                Schema.categories[nid] = { name: val, color: color };
                refresh();
            }
            else if (type === 'ADD_PROC') { Schema.processes.push({ id: 'p' + Date.now(), name: val, category: id }); refresh(); }
            else if (type === 'ADD_GROUP_CALC') { Schema.groups.push({ id: 'g' + Date.now(), title: val }); refresh(); }

            markDirty();
            closeModal('actionModal');
        }


        let formulaSaveFn = null;

        function renderTotalCell(fieldId, catId, manualSum, optionValue = null, isP = false, isModal = false) {
            const td = document.createElement('td');
            td.className = 'td-total td-total-column';
            td.style.textAlign = 'center';
            td.style.position = 'relative';
            td.style.width = '70px';
            td.style.minWidth = '70px';

            const ruleKey = isModal ? `${fieldId}` : fieldId;
            const formulaKey = `_total_${catId}`;
            const rules = isModal ? (Schema.modalFieldRules?.[ruleKey] || {}) : (Schema.rules?.[fieldId] || {});
            const formula = optionValue ? (rules[optionValue]?.[formulaKey]) : (rules[formulaKey]);

            // Highlighting
            if (UIState.highlightedCat) {
                const alias = CatAliases[UIState.highlightedCat];
                if (alias && String(formula).includes(`@sum_${alias}`)) {
                    td.classList.add('highlight-connection');
                }
            }

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.style.justifyContent = 'center';
            wrapper.style.gap = '4px';

            const span = document.createElement('span');
            span.style.fontWeight = '700';

            if (formula) {
                span.innerText = 'f(x)';
                span.style.color = '#ef4444';
                td.style.background = 'var(--formula-bg)';
            } else {
                span.innerText = manualSum > 0 ? manualSum.toLocaleString() : '0';
                span.style.color = '#94a3b8';
                span.style.fontWeight = '400';
            }
            wrapper.appendChild(span);

            const btn = document.createElement('button');
            btn.innerHTML = 'üßÆ';
            btn.className = 'formula-btn';
            btn.style.padding = '1px 3px';
            btn.style.fontSize = '10px';
            btn.style.opacity = formula ? '1' : '0.2';
            btn.onclick = (e) => {
                e.stopPropagation();
                const title = `–°—É–º–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "${Schema.categories[catId]?.name || catId}"`;
                openFormulaModal(title, formula, (v) => {
                    pushHistory();
                    const rSet = isModal ? (Schema.modalFieldRules || (Schema.modalFieldRules = {})) : (Schema.rules || (Schema.rules = {}));
                    const rPath = isModal ? (rSet[ruleKey] || (rSet[ruleKey] = {})) : (rSet[fieldId] || (rSet[fieldId] = {}));
                    if (optionValue) {
                        const oPath = rPath[optionValue] || (rPath[optionValue] = {});
                        oPath[formulaKey] = v;
                    } else rPath[formulaKey] = v;
                    renderMatrix();
                });
            };
            wrapper.appendChild(btn);
            td.appendChild(wrapper);
            return td;
        }

        function renderCellInput(val, onUpdate, onFormulaOpen, onToggleOnce, fieldType) {
            const wrapper = document.createElement('div');
            wrapper.className = 'cell-wrapper';

            let dVal = val;
            let isOnce = false;
            if (val && typeof val === 'object' && val.v !== undefined) {
                dVal = val.v;
                isOnce = !!val.once;
            }

            const inp = document.createElement('input');
            inp.className = 'cell-input';
            inp.value = dVal || '';
            const isF = String(dVal).startsWith('=');
            if (isF) inp.classList.add('has-formula');
            else if (dVal) inp.classList.add('has-val');

            // Highlighting
            if (UIState.highlightedCat && isF) {
                const alias = CatAliases[UIState.highlightedCat];
                if (alias && String(dVal).includes(`@sum_${alias}`)) {
                    inp.classList.add('highlight-connection');
                }
            }

            inp.onfocus = (e) => {
                e.target.select();
            };
            inp.onchange = (e) => onUpdate(e.target.value);
            inp.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    UIState.clearSelectionOnNextUpdate = true;
                    e.target.blur();
                }
            };

            wrapper.appendChild(inp);

            if (onToggleOnce && (fieldType === 'number' || fieldType === 'checkbox_qty') && !isF) {
                const tick = document.createElement('div');
                tick.className = 'once-tick' + (isOnce ? ' active' : '');
                tick.title = isOnce ? '–í—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è 1 —Ä–∞–∑ (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ)' : '–ú–Ω–æ–∂–∏—Ç—å—Å—è –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å';
                tick.innerHTML = `<input type="checkbox" ${isOnce ? 'checked' : ''} tabindex="-1"><span>1x</span>`;
                tick.onclick = (e) => { e.stopPropagation(); onToggleOnce(!isOnce); };
                wrapper.appendChild(tick);
            }

            return wrapper;
        }

        function quickAddTrigger() {
            if (!Schema.groups || Schema.groups.length === 0) return alert('–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –≥—Ä—É–ø—É –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ');
            const newId = 'f_trig_' + Date.now();
            Schema.fields.push({
                id: newId,
                groupId: Schema.groups[0].id,
                label: '–í–∏–∫–ª–∏–∫ —Ñ–æ—Ä–º–∏',
                type: 'action_button',
                default: '+ –î–æ–¥–∞—Ç–∏ –≤–∏—Ä—ñ–±'
            });
            console.log('QuickAdded field:', newId);
            markDirty();
            renderMatrix();
            alert('‚ö° –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–Ω–∞ —É –ø–µ—Ä—à—É –≥—Ä—É–ø—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞!');
        }

        // Modal Fields Management
        function addModalField(buttonId, isP) {
            const fields = isP ? Schema.products.fields : Schema.fields;
            const field = fields.find(f => f.id === buttonId);

            if (!field) {
                console.error('Field not found:', buttonId);
                alert('–ü–æ–º–∏–ª–∫–∞: –ü–æ–ª–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }
            if (!field.modalFields) field.modalFields = [];

            // Create mini-modal for adding new modal field
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:24px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:320px';
            modal.innerHTML = `
                <h4 style="margin:0 0 20px 0;font-size:16px;color:#334155">‚ûï –ù–æ–≤–µ –ø–æ–ª–µ –≤ –º–æ–¥–∞–ª–∫—É</h4>
                <div style="margin-bottom:15px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ù–∞–∑–≤–∞ –ø–æ–ª—è</label>
                    <input id="mfNewName" type="text" value="–ù–æ–≤–µ –ø–æ–ª–µ" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box">
                </div>
                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–¢–∏–ø –ø–æ–ª—è</label>
                    <select id="mfNewType" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px">
                        <option value="number">üî¢ –ß–∏—Å–ª–æ (number)</option>
                        <option value="select">üìã –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ (select)</option>
                        <option value="select_yes_no">üîΩ –í–∏–±—ñ—Ä –¢–∞–∫/–ù—ñ (select_yes_no)</option>
                        <option value="checkbox">‚úÖ –ß–µ–∫–±–æ–∫—Å (checkbox)</option>
                        <option value="checkbox_qty">‚òëÔ∏è –ß–µ–∫–±–æ–∫—Å –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é (checkbox_qty)</option>
                        <option value="multiselect">üìë –ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä (multiselect)</option>
                    </select>
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button id="mfNewCancelBtn" style="padding:10px 20px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="mfNewSaveBtn" style="padding:10px 20px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600">–î–æ–¥–∞—Ç–∏</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('mfNewName').focus();
            document.getElementById('mfNewName').select();

            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.getElementById('mfNewCancelBtn').onclick = () => overlay.remove();
            document.getElementById('mfNewSaveBtn').onclick = () => {
                const label = document.getElementById('mfNewName').value.trim();
                const selectedType = document.getElementById('mfNewType').value;

                if (!label) {
                    alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø–æ–ª—è');
                    return;
                }

                const newField = {
                    id: 'mf_' + Date.now(),
                    label: label,
                    type: selectedType,
                    default: selectedType === 'number' ? 0 : (selectedType === 'checkbox_qty' ? '–î–æ–¥–∞—Ç–∏' : ''),
                    layout: { inpBorder: '#000000' } // Black border by default
                };

                if (selectedType === 'select' || selectedType === 'multiselect') {
                    newField.options = [
                        { value: 'opt1', label: '–í–∞—Ä—ñ–∞–Ω—Ç 1' },
                        { value: 'opt2', label: '–í–∞—Ä—ñ–∞–Ω—Ç 2' }
                    ];
                }

                field.modalFields.push(newField);
                markDirty();
                renderMatrix();
                overlay.remove();
            };
        }

        function delModalField(buttonId, idx, isP) {
            console.log('Deleting modal field:', buttonId, 'at index:', idx, 'isProduct:', isP);
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–ª–µ–º –∑ –º–æ–¥–∞–ª–∫–∏?')) return;

            const fields = isP ? Schema.products.fields : Schema.fields;
            const field = fields.find(f => f.id === buttonId);

            if (field && field.modalFields) {
                field.modalFields.splice(idx, 1);
                markDirty();
                renderMatrix();
            }
        }

        function delCat(id) { if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ä–æ–∑–¥—ñ–ª –∑—ñ –≤—Å—ñ–º–∞ –ø—Ä–æ—Ü–µ—Å–∞–º–∏?')) { Schema.processes = Schema.processes.filter(p => p.category !== id); delete Schema.categories[id]; refresh(); } }
        function delProc(id) { if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å?')) { Schema.processes = Schema.processes.filter(p => p.id !== id); refresh(); } }

        // Drag and Drop functionality
        let draggedElement = null;

        function handleDragStart(e) {
            const target = e.target.closest('tr') || e.target.closest('th');
            if (!target) return;
            draggedElement = target;
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', ''); // Required for some browsers
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedElement = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            // Highlight target
            const target = e.target.closest('tr') || e.target.closest('th');
            if (target && target !== draggedElement) {
                // Ensure same type of element
                const isProcess = draggedElement.dataset.processId !== undefined;
                const isGroup = draggedElement.dataset.groupId !== undefined;
                const isField = draggedElement.dataset.fieldId !== undefined;

                if ((isProcess && target.classList.contains('th-proc')) ||
                    (isGroup && target.classList.contains('group-row')) ||
                    (isField && target.classList.contains('row-field'))) {
                    target.classList.add('drag-over');
                }
            }
            return false;
        }

        function handleDragLeave(e) {
            const target = e.target.closest('tr') || e.target.closest('th');
            if (target) target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (!draggedElement || draggedElement === this) return false;

            const target = e.target.closest('tr') || e.target.closest('th');
            if (target) target.classList.remove('drag-over');

            const isProduct = draggedElement.dataset.isProduct === 'true';

            // 1. Processes Reordering
            if (draggedElement.dataset.processId && this.dataset.processId) {
                reorderProcesses(draggedElement.dataset.processId, this.dataset.processId);
            }
            // 2. Groups Reordering
            else if (draggedElement.dataset.groupId && this.dataset.groupId) {
                reorderGroups(draggedElement.dataset.groupId, this.dataset.groupId, isProduct);
            }
            // 3. Fields Reordering
            else if (draggedElement.dataset.fieldId && this.dataset.fieldId) {
                reorderFields(draggedElement.dataset.fieldId, this.dataset.fieldId, isProduct);
            }

            return false;
        }

        function reorderProcesses(draggedId, targetId) {
            const draggedIndex = Schema.processes.findIndex(p => p.id === draggedId);
            const targetIndex = Schema.processes.findIndex(p => p.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Maintain category if needed? No, let user move between categories if UI allows.
            // But here processes are in columns, usually we move within same category or between?
            // User just wants to reorder "actions".

            const [removed] = Schema.processes.splice(draggedIndex, 1);
            Schema.processes.splice(targetIndex, 0, removed);

            markDirty();
            renderMatrix();
        }

        function reorderGroups(draggedId, targetId, isProduct) {
            const groups = isProduct ? Schema.products.groups : Schema.groups;
            const draggedIndex = groups.findIndex(g => g.id === draggedId);
            const targetIndex = groups.findIndex(g => g.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            const [removed] = groups.splice(draggedIndex, 1);
            groups.splice(targetIndex, 0, removed);

            markDirty();
            renderMatrix();
        }

        function reorderFields(draggedId, targetId, isProduct) {
            const fields = isProduct ? Schema.products.fields : Schema.fields;
            const draggedIndex = fields.findIndex(f => f.id === draggedId);
            const targetIndex = fields.findIndex(f => f.id === targetId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            const [removed] = fields.splice(draggedIndex, 1);
            fields.splice(targetIndex, 0, removed);

            markDirty();
            renderMatrix();
        }


        function renderMatrix() {
            const cont = document.getElementById('matrixContainer'); cont.innerHTML = '';
            const table = document.createElement('table'); table.className = 'matrix-table';
            const valid = Schema.processes.filter(p => Schema.categories[p.category]);

            // CALCULATE TOTALS
            const procTotals = {};
            const safeAdd = (pid, v) => {
                const n = parseFloat(v);
                if (!isNaN(n)) procTotals[pid] = (procTotals[pid] || 0) + n;
            };
            (Schema.fields || []).forEach(f => {
                if (['number', 'checkbox', 'checkbox_qty', 'select_yes_no'].includes(f.type)) {
                    const r = Schema.rules[f.id];
                    if (r) Object.keys(r).forEach(pid => { if (typeof r[pid] === 'number' || (typeof r[pid] === 'string' && !r[pid].startsWith('='))) safeAdd(pid, r[pid]); });
                } else if ((f.type === 'action_button' || f.type === 'select_modal') && f.modalFields) {
                    f.modalFields.forEach(mf => {
                        if (['number', 'checkbox', 'checkbox_qty', 'select_yes_no'].includes(mf.type)) {
                            const key = `${f.id}_${mf.id}`;
                            const r = Schema.modalFieldRules ? Schema.modalFieldRules[key] : null;
                            if (r) Object.keys(r).forEach(pid => { if (typeof r[pid] === 'number' || (typeof r[pid] === 'string' && !r[pid].startsWith('='))) safeAdd(pid, r[pid]); });
                        }
                    });
                }
            });

            let totalCols = 0;
            Object.keys(Schema.categories).forEach(cid => {
                if (UIState.collapsed.includes(cid)) totalCols++;
                else {
                    const ps = valid.filter(p => p.category === cid);
                    totalCols += Math.max(1, ps.length) + 2; // +1 for Sigma, +1 for Raw
                }
            });

            // HEADER 1
            const h1 = document.createElement('tr'); h1.className = 'sticky-h1';
            const s1 = document.createElement('th'); s1.className = 'col-sticky th-cat'; s1.innerText = '–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ / –ü—Ä–æ—Ü–µ—Å–∏'; h1.appendChild(s1);
            Object.keys(Schema.categories).forEach(cid => {
                const isC = UIState.collapsed.includes(cid); const ps = valid.filter(p => p.category === cid);
                // ColSpan: if open, processes + 2 for (final/formula + raw sum); if collapsed, 1 for sum
                const th = document.createElement('th'); th.className = 'th-cat'; th.colSpan = isC ? 1 : Math.max(1, ps.length) + 2;

                const isHighlighted = UIState.highlightedCat === cid;
                th.style.background = isHighlighted ? '#fde047' : (Schema.categories[cid].color || '#f1f5f9');
                th.style.borderTop = isHighlighted ? '4px solid #fde047' : 'none';
                th.style.boxShadow = isHighlighted ? '0 0 10px rgba(250, 204, 21, 0.5)' : 'none';

                th.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; gap:8px">
                    <button class="btn-mini" onclick="event.stopPropagation(); toggleCat('${cid}')">${isC ? '[+]' : '[-]'} </button>
                    <span style="cursor:pointer; font-weight:700" onclick="event.stopPropagation(); highlightCat('${cid}')">${Schema.categories[cid].name}</span>
                    ${!isC ? `<button class="btn-mini" onclick="event.stopPropagation(); openActionModal('ADD_PROC', '${cid}')">+</button>` : ''}
                    <button class="btn-mini" onclick="event.stopPropagation(); delCat('${cid}')" style="color:red">&times;</button>
                </div>`;
                h1.appendChild(th);
            });
            const abTh = document.createElement('th'); abTh.className = 'th-cat'; abTh.innerHTML = `<button class="btn-mini" onclick="openActionModal('ADD_CAT')">+ –†–û–ó–î–Ü–õ</button>`; h1.appendChild(abTh);
            table.appendChild(h1);

            // HEADER 2
            const h2 = document.createElement('tr'); h2.className = 'sticky-h2';
            const s2 = document.createElement('th'); s2.className = 'col-sticky th-proc'; s2.innerText = '–ù–∞–∑–≤–∞ –¥—ñ—ó'; h2.appendChild(s2);
            Object.keys(Schema.categories).forEach(cid => {
                const isC = UIState.collapsed.includes(cid); const ps = valid.filter(p => p.category === cid);
                if (isC) {
                    // Collapsed: Show Sum Header
                    const th = document.createElement('th'); th.className = 'th-proc td-total-column'; th.style.width = '70px'; th.innerText = 'Œ£'; h2.appendChild(th);
                }
                else if (ps.length === 0) {
                    // Empty category: Total then Placeholder
                    const thTotal = document.createElement('th'); thTotal.className = 'th-proc td-total-column'; thTotal.innerText = 'Œ£'; thTotal.style.width = '70px'; thTotal.style.minWidth = '70px'; h2.appendChild(thTotal);
                    const thRaw = document.createElement('th'); thRaw.className = 'th-proc td-raw-column'; thRaw.innerText = 'Raw'; thRaw.style.width = '70px'; thRaw.style.minWidth = '70px'; h2.appendChild(thRaw);
                    h2.appendChild(Object.assign(document.createElement('th'), { className: 'th-proc', innerHTML: '<div style="text-align:center; opacity:0.3">(–ø—É—Å—Ç–æ)</div>' }));
                }
                else {
                    // Category Sum Headers
                    const thTotal = document.createElement('th'); thTotal.className = 'th-proc td-total-column'; thTotal.innerText = 'Œ£'; thTotal.title = '–ü—ñ–¥—Å—É–º–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è (–∑ —Ñ–æ—Ä–º—É–ª–æ—é)';
                    thTotal.style.width = '70px'; thTotal.style.minWidth = '70px';
                    h2.appendChild(thTotal);

                    const thRaw = document.createElement('th'); thRaw.className = 'th-proc td-raw-column'; thRaw.innerText = 'Raw'; thRaw.title = '–°—É–º–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤ —É —Ä—è–¥–∫—É';
                    thRaw.style.width = '70px'; thRaw.style.minWidth = '70px';
                    h2.appendChild(thRaw);

                    ps.forEach(p => {
                        const isCore = ['pr_design', 'pr_construction', 'pr_assembly', 'pr_install'].includes(p.id);
                        const delBtn = isCore ? '' : `<button class="btn-mini" onclick="delProc('${p.id}')" style="opacity:0.2;border:none">&times;</button>`;
                        const th = document.createElement('th'); th.className = 'th-proc';
                        th.draggable = true;
                        th.dataset.processId = p.id;
                        th.style.width = '70px'; th.style.minWidth = '70px';

                        th.addEventListener('dragstart', handleDragStart);
                        th.addEventListener('dragend', handleDragEnd);
                        th.addEventListener('dragover', handleDragOver);
                        th.addEventListener('drop', handleDrop);
                        th.addEventListener('dragleave', handleDragLeave);

                        th.innerHTML = `
                            <div style="display:flex; flex-direction:column; align-items:center; gap:2px">
                                <div style="display:flex; align-items:center; justify-content:center; gap:4px">
                                    <span class="drag-handle" style="opacity:0.2; cursor:grab; font-size:10px">‚ò∞</span>
                                    <span style="cursor:pointer" onclick="openActionModal('RENAME_PROC', '${p.id}')">${p.name}</span>${delBtn}
                                </div>
                            </div>`;
                        h2.appendChild(th);
                    });
                }
            });
            // Removed Global Total Header
            h2.appendChild(document.createElement('th')); table.appendChild(h2);

            const renderGroup = (g, fSrc, isP) => {
                const grRow = document.createElement('tr');
                grRow.className = 'group-row draggable-row';
                grRow.id = `group-${g.id}`;
                grRow.draggable = true;
                grRow.dataset.groupId = g.id;
                grRow.dataset.isProduct = isP;

                grRow.addEventListener('dragstart', handleDragStart);
                grRow.addEventListener('dragend', handleDragEnd);
                grRow.addEventListener('dragover', handleDragOver);
                grRow.addEventListener('drop', handleDrop);
                grRow.addEventListener('dragleave', handleDragLeave);

                // Group Name Cell
                const nameTd = document.createElement('td');
                nameTd.className = 'col-sticky';
                const isCollapsed = UIState.collapsedGroups.includes(g.id);
                nameTd.innerHTML = `
                    <div style="display:flex; align-items:center; gap:8px">
                        <span class="drag-handle" title="–ü–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ –≥—Ä—É–ø—É" style="opacity:0.2; cursor:grab">‚ò∞</span>
                        <span class="collapse-btn" onclick="toggleGroup('${g.id}')">${isCollapsed ? '‚ñ∂' : '‚ñº'}</span>
                        <span style="cursor:pointer; flex:1" onclick="openActionModal('RENAME_GROUP', '${g.id}', ${isP})">${g.title}</span>
                        <button class="gear-btn" onclick="event.stopPropagation(); openGroupSettingsModal('${g.id}', ${isP})" style="background:none; border:none; cursor:pointer; opacity:0.4; transition:opacity 0.2s; font-size:16px; padding:2px 6px" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä—É–ø–∏">‚öôÔ∏è</button>
                        <button class="group-delete-btn" onclick="event.stopPropagation(); delGroup('${g.id}',${isP})" style="background:none; border:none; color:#ef4444; cursor:pointer; opacity:0.4; transition:opacity 0.2s; font-size:16px; padding:2px 6px" title="–í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä—É–ø—É">üóëÔ∏è</button>
                    </div>
                `;
                grRow.appendChild(nameTd);

                // Group Total Calculation PER CATEGORY
                Object.keys(Schema.categories).forEach(cid => {
                    const isC = UIState.collapsed.includes(cid);
                    const ps = valid.filter(p => p.category === cid);

                    // Calculate Sum for this Category
                    let catSum = 0;
                    // iterate all processes in category to get total sum
                    valid.filter(p => p.category === cid).forEach(p => {
                        fSrc.filter(f => f.groupId === g.id).forEach(f => {
                            let val = 0;
                            if (['number', 'checkbox', 'checkbox_qty', 'select_yes_no'].includes(f.type)) {
                                val = getVal(f.id, p.id);
                            } else if ((f.type === 'action_button' || f.type === 'select_modal') && f.modalFields) {
                                f.modalFields.forEach(mf => {
                                    if (['number', 'checkbox', 'checkbox_qty'].includes(mf.type)) {
                                        let v = getModalFieldVal(f.id, mf.id, p.id);
                                        val += Number(v) || 0;
                                    }
                                });
                            }
                            if (typeof val === 'number') catSum += val;
                            else if (typeof val === 'string' && !val.startsWith('=')) catSum += Number(val) || 0;
                        });
                    });

                    if (isC) {
                        // Collapsed: Empty sum
                        grRow.appendChild(Object.assign(document.createElement('td'), { style: 'background:#f8fafc' }));
                    }
                    else if (ps.length === 0) {
                        // Empty Cat: Total then Raw then Placeholder
                        grRow.appendChild(Object.assign(document.createElement('td'), { style: 'background:#fef2f2' })); // Œ£
                        grRow.appendChild(Object.assign(document.createElement('td'), { style: 'background:#f8fafc' })); // Raw
                        grRow.appendChild(document.createElement('td'));
                    }
                    else {
                        // Open: Empty Total and Raw for Group Rows
                        grRow.appendChild(Object.assign(document.createElement('td'), { style: 'background:#fff1f2' })); // Œ£
                        grRow.appendChild(Object.assign(document.createElement('td'), { style: 'background:#f8fafc' })); // Raw

                        // Then Processes
                        ps.forEach(p => {
                            const td = document.createElement('td');
                            td.innerHTML = '';
                            grRow.appendChild(td);
                        });
                    }
                });

                // Delete button is now in the group name cell

                // Drag events for groups and delete button visibility
                grRow.onmouseenter = () => {
                    grRow.querySelector('.drag-handle').style.opacity = '1';
                    const deleteBtn = grRow.querySelector('.group-delete-btn');
                    if (deleteBtn) deleteBtn.style.opacity = '1';
                };
                grRow.onmouseleave = () => {
                    grRow.querySelector('.drag-handle').style.opacity = '0.1';
                    const deleteBtn = grRow.querySelector('.group-delete-btn');
                    if (deleteBtn) deleteBtn.style.opacity = '0.4';
                };

                // Empty cell for the last column (to match header and field rows)
                grRow.appendChild(document.createElement('td'));

                table.appendChild(grRow);

                if (isCollapsed) return;

                fSrc.filter(f => f.groupId === g.id).forEach(f => {
                    const fRow = document.createElement('tr');
                    fRow.className = 'row-field draggable-row';
                    fRow.dataset.fieldId = f.id;
                    fRow.dataset.isProduct = isP;
                    fRow.draggable = true;

                    fRow.addEventListener('dragstart', handleDragStart);
                    fRow.addEventListener('dragend', handleDragEnd);
                    fRow.addEventListener('dragover', handleDragOver);
                    fRow.addEventListener('drop', handleDrop);
                    fRow.addEventListener('dragleave', handleDragLeave);

                    // Row Label with drag handle
                    const labelTd = document.createElement('td');
                    labelTd.className = 'col-sticky';
                    labelTd.innerHTML = `
                        <div style="display:flex; align-items:center; gap:6px; width:100%">
                            <span class="drag-handle" style="opacity:0.2; cursor:grab" title="–ü–µ—Ä–µ—Ç—è–≥–Ω—É—Ç–∏ —Ä—è–¥–æ–∫">‚ò∞</span>
                            <span style="font-size:8px; opacity:0.3; min-width:20px">${f.type.substring(0, 3)}</span>
                            <input class="cell-input" style="text-align:left; font-weight:700; flex:1; width:0; min-width:50px" value="${f.label}" onfocus="this.select()" onchange="updFLab('${f.id}',this.value,${isP})">
                            <button onclick="event.stopPropagation(); openFModal('${f.id}',${isP})" class="gear-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è">‚öôÔ∏è</button>
                            <button onclick="event.stopPropagation(); delField('${f.id}',${isP})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:16px; padding:2px 6px; transition:0.2s" onmouseover="this.style.color='#dc2626'; this.style.transform='scale(1.2)'" onmouseout="this.style.color='#ef4444'; this.style.transform='scale(1)'" title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ª–µ">‚ùå</button>
                        </div>`;
                    fRow.appendChild(labelTd);

                    Object.keys(Schema.categories).forEach(cid => {
                        const isC = UIState.collapsed.includes(cid); const ps = valid.filter(p => p.category === cid);

                        // Calculate sum for this field in this category
                        let catSum = 0;
                        valid.filter(p => p.category === cid).forEach(p => {
                            let val = 0;
                            if (['number', 'checkbox', 'checkbox_qty', 'select_yes_no'].includes(f.type)) {
                                val = getVal(f.id, p.id);
                            } else if ((f.type === 'action_button' || f.type === 'select_modal') && f.modalFields) {
                                f.modalFields.forEach(mf => {
                                    if (['number', 'checkbox', 'checkbox_qty'].includes(mf.type)) {
                                        let v = getModalFieldVal(f.id, mf.id, p.id);
                                        val += Number(v) || 0;
                                    }
                                });
                            }
                            if (typeof val === 'number') catSum += val;
                            else if (typeof val === 'string' && !val.startsWith('=')) catSum += Number(val) || 0;
                        });

                        if (isC) {
                            // Collapsed: Show only Total
                            const td = document.createElement('td');
                            td.className = 'td-total-column'; td.style.textAlign = 'center'; td.style.color = '#3b82f6'; td.style.fontWeight = '600';
                            td.innerText = catSum > 0 ? catSum.toLocaleString() : '';
                            fRow.appendChild(td);
                        } else {
                            // Open Category

                            // 1. Total (Formula) Cell
                            const tdTotal = renderTotalCell(f.id, cid, catSum, null, isP);
                            fRow.appendChild(tdTotal);

                            // 2. Raw Sum Cell
                            const tdRaw = document.createElement('td');
                            tdRaw.className = 'td-raw-column';
                            tdRaw.style.textAlign = 'center';
                            tdRaw.style.fontSize = '10px';
                            tdRaw.style.color = '#64748b';
                            tdRaw.innerText = catSum > 0 ? catSum.toLocaleString() : '0';
                            fRow.appendChild(tdRaw);

                            if (ps.length === 0) {
                                // Placeholder for empty category
                                fRow.appendChild(Object.assign(document.createElement('td'), { innerHTML: '' }));
                            } else {
                                // Then Processes
                                ps.forEach(p => {
                                    const td = document.createElement('td');
                                    td.dataset.fieldId = f.id;
                                    td.dataset.processId = p.id;
                                    td.dataset.isModal = 'false';

                                    const rawVal = (Schema.rules && Schema.rules[f.id] && Schema.rules[f.id][p.id]);
                                    if (f.type === 'action_button' || f.type === 'select_modal') {
                                        td.innerHTML = `<div style="text-align:center; color:#ccc; font-size:10px">‚Äî</div>`;
                                    } else if (f.type === 'select') {
                                        td.innerHTML = `<div style="text-align:center; color:#ccc; font-size:10px">ABC</div>`;
                                    } else {
                                        const cellInp = renderCellInput(
                                            rawVal,
                                            (newVal) => updRule(f.id, p.id, null, newVal),
                                            () => openFormulaModal(`–ü–æ–ª–µ: "${f.label}" | –ü—Ä–æ—Ü–µ—Å: "${p.name}"`, rawVal, (newVal) => updRule(f.id, p.id, null, newVal)),
                                            (isOnce) => updRule(f.id, p.id, null, isOnce, true),
                                            f.type
                                        );
                                        td.appendChild(cellInp);
                                    }

                                    // Ensure selection highlight even for non-input cells
                                    const isSel = UIState.selectedCells.some(c => c.fId === f.id && c.pId === p.id && !c.oV && !c.mfId);
                                    if (isSel) {
                                        td.classList.add('selected-cell');
                                        td.style.backgroundColor = '#10b981';
                                        td.style.color = '#ffffff';
                                        const inp = td.querySelector('input');
                                        if (inp) inp.style.color = '#ffffff';
                                    }

                                    fRow.appendChild(td);
                                });
                            }
                        }
                    });

                    // NO Global Total Cell
                    fRow.appendChild(document.createElement('td'));
                    table.appendChild(fRow);

                    if (f.type === 'select' || f.type === 'multiselect') {
                        if (f.options) {
                            f.options.forEach(o => {
                                const oRow = document.createElement('tr'); const olc = document.createElement('td'); olc.className = 'col-sticky'; olc.style.paddingLeft = '30px'; olc.style.background = '#fff';
                                olc.innerHTML = `‚àü <input class="cell-input" style="width:auto; text-align:left" value="${o.label}" onfocus="this.select()" onchange="updOLab('${f.id}','${o.value}',this.value,${isP})"><button onclick="delOpt('${f.id}','${o.value}',${isP})" style="opacity:0.2; background:none; border:none">&times;</button>`;
                                oRow.appendChild(olc);
                                Object.keys(Schema.categories).forEach(cid => {
                                    const isC = UIState.collapsed.includes(cid); const ps = valid.filter(p => p.category === cid);

                                    // Calculate Total for this option in this category
                                    let catSum = 0;
                                    valid.filter(p => p.category === cid).forEach(p => {
                                        const val = getVal(f.id, p.id, o.value);
                                        if (typeof val === 'number') catSum += val;
                                        else if (typeof val === 'string' && !val.startsWith('=')) catSum += Number(val) || 0;
                                    });

                                    if (isC) {
                                        // Collapsed: Show only Total
                                        const td = document.createElement('td');
                                        td.style.background = '#f8fafc';
                                        td.style.textAlign = 'center';
                                        td.style.color = '#3b82f6';
                                        td.style.fontWeight = '600';
                                        td.innerText = catSum > 0 ? catSum.toLocaleString() : '';
                                        oRow.appendChild(td);
                                    } else if (ps.length === 0) {
                                        // Empty Cat: Total then Raw then Placeholder
                                        oRow.appendChild(document.createElement('td'));
                                        oRow.appendChild(document.createElement('td'));
                                        oRow.appendChild(document.createElement('td'));
                                    } else {
                                        // Open: Total FIRST, then Raw, then processes
                                        const tdTotal = renderTotalCell(f.id, cid, catSum, o.value, isP);
                                        oRow.appendChild(tdTotal);

                                        const tdRaw = document.createElement('td');
                                        tdRaw.style.background = '#f8fafc';
                                        tdRaw.style.textAlign = 'center';
                                        tdRaw.style.fontSize = '10px';
                                        tdRaw.style.color = '#64748b';
                                        tdRaw.innerText = catSum > 0 ? catSum.toLocaleString() : '0';
                                        oRow.appendChild(tdRaw);

                                        ps.forEach(p => {
                                            const td = document.createElement('td');
                                            td.dataset.fieldId = f.id;
                                            td.dataset.processId = p.id;
                                            td.dataset.optionValue = o.value;
                                            td.dataset.isModal = 'false';

                                            const isSel = UIState.selectedCells.some(c => c.fId === f.id && c.pId === p.id && c.oV === o.value && !c.mfId);
                                            if (isSel) {
                                                td.classList.add('selected-cell');
                                                td.style.backgroundColor = '#10b981';
                                                td.style.color = '#ffffff';
                                                const inp = td.querySelector('input');
                                                if (inp) inp.style.color = '#ffffff';
                                            }

                                            const val = getVal(f.id, p.id, o.value);
                                            const cellInp = renderCellInput(
                                                val,
                                                (newVal) => updRule(f.id, p.id, o.value, newVal),
                                                () => openFormulaModal(`–ü–æ–ª–µ: "${f.label}" | –í–∞—Ä—ñ–∞–Ω—Ç: "${o.label}" | –ü—Ä–æ—Ü–µ—Å: "${p.name}"`, val, (newVal) => updRule(f.id, p.id, o.value, newVal)),
                                                null,
                                                f.type
                                            );
                                            td.appendChild(cellInp);
                                            oRow.appendChild(td);
                                        });
                                    }
                                });
                                oRow.appendChild(document.createElement('td')); table.appendChild(oRow);
                            });
                        }
                        const optAdd = document.createElement('tr');
                        optAdd.innerHTML = `<td class="col-sticky" style="padding-left:45px"><div class="add-row-hint" onclick="addOpt('${f.id}',${isP})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç –≤–∏–±–æ—Ä—É</div></td><td colspan="${totalCols}"></td><td></td>`;
                        table.appendChild(optAdd);
                    }


                    // Add modalFields as full rows with process columns
                    if (f.type === 'action_button' || f.type === 'select_modal') {
                        // Header row for modal fields section
                        const modalHeaderRow = document.createElement('tr');
                        const modalHeaderTd = document.createElement('td');
                        modalHeaderTd.className = 'col-sticky';
                        modalHeaderTd.colSpan = totalCols + 2;
                        modalHeaderTd.style.background = '#f0f9ff';
                        modalHeaderTd.style.padding = '8px 20px';
                        modalHeaderTd.style.borderTop = '2px solid #0ea5e9';
                        modalHeaderTd.innerHTML = `<div style="font-size:11px; font-weight:600; color:#0284c7">üìä –ü–û–õ–Ø –ú–û–î–ê–õ–ö–ò –¥–ª—è "${f.label || f.default}"</div>`;
                        modalHeaderRow.appendChild(modalHeaderTd);
                        table.appendChild(modalHeaderRow);

                        // Render each modal field if they exist
                        if (f.modalFields && f.modalFields.length > 0) {
                            f.modalFields.forEach((mf, mfIdx) => {
                                const mfRow = document.createElement('tr');
                                mfRow.style.background = '#fff';

                                const mfLc = document.createElement('td');
                                mfLc.className = 'col-sticky';
                                mfLc.style.paddingLeft = '40px';
                                mfLc.style.background = '#fff';
                                const typeIcon = { 'number': 'üî¢', 'select': 'üìã', 'multiselect': 'üìë', 'multiselect_qty': 'üìã', 'checkbox_qty': '‚òëÔ∏è', 'checkbox': '‚úÖ', 'select_yes_no': 'üîΩ' }[mf.type] || 'üéØ';
                                mfLc.innerHTML = `<div style="display:flex; align-items:center; gap:6px; width:100%"><span style="font-size:10px; opacity:0.6" title="${mf.type}">${typeIcon}</span><input class="cell-input" style="text-align:left; font-weight:600; font-size:12px; flex:1; width:0; min-width:50px" value="${mf.label}" onfocus="this.select()" onchange="updModalFieldLabel('${f.id}', ${mfIdx}, this.value, ${isP})"><button onclick="event.stopPropagation(); changeModalFieldType('${f.id}', ${mfIdx}, ${isP})" class="gear-btn" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è" style="background:none; border:none; cursor:pointer; font-size:14px; padding:2px 4px; opacity:0.4" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.4'">‚öôÔ∏è</button><button onclick="event.stopPropagation(); delModalField('${f.id}', ${mfIdx}, ${isP})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:14px; padding:2px 6px; opacity:0.6" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'" title="–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–ª–µ –∑ –º–æ–¥–∞–ª–∫–∏">‚ùå</button></div>`;
                                mfRow.appendChild(mfLc);

                                // Add process columns for modal field (WITH TOTALS)
                                Object.keys(Schema.categories).forEach(cid => {
                                    const isC = UIState.collapsed.includes(cid);
                                    const ps = valid.filter(p => p.category === cid);

                                    // Calculate Total for this Modal Field in this Category
                                    let catSum = 0;
                                    valid.filter(p => p.category === cid).forEach(p => {
                                        const val = getModalFieldVal(f.id, mf.id, p.id);
                                        if (typeof val === 'number') catSum += val;
                                        else if (typeof val === 'string' && !val.startsWith('=')) catSum += Number(val) || 0;
                                    });

                                    if (isC) {
                                        // Collapsed: Show only Total
                                        const td = document.createElement('td');
                                        td.style.background = '#f8fafc';
                                        td.style.textAlign = 'center';
                                        td.style.color = '#3b82f6';
                                        td.style.fontWeight = '600';
                                        td.innerText = catSum > 0 ? catSum.toLocaleString() : '';
                                        mfRow.appendChild(td);
                                    } else {
                                        // Open Category Summary
                                        const tdTotal = renderTotalCell(f.id, cid, catSum, null, isP, true); // true for isModal
                                        mfRow.appendChild(tdTotal);

                                        const tdRaw = document.createElement('td');
                                        tdRaw.style.background = '#f8fafc';
                                        tdRaw.style.textAlign = 'center';
                                        tdRaw.style.fontSize = '10px';
                                        tdRaw.style.color = '#64748b';
                                        tdRaw.innerText = catSum > 0 ? catSum.toLocaleString() : '0';
                                        mfRow.appendChild(tdRaw);

                                        if (ps.length === 0) {
                                            mfRow.appendChild(Object.assign(document.createElement('td'), { innerHTML: '' }));
                                        } else {
                                            // Then Process inputs
                                            ps.forEach(p => {
                                                const td = document.createElement('td');
                                                td.dataset.fieldId = f.id;
                                                td.dataset.mfId = mf.id;
                                                td.dataset.processId = p.id;
                                                td.dataset.isModal = 'true';

                                                const isSel = UIState.selectedCells.some(c => c.fId === f.id && c.pId === p.id && c.mfId === mf.id);
                                                if (isSel) {
                                                    td.classList.add('selected-cell');
                                                    td.style.backgroundColor = '#10b981';
                                                    td.style.color = '#ffffff';
                                                    const inp = td.querySelector('input');
                                                    if (inp) inp.style.color = '#ffffff';
                                                }

                                                const val = getModalFieldVal(f.id, mf.id, p.id);
                                                const cellInp = renderCellInput(
                                                    val,
                                                    (newVal) => updModalFieldRule(f.id, mf.id, p.id, newVal, isP),
                                                    () => openFormulaModal(`–ü–æ–ª–µ –º–æ–¥–∞–ª–∫–∏: "${mf.label}" | –ü—Ä–æ—Ü–µ—Å: "${p.name}"`, val, (newVal) => updModalFieldRule(f.id, mf.id, p.id, newVal, isP)),
                                                    (isOnce) => updModalFieldRule(f.id, mf.id, p.id, isOnce, isP, true),
                                                    mf.type
                                                );
                                                td.appendChild(cellInp);
                                                mfRow.appendChild(td);
                                            });
                                        }
                                    }
                                });

                                mfRow.appendChild(document.createElement('td'));
                                table.appendChild(mfRow);

                                // Add option rows for select and multiselect type modal fields
                                if (mf.type === 'select' || mf.type === 'multiselect' || mf.type === 'multiselect_qty') {
                                    if (mf.options) {
                                        mf.options.forEach((opt, optIdx) => {
                                            const optRow = document.createElement('tr');
                                            optRow.style.background = '#fafbff';
                                            const optLc = document.createElement('td');
                                            optLc.className = 'col-sticky';
                                            optLc.style.paddingLeft = '60px';
                                            optLc.style.background = '#fafafa';
                                            optLc.innerHTML = `‚àü <input class="cell-input" style="width:auto; text-align:left" value="${opt.label}" onfocus="this.select()" onchange="updModalFieldOptionLabel('${f.id}', ${mfIdx}, '${opt.value}', this.value, ${isP})"><button onclick="delModalFieldOption('${f.id}', ${mfIdx}, '${opt.value}', ${isP})" style="opacity:0.2; background:none; border:none; cursor:pointer">&times;</button>`;
                                            optRow.appendChild(optLc);

                                            // Add process columns for option (WITH TOTALS)
                                            Object.keys(Schema.categories).forEach(cid => {
                                                const isC = UIState.collapsed.includes(cid);
                                                const ps = valid.filter(p => p.category === cid);

                                                // Calculate Total for this Option
                                                let catSum = 0;
                                                valid.filter(p => p.category === cid).forEach(p => {
                                                    const val = getModalFieldOptionVal(f.id, mf.id, opt.value, p.id);
                                                    if (typeof val === 'number') catSum += val;
                                                    else if (typeof val === 'string' && !val.startsWith('=')) catSum += Number(val) || 0;
                                                });

                                                if (isC) {
                                                    const td = document.createElement('td');
                                                    td.style.background = '#f8fafc'; td.style.textAlign = 'center'; td.style.color = '#3b82f6'; td.style.fontWeight = '600';
                                                    td.innerText = catSum > 0 ? catSum.toLocaleString() : '';
                                                    optRow.appendChild(td);
                                                } else {
                                                    // Total First, then Raw
                                                    const tdTotal = renderTotalCell(f.id, cid, catSum, opt.value, isP, true);
                                                    optRow.appendChild(tdTotal);

                                                    const tdRaw = document.createElement('td');
                                                    tdRaw.style.background = '#f8fafc';
                                                    tdRaw.style.textAlign = 'center';
                                                    tdRaw.style.fontSize = '10px';
                                                    tdRaw.style.color = '#64748b';
                                                    tdRaw.innerText = catSum > 0 ? catSum.toLocaleString() : '0';
                                                    optRow.appendChild(tdRaw);

                                                    if (ps.length === 0) {
                                                        optRow.appendChild(Object.assign(document.createElement('td'), { innerHTML: '' }));
                                                    } else {
                                                        ps.forEach(p => {
                                                            const td = document.createElement('td');
                                                            td.dataset.fieldId = f.id;
                                                            td.dataset.mfId = mf.id;
                                                            td.dataset.optionValue = opt.value;
                                                            td.dataset.processId = p.id;
                                                            td.dataset.isModal = 'true';

                                                            const isSel = UIState.selectedCells.some(c => c.fId === f.id && c.pId === p.id && c.mfId === mf.id && c.oV === opt.value);
                                                            if (isSel) {
                                                                td.classList.add('selected-cell');
                                                                td.style.backgroundColor = '#10b981';
                                                                td.style.color = '#ffffff';
                                                                const inp = td.querySelector('input');
                                                                if (inp) inp.style.color = '#ffffff';
                                                            }

                                                            const val = getModalFieldOptionVal(f.id, mf.id, opt.value, p.id);
                                                            const cellInp = renderCellInput(
                                                                val,
                                                                (newVal) => updModalFieldOptionRule(f.id, mf.id, opt.value, p.id, newVal, isP),
                                                                () => openFormulaModal(`–ü–æ–ª–µ –º–æ–¥–∞–ª–∫–∏: "${mf.label}" | –í–∞—Ä—ñ–∞–Ω—Ç: "${opt.label}" | –ü—Ä–æ—Ü–µ—Å: "${p.name}"`, val, (newVal) => updModalFieldOptionRule(f.id, mf.id, opt.value, p.id, newVal, isP)),
                                                                (isOnce) => updModalFieldOptionRule(f.id, mf.id, opt.value, p.id, isOnce, isP, true),
                                                                mf.type
                                                            );
                                                            td.appendChild(cellInp);
                                                            optRow.appendChild(td);
                                                        });
                                                    }
                                                }
                                            }); // End categories forEach
                                            optRow.appendChild(document.createElement('td'));
                                            table.appendChild(optRow);
                                        }); // End options forEach
                                    }

                                    // Add option button
                                    const addOptRow = document.createElement('tr');
                                    addOptRow.innerHTML = `<td class="col-sticky" style="padding-left:75px; background:#fafbff"><div class="add-row-hint" onclick="addModalFieldOption('${f.id}', ${mfIdx}, ${isP})">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç –≤–∏–±–æ—Ä—É</div></td><td colspan="${totalCols + 1}"></td>`;
                                    table.appendChild(addOptRow);
                                } // End if select/multiselect
                            }); // End modalFields.forEach
                        } // End if modalFields exists

                        // Add button row for adding new modal fields
                        const addMfRow = document.createElement('tr');
                        addMfRow.innerHTML = `<td class="col-sticky" style="padding:10px 40px; background:#f0f9ff"><div class="add-row-hint" onclick="addModalField('${f.id}', ${isP})" style="background:#e0f2fe; border:1px dashed #0ea5e9; color:#0284c7; text-align:center; padding:10px">+ –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ –≤ –º–æ–¥–∞–ª–∫—É</div></td><td colspan="${totalCols + 1}"></td>`;
                        table.appendChild(addMfRow);
                    } // End if action_button
                }); // End fields.forEach

                const addFRow = document.createElement('tr');
                addFRow.innerHTML = `<td class="col-sticky"><div class="add-row-hint" style="background:#f1f5f9; border:1px dashed #cbd5e1; margin:5px" onclick="addF('${g.id}',${isP})">+ –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –ø–æ–ª–µ (–¥—ñ—é) —É –≥—Ä—É–ø—É "${g.title}"</div></td><td colspan="${totalCols}"></td><td></td>`;
                table.appendChild(addFRow);
            }; // End renderGroup

            // Actually render all groups
            Schema.groups.forEach(g => renderGroup(g, Schema.fields, false));
            if (Schema.products) Schema.products.groups.forEach(g => renderGroup(g, Schema.products.fields, true));

            // Add global selection listeners
            table.onmousedown = (e) => startSelection(e);
            table.onmouseover = (e) => continueSelection(e);
            window.onmouseup = (e) => endSelection(e);

            cont.appendChild(table);
        } // End renderMatrix

        function startSelection(e) {
            // [FIX] Ignore clicks on interactive elements to let them handle their own events
            const isInteractive = e.target.closest('button') ||
                e.target.closest('.btn-mini') ||
                e.target.closest('.formula-btn') ||
                e.target.closest('.gear-btn') ||
                e.target.closest('.collapse-btn') ||
                e.target.closest('.add-row-hint') ||
                e.target.closest('.drag-hint') ||
                e.target.closest('.drag-handle');
            if (isInteractive) return;

            const td = e.target.closest('td');
            const isInput = e.target.closest('input');
            const isCtrl = e.ctrlKey || e.metaKey;

            if (!td || !td.dataset.fieldId) {
                if (!isCtrl && UIState.selectedCells.length > 0) {
                    UIState.selectedCells = [];
                    renderMatrix();
                }
                return;
            }

            const isAlreadySelected = UIState.selectedCells.some(c =>
                c.fId === td.dataset.fieldId &&
                c.pId === td.dataset.processId &&
                c.oV === (td.dataset.optionValue || null) &&
                c.mfId === (td.dataset.mfId || null)
            );

            if (!isInput) document.body.style.userSelect = 'none';

            // –Ø–∫—â–æ Ctrl –ù–ï –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ ‚Äî —Å–∫–∏–¥–∞—î–º–æ –≤—Å–µ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è
            if (!isCtrl) {
                const wasEmpty = UIState.selectedCells.length === 0;

                // [FIX] –Ø–∫—â–æ –º–∏ –∫–ª—ñ–∫–∞—î–º–æ –≤ —ñ–Ω–ø—É—Ç, —è–∫–∏–π –í–ñ–ï –≤–∏–¥—ñ–ª–µ–Ω–∏–π ‚Äî –Ω–µ —Å–∫–∏–¥–∞—î–º–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è!
                // –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å —Å–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≥—Ä—É–ø–æ–≤–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—é –≤ onchange.
                if (isInput && isAlreadySelected) {
                    // –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ –∫–ª—ñ–∫–Ω—É–ª–∏ –≤ —ñ–Ω–ø—É—Ç, —è–∫–∏–π —É–∂–µ –≤–∏–¥—ñ–ª–µ–Ω–∏–π, –∑–∞–ª–∏—à–∞—î–º–æ –º–∞—Å–∏–≤ —è–∫ —î
                } else {
                    UIState.selectedCells = [];
                }

                // [FIX] –†—É—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è —Å—Ç–∏–ª—ñ–≤, —è–∫—â–æ –º–∏ –Ω–µ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –º–∞—Ç—Ä–∏—Ü—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏ –∫–ª—ñ–∫—É –≤ —ñ–Ω–ø—É—Ç)
                if (!wasEmpty) {
                    document.querySelectorAll('.selected-cell').forEach(td => {
                        td.classList.remove('selected-cell');
                        td.style.backgroundColor = '';
                        td.style.color = '';
                        const inp = td.querySelector('input');
                        if (inp) {
                            inp.style.backgroundColor = '';
                            inp.style.color = '';
                        }
                    });
                }

                if (!wasEmpty && !isInput) renderMatrix();
                UIState.isSelecting = false; // –ë–µ–∑ Ctrl —Ä–µ–∂–∏–º "–º–∞–ª—é–≤–∞–Ω–Ω—è" –≤–∏–¥—ñ–ª–µ–Ω–Ω—è –ù–ï –≤–º–∏–∫–∞—î—Ç—å—Å—è
            } else {
                UIState.isSelecting = true;
                toggleCellSelection(td);
            }
        }

        function continueSelection(e) {
            if (!UIState.isSelecting) return;
            const td = e.target.closest('td');
            if (td && td.dataset.fieldId) toggleCellSelection(td, true);
        }

        function endSelection(e) {
            if (!UIState.isSelecting) return;
            UIState.isSelecting = false;
            document.body.style.userSelect = ''; // Re-enable selection
        }

        function toggleCellSelection(td, forceAdd = false) {
            const cell = {
                fId: td.dataset.fieldId,
                pId: td.dataset.processId,
                oV: td.dataset.optionValue || null,
                mfId: td.dataset.mfId || null,
                isModal: td.dataset.isModal === 'true'
            };
            const idx = UIState.selectedCells.findIndex(c => c.fId === cell.fId && c.pId === cell.pId && c.oV === cell.oV && c.mfId === cell.mfId);

            if (idx === -1) {
                UIState.selectedCells.push(cell);
                td.classList.add('selected-cell');
                // Force inline style as last resort
                td.style.backgroundColor = '#10b981';
                td.style.color = '#ffffff';
                const inp = td.querySelector('input');
                if (inp) {
                    inp.style.backgroundColor = 'transparent';
                    inp.style.color = '#ffffff';
                }
            } else if (!forceAdd) {
                UIState.selectedCells.splice(idx, 1);
                td.classList.remove('selected-cell');
                td.style.backgroundColor = '';
                td.style.color = '';
                const inp = td.querySelector('input');
                if (inp) {
                    inp.style.backgroundColor = '';
                    inp.style.color = '';
                }
            }
        }

        function handleRowDragStart(e) {
            const row = e.target.closest('tr');
            handleDragStart({ target: row, dataTransfer: e.dataTransfer });
        }


        function highlightCat(cid) {
            if (UIState.highlightedCat === cid) UIState.highlightedCat = null;
            else UIState.highlightedCat = cid;
            renderMatrix();
        }

        function toggleCat(cid) {
            const idx = UIState.collapsed.indexOf(cid);
            if (idx === -1) UIState.collapsed.push(cid);
            else UIState.collapsed.splice(idx, 1);
            renderMatrix();
        }
        function openFormulaModal(title, val, saveFn) {
            document.getElementById('formulaDesc').innerText = title;
            document.getElementById('formulaInput').value = val || '';
            document.getElementById('formulaTemplate').value = '';
            formulaSaveFn = saveFn;
            document.getElementById('formulaModal').style.display = 'flex';
            updateFormulaPreview();
            setTimeout(() => document.getElementById('formulaInput').focus(), 100);
        }

        function applyFormulaTemplate(val) {
            const input = document.getElementById('formulaInput');
            const templates = {
                'linear': '=@qty * 5',
                'maxlimit': '=min(@qty, 2) * 15',
                'base_plus': '=10 + (@qty * 0.5)',
                'base_plus': '=10 + (@qty * 0.5)',
                'tiered': '=@qty <= 5 ? @qty * 10 : 5 * 10 + (@qty - 5) * 8',
                'grad_5_7_9': '= val == 0 ? 0 : val <= 5 ? 5 : val <= 10 ? 7 : val <= 15 ? 9 : 11',
                'fixed': '=50 + (@qty - 1) * 20',
                'percent': '=@sum_zbira * 0.15'
            };
            if (templates[val]) {
                input.value = templates[val];
                updateFormulaPreview();
            }
        }

        function updateFormulaPreview() {
            const formula = document.getElementById('formulaInput').value;
            const testValues = [1, 5, 10, 20];

            if (!formula.startsWith('=')) {
                testValues.forEach(qty => {
                    document.getElementById(`prev_${qty}`).innerText = '-';
                    document.getElementById(`prev_${qty}`).style.color = '#94a3b8';
                });
                return;
            }

            testValues.forEach(qty => {
                try {
                    const result = evaluateFormulaPreview(formula, qty);
                    document.getElementById(`prev_${qty}`).innerText = result;
                    document.getElementById(`prev_${qty}`).style.color = '#10b981';
                    document.getElementById(`prev_${qty}`).style.fontWeight = '700';
                } catch (e) {
                    document.getElementById(`prev_${qty}`).innerText = '–ü–æ–º–∏–ª–∫–∞';
                    document.getElementById(`prev_${qty}`).style.color = '#ef4444';
                }
            });
        }

        function evaluateFormulaPreview(formula, qty) {
            let expr = formula.substring(1).trim();
            if (!expr) return 0;

            // Replacing variables. Order matters! 
            // Longest first to avoid partial replacements (e.g. @sum_ vs @sum)

            // 1. Handle @sum_cat... or @sum_konst... (Global category sums)
            expr = expr.replace(/@sum_[a-z0-9_]+/g, '1000');

            // 2. Handle @raw (Raw points of this row)
            expr = expr.replace(/@raw/g, '1000');

            // 3. Handle @sum (Points of row * qty)
            expr = expr.replace(/@sum/g, (1000 * qty).toString());

            // 4. Handle @qty / val
            expr = expr.replace(/@qty/g, qty);
            expr = expr.replace(/\bval\b/g, qty);

            // Replace common math functions
            expr = expr.replace(/min\(/g, 'Math.min(').replace(/max\(/g, 'Math.max(');
            expr = expr.replace(/ceil\(/g, 'Math.ceil(').replace(/floor\(/g, 'Math.floor(').replace(/round\(/g, 'Math.round(');

            // Safe evaluation via Function constructor
            try {
                const res = new Function(`return (${expr})`)();
                return isNaN(res) ? 0 : Number(res.toFixed(2));
            } catch (err) {
                throw err;
            }
        }

        function saveFormula() {
            const val = document.getElementById('formulaInput').value.trim();
            if (formulaSaveFn) formulaSaveFn(val);
            closeModal('formulaModal');
        }

        function getVal(fI, pI, oV) {
            const r = Schema.rules[fI];
            if (!r) return 0;
            let v = 0;
            if (oV) v = (r[oV] && r[oV][pI] !== undefined) ? r[oV][pI] : 0;
            else v = r[pI] !== undefined ? r[pI] : 0;
            if (v && typeof v === 'object' && v.v !== undefined) return v.v;
            return v;
        }
        function markDirty() { document.getElementById('unsavedHint').style.display = 'inline-block'; document.getElementById('mainSaveBtn').style.boxShadow = '0 0 15px rgba(220, 38, 38, 0.4)'; }
        function markClean() { document.getElementById('unsavedHint').style.display = 'none'; document.getElementById('mainSaveBtn').style.boxShadow = 'none'; }
        async function updRule(fI, pI, oV, v, isOnceUpdate = false) {
            if (UIState.isBulkUpdating) return;
            pushHistory();
            if (!isOnceUpdate) {
                v = String(v).trim();
                if (!isNaN(v) && !v.startsWith('=')) v = Number(v);
            }

            const isInSelection = UIState.selectedCells.some(c => c.fId === fI && c.pId === pI && c.oV === (oV || null) && !c.mfId);

            if (isInSelection && UIState.selectedCells.length > 1) {
                UIState.isBulkUpdating = true;
                for (const cell of UIState.selectedCells) {
                    if (cell.mfId) continue;
                    applyRuleUpdate(cell.fId, cell.pId, cell.oV, v, isOnceUpdate);
                }
                UIState.isBulkUpdating = false;
                UIState.selectedCells = [];
            } else {
                applyRuleUpdate(fI, pI, oV, v, isOnceUpdate);
            }
            if (UIState.clearSelectionOnNextUpdate) {
                UIState.selectedCells = [];
                UIState.clearSelectionOnNextUpdate = false;
            }
            renderMatrix();
        }

        function applyRuleUpdate(fId, pId, oV, v, isOnceUpdate) {
            if (!Schema.rules[fId]) Schema.rules[fId] = {};
            let rules = Schema.rules[fId];
            if (oV) {
                if (!rules[oV]) rules[oV] = {};
                rules = rules[oV];
            }
            let cur = rules[pId];
            if (isOnceUpdate) {
                if (typeof cur === 'object' && cur !== null && cur.v !== undefined) {
                    cur.once = !!v;
                    if (!cur.once && !isNaN(cur.v)) rules[pId] = cur.v;
                } else if (v) {
                    rules[pId] = { v: cur || 0, once: true };
                }
            } else {
                if (typeof cur === 'object' && cur !== null && cur.v !== undefined) {
                    cur.v = v;
                    if (!cur.once && !isNaN(v)) rules[pId] = v;
                } else {
                    rules[pId] = v;
                }
            }
        }

        function toggleGroup(id) {
            const idx = UIState.collapsedGroups.indexOf(id);
            if (idx === -1) UIState.collapsedGroups.push(id);
            else UIState.collapsedGroups.splice(idx, 1);
            renderMatrix();
        }

        // ModalFields helpers
        function getModalFieldVal(buttonId, mfId, pI) {
            if (!Schema.modalFieldRules) Schema.modalFieldRules = {};
            const key = `${buttonId}_${mfId}`;
            const r = Schema.modalFieldRules[key];
            if (!r || r[pI] === undefined) return 0;
            let v = r[pI];
            if (v && typeof v === 'object' && v.v !== undefined) return v.v;
            return v;
        }
        async function updModalFieldRule(buttonId, mfId, pId, v, isP, isOnceUpdate = false) {
            if (UIState.isBulkUpdating) return;
            pushHistory();
            if (!isOnceUpdate) {
                v = String(v).trim();
                if (!isNaN(v) && !v.startsWith('=')) v = Number(v);
            }

            const key = `${buttonId}_${mfId}`;
            const isInSelection = UIState.selectedCells.some(c => c.fId === buttonId && c.pId === pId && c.mfId === mfId && !c.oV);

            if (isInSelection && UIState.selectedCells.length > 1) {
                UIState.isBulkUpdating = true;
                for (const cell of UIState.selectedCells) {
                    if (!cell.mfId || cell.oV) continue;
                    applyModalFieldUpdate(cell.fId, cell.mfId, null, cell.pId, v, isOnceUpdate);
                }
                UIState.isBulkUpdating = false;
                UIState.selectedCells = [];
            } else {
                applyModalFieldUpdate(buttonId, mfId, null, pId, v, isOnceUpdate);
            }
            if (UIState.clearSelectionOnNextUpdate) {
                UIState.selectedCells = [];
                UIState.clearSelectionOnNextUpdate = false;
            }
            renderMatrix();
        }

        function applyModalFieldUpdate(buttonId, mfId, optVal, pId, v, isOnceUpdate) {
            if (!Schema.modalFieldRules) Schema.modalFieldRules = {};
            const key = `${buttonId}_${mfId}`;
            if (!Schema.modalFieldRules[key]) Schema.modalFieldRules[key] = {};
            let rules = Schema.modalFieldRules[key];
            if (optVal) {
                if (!rules[optVal]) rules[optVal] = {};
                rules = rules[optVal];
            }
            let cur = rules[pId];
            if (isOnceUpdate) {
                if (typeof cur === 'object' && cur !== null && cur.v !== undefined) {
                    cur.once = !!v;
                    if (!cur.once && !isNaN(cur.v)) rules[pId] = cur.v;
                } else if (v) {
                    rules[pId] = { v: cur || 0, once: true };
                }
            } else {
                if (typeof cur === 'object' && cur !== null && cur.v !== undefined) {
                    cur.v = v;
                    if (!cur.once && !isNaN(v)) rules[pId] = v;
                } else {
                    rules[pId] = v;
                }
            }
        }
        function updModalFieldLabel(buttonId, idx, v, isP) { const fields = isP ? Schema.products.fields : Schema.fields; const field = fields.find(f => f.id === buttonId); if (field && field.modalFields && field.modalFields[idx]) { field.modalFields[idx].label = v; markDirty(); } }

        // ModalField options helpers
        function addModalFieldOption(buttonId, mfIdx, isP) {
            const fields = isP ? Schema.products.fields : Schema.fields;
            const field = fields.find(f => f.id === buttonId);
            if (field && field.modalFields && field.modalFields[mfIdx]) {
                const mf = field.modalFields[mfIdx];
                if (!mf.options) mf.options = [];

                // Create mini-modal for adding new option
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;padding:24px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:300px';
                modal.innerHTML = `
                    <h4 style="margin:0 0 20px 0;font-size:16px;color:#334155">‚ûï –ù–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –¥–ª—è "${mf.label}"</h4>
                    <div style="margin-bottom:20px">
                        <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ù–∞–∑–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—É</label>
                        <input id="mfOptNewName" type="text" value="–í–∞—Ä—ñ–∞–Ω—Ç ${mf.options.length + 1}" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box">
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end">
                        <button id="mfOptNewCancelBtn" style="padding:10px 20px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button id="mfOptNewSaveBtn" style="padding:10px 20px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600">–î–æ–¥–∞—Ç–∏</button>
                    </div>
                `;
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                document.getElementById('mfOptNewName').focus();
                document.getElementById('mfOptNewName').select();

                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                document.getElementById('mfOptNewCancelBtn').onclick = () => overlay.remove();
                document.getElementById('mfOptNewSaveBtn').onclick = () => {
                    const label = document.getElementById('mfOptNewName').value.trim();
                    if (!label) {
                        alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞—Ä—ñ–∞–Ω—Ç—É');
                        return;
                    }
                    mf.options.push({ value: 'opt' + Date.now(), label: label });
                    markDirty();
                    renderMatrix();
                    overlay.remove();
                };
            }
        }
        function delModalFieldOption(buttonId, mfIdx, optVal, isP) { const fields = isP ? Schema.products.fields : Schema.fields; const field = fields.find(f => f.id === buttonId); if (field && field.modalFields && field.modalFields[mfIdx]) { const mf = field.modalFields[mfIdx]; mf.options = mf.options.filter(o => o.value !== optVal); markDirty(); renderMatrix(); } }
        function updModalFieldOptionLabel(buttonId, mfIdx, optVal, newLabel, isP) { const fields = isP ? Schema.products.fields : Schema.fields; const field = fields.find(f => f.id === buttonId); if (field && field.modalFields && field.modalFields[mfIdx]) { const opt = field.modalFields[mfIdx].options.find(o => o.value === optVal); if (opt) { opt.label = newLabel; markDirty(); } } }
        function getModalFieldOptionVal(buttonId, mfId, optVal, pI) {
            if (!Schema.modalFieldRules) Schema.modalFieldRules = {};
            const key = `${buttonId}_${mfId}`;
            const r = Schema.modalFieldRules[key];
            if (!r || !r[optVal] || r[optVal][pI] === undefined) return 0;
            let v = r[optVal][pI];
            if (v && typeof v === 'object' && v.v !== undefined) return v.v;
            return v;
        }
        async function updModalFieldOptionRule(buttonId, mfId, optVal, pId, v, isP, isOnceUpdate = false) {
            if (UIState.isBulkUpdating) return;
            pushHistory();
            if (!isOnceUpdate) {
                v = String(v).trim();
                if (!isNaN(v) && !v.startsWith('=')) v = Number(v);
            }

            const key = `${buttonId}_${mfId}`;
            const isInSelection = UIState.selectedCells.some(c => c.fId === buttonId && c.pId === pId && c.mfId === mfId && c.oV === optVal);

            if (isInSelection && UIState.selectedCells.length > 1) {
                UIState.isBulkUpdating = true;
                for (const cell of UIState.selectedCells) {
                    if (!cell.mfId || !cell.oV) continue;
                    applyModalFieldUpdate(cell.fId, cell.mfId, cell.oV, cell.pId, v, isOnceUpdate);
                }
                UIState.isBulkUpdating = false;
                UIState.selectedCells = [];
            } else {
                applyModalFieldUpdate(buttonId, mfId, optVal, pId, v, isOnceUpdate);
            }
            if (UIState.clearSelectionOnNextUpdate) {
                UIState.selectedCells = [];
                UIState.clearSelectionOnNextUpdate = false;
            }
            renderMatrix();
        }

        function addModalField(buttonId, isP) {
            const fields = isP ? Schema.products.fields : Schema.fields;
            const field = fields.find(f => f.id === buttonId);
            if (!field) return;
            if (!field.modalFields) field.modalFields = [];

            // Create modal for adding new field
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:24px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:320px';
            modal.innerHTML = `
                <h4 style="margin:0 0 20px 0;font-size:18px;color:#1e293b">‚ûï –ù–æ–≤–µ –ø–æ–ª–µ –≤ –º–æ–¥–∞–ª–∫—É</h4>
                
                <div style="margin-bottom:15px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ù–∞–∑–≤–∞ –ø–æ–ª—è</label>
                    <input id="mfNewName" type="text" value="–ù–æ–≤–µ –ø–æ–ª–µ" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px">
                </div>

                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–¢–∏–ø –ø–æ–ª—è</label>
                    <select id="mfNewType" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px">
                        <option value="number">üî¢ –ß–∏—Å–ª–æ (number)</option>
                        <option value="select">üìã –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ (select)</option>
                        <option value="select_yes_no">üîΩ –í–∏–±—ñ—Ä –¢–∞–∫/–ù—ñ (select_yes_no)</option>
                        <option value="checkbox">‚úÖ –ß–µ–∫–±–æ–∫—Å (checkbox)</option>
                        <option value="checkbox_qty">‚òëÔ∏è –ß–µ–∫–±–æ–∫—Å –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é (checkbox_qty)</option>
                        <option value="multiselect">üìë –ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä (multiselect)</option>
                        <option value="multiselect_qty">üìã –ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä + –∫—ñ–ª—å–∫—ñ—Å—Ç—å (multiselect_qty)</option>
                    </select>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button id="mfNewCancelBtn" style="padding:10px 20px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="mfNewSaveBtn" style="padding:10px 20px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600">–î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ –≤ –º–æ–¥–∞–ª–∫—É</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('mfNewName').focus();
            document.getElementById('mfNewName').select();

            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.getElementById('mfNewCancelBtn').onclick = () => overlay.remove();

            document.getElementById('mfNewSaveBtn').onclick = () => {
                const label = document.getElementById('mfNewName').value.trim();
                const type = document.getElementById('mfNewType').value;

                if (!label) {
                    alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø–æ–ª—è');
                    return;
                }

                const newMf = {
                    id: 'mf' + Date.now(),
                    label: label,
                    type: type
                };

                // Add default options for select types
                if (type === 'select' || type === 'multiselect' || type === 'multiselect_qty') {
                    newMf.options = [
                        { value: 'opt1', label: '–í–∞—Ä—ñ–∞–Ω—Ç 1' }
                    ];
                }

                field.modalFields.push(newMf);
                markDirty();
                renderMatrix();
                overlay.remove();
            };
        }

        function changeModalFieldType(buttonId, mfIdx, isP) {
            const fields = isP ? Schema.products.fields : Schema.fields;
            const field = fields.find(f => f.id === buttonId);
            if (!field || !field.modalFields[mfIdx]) return;
            const mf = field.modalFields[mfIdx];

            // Create mini-modal with select
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:20px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:280px';
            modal.innerHTML = `
                <h4 style="margin:0 0 15px 0;font-size:14px;color:#334155">–¢–∏–ø –ø–æ–ª—è –¥–ª—è "${mf.label}"</h4>
                <select id="mfTypeSelect" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:15px">
                    <option value="number" ${mf.type === 'number' ? 'selected' : ''}>üî¢ –ß–∏—Å–ª–æ (number)</option>
                    <option value="select" ${mf.type === 'select' ? 'selected' : ''}>üìã –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ (select)</option>
                    <option value="select_yes_no" ${mf.type === 'select_yes_no' ? 'selected' : ''}>üîΩ –í–∏–±—ñ—Ä –¢–∞–∫/–ù—ñ (select_yes_no)</option>
                    <option value="checkbox" ${mf.type === 'checkbox' ? 'selected' : ''}>‚úÖ –ß–µ–∫–±–æ–∫—Å (checkbox)</option>
                    <option value="checkbox_qty" ${mf.type === 'checkbox_qty' ? 'selected' : ''}>‚òëÔ∏è –ß–µ–∫–±–æ–∫—Å –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é (checkbox_qty)</option>
                    <option value="multiselect" ${mf.type === 'multiselect' ? 'selected' : ''}>üìë –ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä (multiselect)</option>
                    <option value="multiselect_qty" ${mf.type === 'multiselect_qty' ? 'selected' : ''}>üìã –ú–Ω–æ–∂–∏–Ω–Ω–∏–π –≤–∏–±—ñ—Ä + –∫—ñ–ª—å–∫—ñ—Å—Ç—å (multiselect_qty)</option>
                </select>
                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button id="mfTypeCancelBtn" style="padding:8px 16px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="mfTypeSaveBtn" style="padding:8px 16px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.getElementById('mfTypeCancelBtn').onclick = () => overlay.remove();
            document.getElementById('mfTypeSaveBtn').onclick = () => {
                const selectedType = document.getElementById('mfTypeSelect').value;
                if (selectedType !== mf.type) {
                    mf.type = selectedType;
                    if ((selectedType === 'select' || selectedType === 'multiselect' || selectedType === 'multiselect_qty') && !mf.options) {
                        mf.options = [{ value: 'opt1', label: '–í–∞—Ä—ñ–∞–Ω—Ç 1' }];
                    }
                    markDirty();
                    renderMatrix();
                }
                overlay.remove();
            };
        }

        function updFLab(id, v, isP) { (isP ? Schema.products.fields : Schema.fields).find(f => f.id === id).label = v; markDirty(); renderSidebar(); }
        function updOLab(fI, oV, v, isP) { (isP ? Schema.products.fields : Schema.fields).find(f => f.id === fI).options.find(o => o.value === oV).label = v; markDirty(); }
        function addF(gI, isP) {
            // Create new field with defaults
            const newField = {
                id: 'f' + Date.now(),
                groupId: gI,
                label: '–ù–æ–≤–∞ –¥—ñ—è',
                type: 'number',
                layout: { inpBorder: '#000000' } // Black border by default
            };

            (isP ? Schema.products.fields : Schema.fields).push(newField);
            markDirty();
            renderMatrix();

            // Open settings modal for the new field
            openFModal(newField.id, isP);
        }
        function addOpt(fI, isP) {
            const f = (isP ? Schema.products.fields : Schema.fields).find(f => f.id === fI);
            if (!f.options) f.options = [];

            // Create mini-modal for adding new option
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:24px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:300px';
            modal.innerHTML = `
                <h4 style="margin:0 0 20px 0;font-size:16px;color:#334155">‚ûï –ù–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –≤–∏–±–æ—Ä—É</h4>
                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ù–∞–∑–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—É</label>
                    <input id="optNewName" type="text" value="–í–∞—Ä—ñ–∞–Ω—Ç ${f.options.length + 1}" style="width:100%;padding:10px;font-size:14px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end">
                    <button id="optNewCancelBtn" style="padding:10px 20px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="optNewSaveBtn" style="padding:10px 20px;border:none;background:#10b981;color:white;border-radius:6px;cursor:pointer;font-weight:600">–î–æ–¥–∞—Ç–∏</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('optNewName').focus();
            document.getElementById('optNewName').select();

            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.getElementById('optNewCancelBtn').onclick = () => overlay.remove();
            document.getElementById('optNewSaveBtn').onclick = () => {
                const label = document.getElementById('optNewName').value.trim();
                if (!label) {
                    alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≤–∞—Ä—ñ–∞–Ω—Ç—É');
                    return;
                }
                f.options.push({ value: 'o' + Date.now(), label: label });
                markDirty();
                renderMatrix();
                overlay.remove();
            };
        }
        function delOpt(fI, oV, isP) { const f = (isP ? Schema.products.fields : Schema.fields).find(f => f.id === fI); f.options = f.options.filter(o => o.value !== oV); markDirty(); renderMatrix(); }
        function delGroup(id, isP) { if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é –≥—Ä—É–ø—É?')) { if (isP) Schema.products.groups = Schema.products.groups.filter(g => g.id !== id); else Schema.groups = Schema.groups.filter(g => g.id !== id); markDirty(); renderSidebar(); renderMatrix(); } }

        function openGroupSettingsModal(gId, isP) {
            const group = (isP ? Schema.products.groups : Schema.groups).find(g => g.id === gId);
            if (!group) return;
            if (!group.layout) group.layout = {};

            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center';

            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:24px 30px;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,0.2);min-width:320px';
            modal.innerHTML = `
                <h4 style="margin:0 0 20px 0;font-size:18px;color:#1e293b">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä—É–ø–∏</h4>
                
                <div style="margin-bottom:15px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏</label>
                    <input id="grTitle" type="text" value="${group.title || ''}" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px">
                </div>

                <div style="margin-bottom:15px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–®–∏—Ä–∏–Ω–∞ –≥—Ä—É–ø–∏ (–¥–ª—è —Å—ñ—Ç–∫–∏)</label>
                    <select id="grWidth" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px">
                        <option value="100%" ${(!group.layout.width || group.layout.width === '100%') ? 'selected' : ''}>100% (–ù–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É)</option>
                        <option value="50%" ${group.layout.width === '50%' ? 'selected' : ''}>50% (–ü–æ–ª–æ–≤–∏–Ω–∞)</option>
                        <option value="33.33%" ${group.layout.width === '33.33%' ? 'selected' : ''}>33% (–¢—Ä–µ—Ç–∏–Ω–∞)</option>
                        <option value="25%" ${group.layout.width === '25%' ? 'selected' : ''}>25% (–ß–≤–µ—Ä—Ç—å)</option>
                    </select>
                </div>
                
                <div style="margin-bottom:20px">
                    <label style="display:block;font-size:12px;font-weight:600;color:#64748b;margin-bottom:6px">–ö–æ–ª—ñ—Ä —Ñ–æ–Ω—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input id="grBg" type="color" value="${group.layout.background || '#ffffff'}" style="width:100%;height:40px;padding:0;border:none;cursor:pointer">
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end; border-top:1px solid #eee; padding-top:15px">
                    <button id="grCancel" style="padding:10px 20px;border:1px solid #e2e8f0;background:white;border-radius:6px;cursor:pointer">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button id="grSave" style="padding:10px 20px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-weight:600">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            document.getElementById('grCancel').onclick = () => overlay.remove();
            document.getElementById('grSave').onclick = () => {
                group.title = document.getElementById('grTitle').value;
                group.layout.width = document.getElementById('grWidth').value;
                const bg = document.getElementById('grBg').value;
                if (bg !== '#ffffff') group.layout.background = bg;
                else delete group.layout.background;

                markDirty();
                renderMatrix();
                // renderSidebar usually not needed for group layout, but title yes
                renderSidebar();
                overlay.remove();
            };
        }

        function delField(id, isP) {
            console.log('Deleting field:', id, 'isProduct:', isP);
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–ª–µ?')) {
                if (isP) Schema.products.fields = Schema.products.fields.filter(f => f.id !== id);
                else Schema.fields = Schema.fields.filter(f => f.id !== id);

                // Also clear selection to avoid stale refs
                UIState.selectedCells = [];

                markDirty();
                renderMatrix();
            }
        }

        async function saveData() { if ('showSaveFilePicker' in window) { try { const h = await window.showSaveFilePicker({ suggestedName: 'schema.js', types: [{ accept: { 'text/javascript': ['.js'] } }] }); const w = await h.createWritable(); await w.write(`const Schema = ${JSON.stringify(Schema, null, 4)};\n\nwindow.Schema = Schema;`); await w.close(); markClean(); alert('üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!'); } catch (e) { if (e.name !== 'AbortError') alert(e.message); } } else { alert('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ.'); console.log(Schema); } }

        function openFModal(id, isP) {
            const f = (isP ? Schema.products.fields : Schema.fields).find(f => f.id === id);
            document.getElementById('fId').value = id;
            document.getElementById('fName').value = f.label || '';
            document.getElementById('fType').value = f.type;
            document.getElementById('fHelp').value = f.helpContent || '';
            document.getElementById('fDefault').value = f.default || '';
            document.getElementById('fPlaceholder').value = f.placeholderText || '';
            document.getElementById('fLabelYes').value = f.labelYes || '';
            document.getElementById('fLabelNo').value = f.labelNo || '';
            document.getElementById('fAllowDecimal').checked = !!f.allowDecimal;
            document.getElementById('fieldModal').dataset.mode = isP ? 'prod' : 'calc';
            toggleFieldSettings(f.type);
            document.getElementById('fieldModal').style.display = 'flex';
        }
        function toggleFieldSettings(type) {
            document.getElementById('btnTextInput').style.display = (type === 'action_button' || type === 'checkbox_qty' || type === 'select_modal') ? 'block' : 'none';
            document.getElementById('selectLabels').style.display = (type === 'select_modal') ? 'block' : 'none';
            document.getElementById('selectPlaceholder').style.display = (type === 'select' || type === 'select_modal') ? 'block' : 'none';
            document.getElementById('numberSettings').style.display = (type === 'number' || type === 'checkbox_qty') ? 'block' : 'none';

            const btnLabel = document.getElementById('btnTextLabel');
            if (type === 'select_modal') btnLabel.innerText = '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª–∫–∏ (–¥–ª—è "–¢–∞–∫")';
            else if (type === 'action_button') btnLabel.innerText = '–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø—Ü—ñ';
            else btnLabel.innerText = '–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º';
        }
        function saveFModal() {
            const id = document.getElementById('fId').value;
            const isP = document.getElementById('fieldModal').dataset.mode === 'prod';
            const f = (isP ? Schema.products.fields : Schema.fields).find(f => f.id === id);

            f.label = document.getElementById('fName').value;
            f.type = document.getElementById('fType').value;
            f.helpContent = document.getElementById('fHelp').value;

            if (f.type === 'action_button' || f.type === 'checkbox_qty' || f.type === 'select_modal') {
                f.default = document.getElementById('fDefault').value;
            }
            if (f.type === 'select' || f.type === 'select_modal') {
                f.placeholderText = document.getElementById('fPlaceholder').value;
            }
            if (f.type === 'select_modal') {
                f.labelYes = document.getElementById('fLabelYes').value;
                f.labelNo = document.getElementById('fLabelNo').value;
            }
            if (f.type === 'number' || f.type === 'checkbox_qty') {
                f.allowDecimal = document.getElementById('fAllowDecimal').checked;
            } else {
                delete f.allowDecimal;
            }
            markDirty();
            closeModal('fieldModal');
            renderMatrix();
            renderSidebar();
        }

        function togglePreview(show) { if (!show) return closeModal('prodModal'); renderPView(); document.getElementById('prodModal').style.display = 'flex'; }
        let currentPreviewButtonId = null;

        function renderPView() {
            const b = document.getElementById('prodBody');
            b.innerHTML = '';

            // Find all fields with modalFields
            const fieldsWithModals = Schema.fields.filter(f => (f.type === 'action_button' || f.type === 'select_modal') && f.modalFields && f.modalFields.length > 0);

            if (fieldsWithModals.length === 0) {
                b.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8">–ù–µ–º–∞—î –ø–æ–ª—ñ–≤ –∑ –º–æ–¥–∞–ª—å–Ω–∏–º–∏ –≤—ñ–∫–Ω–∞–º–∏.</div>';
                return;
            }

            // Render each field's modal preview
            fieldsWithModals.forEach(button => {
                // Wrapper for this button's preview
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '30px';
                wrapper.style.border = '1px solid #e2e8f0';
                wrapper.style.borderRadius = '8px';
                wrapper.style.padding = '15px';
                wrapper.style.background = '#fff';

                wrapper.innerHTML = `<div style="font-weight:700; border-bottom:1px solid #eee; padding-bottom:5px; color:#1e293b; margin-bottom:10px">üì¶ ${button.label || button.default || '–ö–Ω–æ–ø–∫–∞'} <span style="font-weight:400; color:#94a3b8; font-size:11px">(ID: ${button.id})</span></div>`;

                // Content Container for fields
                const content = document.createElement('div');
                content.id = `preview_content_${button.id}`;

                button.modalFields.forEach(f => {
                    const row = document.createElement('div');
                    row.style.marginBottom = '12px';

                    if (f.type === 'select') {
                        const opts = (f.options || []).map(o => `<option value="${o.value}">${o.label}</option>`).join('');
                        row.innerHTML = `<label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px">${f.label}</label><select class="form-input preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="select" style="padding:6px 10px; font-size:12px; width:100%" onchange="recalcPreviewTotal('${button.id}')">${opts}</select>`;
                    }
                    else if (f.type === 'select_yes_no') {
                        row.innerHTML = `<label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px">${f.label}</label><select class="form-input preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="select_yes_no" style="padding:6px 10px; font-size:12px; width:100%" onchange="recalcPreviewTotal('${button.id}')"><option value="0">–ù—ñ</option><option value="1">–¢–∞–∫</option></select>`;
                    }
                    else if (f.type === 'multiselect') {
                        let items = (f.options || []).map(o => `
                            <label style="display:flex; align-items:center; gap:8px; margin-bottom:4px; cursor:pointer;">
                                <input type="checkbox" class="preview-input preview-ms-check" data-bid="${button.id}" data-fid="${f.id}" data-type="multiselect" value="${o.value}" onchange="recalcPreviewTotal('${button.id}')">
                                <span style="font-size:12px">${o.label}</span>
                            </label>
                        `).join('');

                        let labelHtml = f.label;
                        if (f.helpContent) {
                            labelHtml += ` <span style="cursor:help; color:#3b82f6; font-size:14px; margin-left:4px" title="${f.helpContent.replace(/"/g, '&quot;')}">‚ìò</span>`;
                        }

                        row.innerHTML = `<label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px">${labelHtml}</label><div style="background:transparent; padding:0; border:none; max-height:none;">${items}</div>`;
                    }
                    else if (f.type === 'multiselect_qty') {
                        let items = (f.options || []).map(o => `
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px; padding:4px 0; border-bottom:1px solid #eee;">
                                <label style="flex:1; display:flex; align-items:center; gap:6px; cursor:pointer; margin:0;">
                                    <input type="checkbox" class="preview-input preview-ms-qty-check" data-bid="${button.id}" data-fid="${f.id}" data-type="multiselect_qty" value="${o.value}" onchange="recalcPreviewTotal('${button.id}')">
                                    <span style="font-size:12px">${o.label}</span>
                                </label>
                                <input type="number" value="1" class="preview-ms-qty-input" data-value="${o.value}" data-bid="${button.id}" data-fid="${f.id}" min="1" oninput="recalcPreviewTotal('${button.id}')" style="width:60px; padding:4px 8px; font-size:11px; border:1px solid #d1d5db; border-radius:4px;">
                            </div>
                        `).join('');

                        let labelHtml = f.label;
                        if (f.helpContent) {
                            labelHtml += ` <span style="cursor:help; color:#3b82f6; font-size:14px; margin-left:4px" title="${f.helpContent.replace(/"/g, '&quot;')}">‚ìò</span>`;
                        }

                        row.innerHTML = `<label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px">${labelHtml}</label><div style="background:transparent; padding:0; border:none;">${items}</div>`;
                    }
                    else if (f.type === 'checkbox') {
                        row.innerHTML = `<div style="display:flex; align-items:center; gap:8px"><input type="checkbox" class="preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="checkbox" style="width:18px; height:18px" onchange="recalcPreviewTotal('${button.id}')"><label style="font-size:12px; font-weight:500">${f.label}</label></div>`;
                    }
                    else if (f.type === 'checkbox_qty') {
                        row.innerHTML = `<div style="display:flex; align-items:center; gap:8px"><input type="checkbox" class="preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="checkbox_qty_check" style="width:18px; height:18px" onchange="recalcPreviewTotal('${button.id}')"><label style="flex:1; font-size:12px; font-weight:500">${f.label}</label><input type="number" value="1" class="form-input preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="checkbox_qty_qty" style="width:60px; padding:4px 8px" oninput="recalcPreviewTotal('${button.id}')"></div>`;
                    }
                    else if (f.type === 'number') {
                        row.innerHTML = `<label style="display:block; font-size:12px; font-weight:500; margin-bottom:5px">${f.label}</label><input type="number" class="form-input preview-input" data-bid="${button.id}" data-fid="${f.id}" data-type="number" value="${f.default || 0}" style="width:100%; padding:6px 10px; font-size:12px" oninput="recalcPreviewTotal('${button.id}')">`;
                    }
                    content.appendChild(row);
                });

                wrapper.appendChild(content);

                // Total display for this button preview
                const totalEl = document.createElement('div');
                totalEl.id = `preview_total_${button.id}`;
                totalEl.style.marginTop = '15px';
                totalEl.style.padding = '10px';
                totalEl.style.background = '#f8fafc';
                totalEl.style.borderTop = '1px solid #eee';
                totalEl.style.color = '#3b82f6';
                totalEl.style.fontWeight = '700';
                totalEl.style.textAlign = 'right';
                totalEl.innerHTML = '–í—Å—å–æ–≥–æ: 0';
                wrapper.appendChild(totalEl);

                b.appendChild(wrapper);
            });
        }

        function recalcPreviewTotal(btnId) {
            let total = 0;
            const container = document.getElementById(`preview_content_${btnId}`);
            if (!container) return;

            // Gather inputs
            const inputs = container.querySelectorAll('.preview-input');
            const button = Schema.fields.find(f => f.id === btnId);
            if (!button || !button.modalFields) return;

            // Process each field in button.modalFields to avoid double counting inputs
            button.modalFields.forEach(f => {
                let isActive = false;
                let multiplier = 1;

                if (f.type === 'checkbox') {
                    const chk = container.querySelector(`input[data-fid="${f.id}"][data-type="checkbox"]`);
                    if (chk && chk.checked) isActive = true;
                }
                else if (f.type === 'checkbox_qty') {
                    const chk = container.querySelector(`input[data-fid="${f.id}"][data-type="checkbox_qty_check"]`);
                    const qty = container.querySelector(`input[data-fid="${f.id}"][data-type="checkbox_qty_qty"]`);
                    if (chk && chk.checked) {
                        isActive = true;
                        multiplier = Math.max(0, parseInt(qty?.value || 1));
                    }
                }
                else if (f.type === 'number') {
                    const inp = container.querySelector(`input[data-fid="${f.id}"][data-type="number"]`);
                    if (inp) {
                        isActive = true;
                        multiplier = parseFloat(inp.value) || 0;
                    }
                }
                else if (f.type === 'select_yes_no') {
                    const sel = container.querySelector(`select[data-fid="${f.id}"][data-type="select_yes_no"]`);
                    if (sel && sel.value == "1") {
                        isActive = true;
                        multiplier = 1;
                    }
                }
                else if (f.type === 'select') {
                    // For selects, changing options might imply points if options had points, but here rules are on the FIELD.
                    // The rule for a select field is usually map: option_value -> points_per_process.
                    // But in this system, 'val' in Schama.modalFieldRules is typically just a number or formula.
                    // Wait, for Select, does Schema.modalFieldRules store by option?
                    // Let's check getModalFieldOptionVal logic. Yes, for options it's different.
                }

                if (isActive) {
                    // Sum up points for this active field across all processes
                    const ruleKey = `${btnId}_${f.id}`;

                    // Iterate all processes
                    Schema.processes.forEach(p => {
                        let val = 0;
                        // Check rules
                        if (Schema.modalFieldRules && Schema.modalFieldRules[ruleKey] && Schema.modalFieldRules[ruleKey][p.id]) {
                            val = Number(Schema.modalFieldRules[ruleKey][p.id]) || 0;
                        }
                        total += val * multiplier;
                    });
                }

                // Handle Select/Multiselect Options separately as they have their own rows in matrix
                if (f.type === 'select' || f.type === 'multiselect') {
                    let selectedOpts = [];
                    if (f.type === 'select') {
                        const sel = container.querySelector(`select[data-fid="${f.id}"]`);
                        if (sel) selectedOpts = [sel.value];
                    } else {
                        selectedOpts = Array.from(container.querySelectorAll(`.preview-ms-check[data-fid="${f.id}"]:checked`)).map(el => el.value);
                    }

                    selectedOpts.forEach(optVal => {
                        const optRuleKey = `${btnId}_${f.id}`;
                        Schema.processes.forEach(p => {
                            if (Schema.modalFieldRules?.[optRuleKey]?.[optVal]?.[p.id]) {
                                total += Number(Schema.modalFieldRules[optRuleKey][optVal][p.id]) || 0;
                            }
                        });
                    });
                }
            });

            const totalEl = document.getElementById(`preview_total_${btnId}`);
            if (totalEl) totalEl.innerText = `–í—Å—å–æ–≥–æ: ${total.toLocaleString()}`;
        }
        function handleCSV(input) { const f = input.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { e.target.result.split('\n').forEach(l => { const c = l.split(';'); if (c[1] && c[1].length > 2) Schema.fields.push({ id: 'f_csv_' + Math.random().toString(36).substr(2, 5), groupId: Schema.groups[0].id, label: c[1], type: 'number' }); }); renderMatrix(); }; r.readAsText(f, 'windows-1251'); }
        function openProcsModal() {
            renderProcsEditor();
            document.getElementById('procsModal').style.display = 'flex';
        }

        function renderProcsEditor() {
            const container = document.getElementById('procsContainer');
            if (!container) return;
            container.innerHTML = '';

            const categories = Schema.categories || {};
            const processes = Schema.processes || [];

            Object.entries(categories).forEach(([cid, cat]) => {
                const sect = document.createElement('div');
                sect.style.marginBottom = '30px';
                sect.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:${cat.color}22; border-radius:10px; border-left:5px solid ${cat.color}">
                        <input type="text" value="${cat.name}" onchange="Schema.categories['${cid}'].name = this.value; markDirty(); renderSidebar();" style="font-weight:700; border:none; background:transparent; font-size:16px; flex:1">
                        <input type="color" value="${cat.color}" onchange="Schema.categories['${cid}'].color = this.value; markDirty(); refresh();" style="width:30px; height:30px; padding:0; border:none; cursor:pointer">
                        <button onclick="delCat('${cid}')" style="background:none; border:none; cursor:pointer; font-size:18px">üóëÔ∏è</button>
                    </div>
                `;

                const grid = document.createElement('div');
                grid.className = 'proc-grid';

                processes.filter(p => p.category === cid).forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'proc-card-edit';
                    card.innerHTML = `
                        <div style="display:flex; flex-direction:column; gap:8px">
                            <input type="text" value="${p.name}" onchange="let x = Schema.processes.find(i=>i.id==='${p.id}'); if(x) x.name=this.value; markDirty(); renderSidebar();" style="font-weight:600; border:1px solid #eee; padding:5px; border-radius:5px">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <span style="font-size:10px; color:#94a3b8">ID: ${p.id}</span>
                                <button onclick="delProc('${p.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                const addBtn = document.createElement('div');
                addBtn.className = 'proc-card-edit';
                addBtn.style.display = 'flex';
                addBtn.style.alignItems = 'center';
                addBtn.style.justifyContent = 'center';
                addBtn.style.cursor = 'pointer';
                addBtn.style.border = '2px dashed #eee';
                addBtn.style.color = '#94a3b8';
                addBtn.innerHTML = '+ –î–æ–¥–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å';
                addBtn.onclick = () => openActionModal('ADD_PROC', cid);
                grid.appendChild(addBtn);

                sect.appendChild(grid);
                container.appendChild(sect);
            });

            const addCatBtn = document.createElement('button');
            addCatBtn.className = 'btn';
            addCatBtn.style.width = '100%';
            addCatBtn.style.background = '#f1f5f9';
            addCatBtn.style.color = '#475569';
            addCatBtn.innerHTML = '+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–æ–≤—É –ö–∞—Ç–µ–≥–æ—Ä—ñ—é';
            addCatBtn.onclick = () => openActionModal('ADD_CAT');
            container.appendChild(addCatBtn);
        }

        function delCat(cid) {
            if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é "${Schema.categories[cid].name}"? –£—Å—ñ —ó—ó –ø—Ä–æ—Ü–µ—Å–∏ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ!`)) return;
            pushHistory();
            Schema.processes = Schema.processes.filter(p => p.category !== cid);
            delete Schema.categories[cid];
            markDirty(); refresh(); renderProcsEditor();
        }

        function delProc(pid) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å —Ç–∞ –≤—Å—ñ –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ —Ñ–æ—Ä–º—É–ª–∏?')) return;
            pushHistory();
            Schema.processes = Schema.processes.filter(p => p.id !== pid);
            // Cleanup formulas
            const tk = `_total_${pid}`;
            (Schema.fields || []).forEach(f => {
                if (Schema.rules && Schema.rules[f.id]) delete Schema.rules[f.id][tk];
            });
            markDirty(); refresh(); renderProcsEditor();
        }

        if (window.showSaveFilePicker) {
            window.saveData = async function () {
                const defaultName = window.currentConfigFile ? window.currentConfigFile.split('/').pop() : 'schema.js';
                const fileContent = `const Schema = ${JSON.stringify(Schema, null, 4)};\nwindow.Schema = Schema;`;
                const filename = window.currentConfigFile ? window.currentConfigFile : 'data/' + defaultName;

                // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
                try {
                    const response = await fetch('http://localhost:5005', {
                        method: 'POST',
                        mode: 'cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: filename, content: fileContent })
                    });
                    if (response.ok) {
                        document.getElementById('unsavedHint').style.display = 'none';
                        markClean();
                        console.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —á–µ—Ä–µ–∑ Local Saver");
                        alert('‚úÖ –§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!');
                        return;
                    }
                } catch (e) {
                    console.log("–õ–æ–∫–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.");
                }

                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: defaultName, types: [{ accept: { 'text/javascript': ['.js'] } }] });
                    const writ = await handle.createWritable();
                    await writ.write(fileContent);
                    await writ.close();
                    document.getElementById('unsavedHint').style.display = 'none';
                    markClean();
                    alert('‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
                } catch (e) {
                    if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message);
                }
            };
        } else {
            window.saveData = function () {
                const fileContent = `const Schema = ${JSON.stringify(Schema, null, 4)};\nwindow.Schema = Schema;`;
                const blob = new Blob([fileContent], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.currentConfigFile ? window.currentConfigFile.split('/').pop() : 'schema.js';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                document.getElementById('unsavedHint').style.display = 'none';
                markClean();
                alert('‚úÖ –§–∞–π–ª –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è!');
            };
        }
    </script>
    <script>
        function toggleSidebar(show) {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (show) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }
    </script>

    <!-- PROCESS EDITOR MODAL -->
    <div id="procsModal" class="modal">
        <div class="modal-card proc-manage-modal">
            <div class="modal-header" style="background:linear-gradient(to right, #10b981, #3b82f6); color:white">
                <h3>üìã –†–µ–¥–∞–∫—Ç–æ—Ä –ü—Ä–æ—Ü–µ—Å—ñ–≤ —Ç–∞ –ö–∞—Ç–µ–≥–æ—Ä—ñ–π</h3>
                <button onclick="closeModal('procsModal')"
                    style="background:none; border:none; font-size:24px; color:white; cursor:pointer">&times;</button>
            </div>
            <div id="procsContainer" class="modal-body" style="background:#f8fafc">
                <!-- Javascript will populate this -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-save" onclick="closeModal('procsModal')">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</button>
            </div>
        </div>
    </div>
    <!-- MARKUP MODAL -->
    <div id="markupModal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 style="margin:0">–ö–æ—Ä–µ–≥—É—é—á—ñ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ (%)</h3>
                <div style="font-size:12px; color:#64748b; margin-top:4px">
                    –í–≤–µ–¥—ñ—Ç—å –≤—ñ–¥—Å–æ—Ç–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó. –¶—ñ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω–∏—Ç—å—Å—è (–º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º—ñ–Ω—É—Å –¥–ª—è
                    –∑–Ω–∏–∂–∫–∏).
                </div>
            </div>
            <div class="modal-body">
                <div id="markupInputs" style="display:flex; flex-direction:column; gap:15px">
                    <!-- Inputs injected dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:white; border:1px solid #cbd5e1; color:#334155"
                    onclick="closeModal('markupModal')">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <button class="btn btn-save" onclick="saveMarkup()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        function openMarkupModal() {
            const container = document.getElementById('markupInputs');
            container.innerHTML = '';

            if (!Schema.meta) Schema.meta = {};
            if (!Schema.meta.markup) Schema.meta.markup = {};

            Object.keys(Schema.categories).forEach(cid => {
                const cat = Schema.categories[cid];
                const currentVal = Schema.meta.markup[cid] || 0;

                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.padding = '10px';
                row.style.background = '#f8fafc';
                row.style.borderRadius = '8px';
                row.style.border = '1px solid #e2e8f0';

                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px">
                        <div style="width:12px; height:12px; border-radius:50%; background:${cat.color || '#cbd5e1'}"></div>
                        <span style="font-weight:600; font-size:14px">${cat.name}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px">
                        <input type="number" id="markup_${cid}" value="${currentVal}" 
                            style="width:80px; padding:6px; border:1px solid #cbd5e1; border-radius:6px; text-align:center; font-weight:700" 
                            min="0" max="500" step="1">
                        <span style="font-weight:600; color:#64748b">%</span>
                    </div>
                `;
                container.appendChild(row);
            });

            document.getElementById('markupModal').style.display = 'flex';
        }

        function saveMarkup() {
            if (!Schema.meta.markup) Schema.meta.markup = {};

            Object.keys(Schema.categories).forEach(cid => {
                const inp = document.getElementById(`markup_${cid}`);
                if (inp) {
                    const val = parseFloat(inp.value);
                    if (!isNaN(val) && val >= 0) {
                        Schema.meta.markup[cid] = val;
                    } else {
                        Schema.meta.markup[cid] = 0;
                    }
                }
            });

            markDirty();
            closeModal('markupModal');
        }

        // ============================================
        // AI MAGIC IMPLEMENTATION (Gemini 1.5 Flash)
        // ============================================
        let currentAiImageBase64 = null;

        function openAIModal() {
            document.getElementById('aiModal').style.display = 'flex';
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('aiKey').value = savedKey;

            // Setup Dropzone Drag & Drop
            const dz = document.getElementById('aiDropzone');
            if (!dz.dataset.init) {
                dz.dataset.init = "true";
                dz.ondragover = (e) => { e.preventDefault(); dz.style.background = '#e0e7ff'; dz.style.borderColor = '#818cf8'; };
                dz.ondragleave = (e) => { e.preventDefault(); dz.style.background = '#f8fafc'; dz.style.borderColor = '#cbd5e1'; };
                dz.ondrop = (e) => {
                    e.preventDefault();
                    dz.style.background = '#f8fafc'; dz.style.borderColor = '#cbd5e1';
                    if (e.dataTransfer.files[0]) handleAiFile(e.dataTransfer.files[0]);
                };
            }
            // Global Paste Handler
            window.removeEventListener('paste', handlePasteImage);
            window.addEventListener('paste', handlePasteImage);
        }

        function handlePasteImage(e) {
            if (document.getElementById('aiModal').style.display !== 'flex') return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    handleAiFile(item.getAsFile());
                }
            }
        }

        function handleAiFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentAiImageBase64 = e.target.result.split(',')[1]; // Remove prefix
                document.getElementById('aiPreview').src = e.target.result;
                document.getElementById('aiPreview').style.display = 'block';
                document.getElementById('aiDropText').style.display = 'none';
                document.getElementById('aiRemoveImg').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearAiImage() {
            currentAiImageBase64 = null;
            document.getElementById('aiPreview').src = '';
            document.getElementById('aiPreview').style.display = 'none';
            document.getElementById('aiDropText').style.display = 'block';
            document.getElementById('aiRemoveImg').style.display = 'none';
            document.getElementById('aiImgInput').value = '';
        }

        function getCompactSchema() {
            // Helper to get all fields (calc + products if needed)
            // For now, let's focus on CALCULATOR fields (main schema)
            return (Schema.fields || []).map(f => {
                const simple = { id: f.id, label: f.label, type: f.type };
                if (f.options) simple.options = f.options.map(o => ({ v: o.value, l: o.label }));
                if (f.modalFields) simple.modalFields = f.modalFields.map(mf => {
                    const smf = { id: mf.id, label: mf.label, type: mf.type };
                    if (mf.options) smf.options = mf.options.map(o => ({ v: o.value, l: o.label }));
                    return smf;
                });
                return simple;
            });
        }

        async function runAiAnalysis() {
            const apiKey = document.getElementById('aiKey').value.trim();
            const promptText = document.getElementById('aiPrompt').value.trim();
            const log = document.getElementById('aiLog');

            if (!apiKey) { alert('–í–≤–µ–¥—ñ—Ç—å Gemini API Key!'); return; }
            localStorage.setItem('gemini_api_key', apiKey);

            if (!currentAiImageBase64 && !promptText) { alert('–î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ –∞–±–æ –æ–ø–∏—Å –¢–ó!'); return; }

            const btn = document.getElementById('aiRunBtn');
            btn.innerHTML = '‚è≥ –î—É–º–∞—é...';
            btn.disabled = true;
            log.style.display = 'block';
            log.innerText = '> –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö...\n';

            try {
                // Prepare Context
                const compactSchema = getCompactSchema();
                // Filter out non-essential fields to save tokens
                const schemaStr = JSON.stringify(compactSchema);

                log.innerText += '> –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ Google Gemini...\n';

                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: `–¢–∏ - –µ–∫—Å–ø–µ—Ä—Ç –∑ –æ—Ü—ñ–Ω–∫–∏ –º–µ–±–ª—ñ–≤. –¢–≤–æ—è —Ü—ñ–ª—å - –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ñ–æ—Ç–æ —Ç–∞ –¢–ó.
–û—Å—å —Å–∫–æ—Ä–æ—á–µ–Ω–∞ —Å—Ö–µ–º–∞ –ø–æ–ª—ñ–≤ (JSON): ${schemaStr}.
–¢–ó –∫–ª—ñ—î–Ω—Ç–∞: "${promptText}".
–ó–ê–í–î–ê–ù–ù–Ø: 
1. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ñ–æ—Ç–æ (—è–∫—â–æ —î) —Ç–∞ —Ç–µ–∫—Å—Ç.
2. –í–∏–∑–Ω–∞—á–∏, —è–∫—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –º–∞—é—Ç—å –±—É—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å, —Ç–∏–ø).
3. –ü–æ–≤–µ—Ä–Ω–∏ –¢–Ü–õ–¨–ö–ò —á–∏—Å—Ç–∏–π JSON –æ–±'—î–∫—Ç —É —Ñ–æ—Ä–º–∞—Ç—ñ:
{
  "fieldId": value,
  "fieldId_optionValue": value, (–¥–ª—è select/options)
  "fieldId_modalFieldId": value (–¥–ª—è –ø–æ–ª—ñ–≤ –º–æ–¥–∞–ª–∫–∏)
}
–Ø–ö–©–û —Ü–µ action_button/select_modal:
- –û—Å–Ω–æ–≤–Ω–µ –ø–æ–ª–µ –∑–∞–∑–≤–∏—á–∞–π –Ω–µ –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è, –∑–∞–ø–æ–≤–Ω—é—é—Ç—å—Å—è –π–æ–≥–æ modalFields.
- –ö–ª—é—á –¥–ª—è modalField –º–∞—î —Ñ–æ—Ä–º–∞—Ç "FieldID_ModalFieldID".
–Ø–ö–©–û —Ü–µ select/multiselect:
- –ö–ª—é—á –º–∞—î —Ñ–æ—Ä–º–∞—Ç "FieldID_OptionValue".
–ó–Ω–∞—á–µ–Ω–Ω—è –º–∞—é—Ç—å –±—É—Ç–∏ —á–∏—Å–ª–∞–º–∏ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å).

–ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
{
  "f123": 2, // –ø—Ä–æ—Å—Ç–µ –ø–æ–ª–µ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 2 —Ç—É–º–±–∏)
  "f456_opt1": 1, // –æ–ø—Ü—ñ—è
  "f789_mf1": 5 // –ø–æ–ª–µ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–æ–¥–∞–ª–∫–∏
}
–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¢–Ü–õ–¨–ö–ò JSON. –ë–µ–∑ markdown.` },
                            ...(currentAiImageBase64 ? [{ inline_data: { mime_type: "image/jpeg", data: currentAiImageBase64 } }] : [])
                        ]
                    }]
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) throw new Error('API Error: ' + response.statusText);

                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content) throw new Error('No content from AI');

                let aiText = data.candidates[0].content.parts[0].text;

                log.innerText += '> –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –û–±—Ä–æ–±–∫–∞...\n';

                // Clean markdown
                aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                let result;
                try {
                    result = JSON.parse(aiText);
                } catch (e) {
                    console.log('Raw AI:', aiText);
                    throw new Error('–ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON –≤—ñ–¥ AI');
                }

                log.innerText += '> –ó–Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª—ñ–≤: ' + Object.keys(result).length + '\n';
                console.log('AI Result:', result);

                // APPLY CHANGES
                let changesCount = 0;

                // We assume we are filling the "Global" calculator part (main schema fields)
                // And we apply values to ALL ACTIVE PROCESSES (or create a default one?)
                // Since this is admin panel, "values" are stored in Schema.rules[fId][pId]
                // We'll try to apply to all NON-HIDDEN processes in the schema.

                const validP = Object.keys(Schema.processes).map(k => ({ id: k, ...Schema.processes[k] })).filter(p => !p.hidden);

                Object.keys(result).forEach(key => {
                    const val = Number(result[key]) || 0;
                    if (val === 0) return;

                    let fId = key;
                    let subId = null;

                    // Naive ID parsing (assuming IDs don't have excessive underscores or we match prefix)
                    // Better: Iterate all fields and find match
                    const field = Schema.fields.find(f => key === f.id || key.startsWith(f.id + '_'));
                    if (field) {
                        fId = field.id;
                        if (key.length > fId.length) subId = key.substring(fId.length + 1);
                    } else {
                        return; // Field not found
                    }

                    // Apply to processes
                    validP.forEach(p => {
                        if (subId) {
                            if (field.modalFields && field.modalFields.some(mf => mf.id === subId)) {
                                // Is Modal Field
                                updModalFieldRule(fId, subId, p.id, val, false);
                            } else {
                                // Assume Option
                                updRule(fId, p.id, subId, val);
                            }
                        } else {
                            // Simple Field
                            updRule(fId, p.id, null, val);
                        }
                    });
                    changesCount++;
                });

                log.innerText += `‚úÖ –£—Å–ø—ñ—à–Ω–æ! –û–Ω–æ–≤–ª–µ–Ω–æ ${changesCount} –∑–Ω–∞—á–µ–Ω—å.`;
                renderMatrix();
                // Scroll to top or just flash
                alert(`‚ú® AI –∑–∞–≤–µ—Ä—à–∏–≤ —Ä–æ–±–æ—Ç—É!\n–ó–∞–ø–æ–≤–Ω–µ–Ω–æ –ø–æ–ª—ñ–≤: ${changesCount}`);

            } catch (err) {
                log.innerText += '‚ùå –ü–æ–º–∏–ª–∫–∞: ' + err.message;
                console.error(err);
                alert('–ü–æ–º–∏–ª–∫–∞ AI: ' + err.message);
            } finally {
                btn.innerHTML = 'ü§ñ –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏';
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>