<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vpoint - –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ú–µ–±–ª—ñ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #1e88e5;
            /* Vpoint Blue */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            text-align: center;
        }

        /* HEADER */
        .header {
            margin-bottom: 40px;
            position: relative;
        }

        .logo {
            font-size: 48px;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logo span {
            color: #fbbf24;
            /* Yellow V */
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .auth-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            /* Hidden by default */
        }

        .logout-btn:hover {
            background: #ef4444;
        }

        /* GRID */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            color: #1f2937;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 800;
            color: #1e40af;
            margin-bottom: 10px;
        }

        .card-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .card.coming-soon {
            opacity: 0.7;
            cursor: default;
            background: rgba(255, 255, 255, 0.8);
        }

        .card.coming-soon:hover {
            transform: none;
            box-shadow: none;
        }

        .badge {
            background: #d97706;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-box {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 12px;
            width: 300px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .modal-btn {
            width: 100%;
            padding: 10px;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- NEW DYNAMIC THEME STYLES --- */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: #0f172a;
        }

        .blob {
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--theme-color, #3b82f6) 0%, transparent 70%);
            filter: blur(80px);
            opacity: 0.4;
            border-radius: 50%;
            animation: move linear infinite;
        }

        @keyframes move {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(100px, 100px) scale(1.2);
            }
        }

        .glass-card {
            background: var(--glass-bg, rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(var(--glass-blur, 10px));
            -webkit-backdrop-filter: blur(var(--glass-blur, 10px));
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: white !important;
        }

        .card-title {
            color: white !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .card-desc {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        .logo-glow {
            text-shadow: 0 0 20px var(--theme-color, #fbbf24);
        }

        /* --- RESPONSIVE UPDATES --- */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .logo {
                font-size: 32px;
                text-align: left;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 14px;
                text-align: left;
                max-width: 70%;
                line-height: 1.3;
            }

            .header {
                text-align: left;
                padding: 15px !important;
                margin-bottom: 25px;
                min-height: 100px;
            }

            #header-illustration,
            #header-illustration2 {
                max-height: 80px !important;
                right: 10px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                opacity: 0.3;
                /* Make illustrations subtle background on mobile */
            }

            .grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }

            .card {
                padding: 20px;
                flex-direction: row !important;
                text-align: left !important;
                align-items: center !important;
                gap: 15px;
            }

            .card-icon,
            .card img {
                margin-bottom: 0 !important;
                height: 40px !important;
                font-size: 32px !important;
                flex-shrink: 0;
            }

            .card-title {
                font-size: 18px !important;
                margin-bottom: 4px !important;
            }

            .card-desc {
                font-size: 12px !important;
                max-width: none !important;
            }

            .auth-controls {
                top: 15px;
                right: 15px;
            }
        }
    </style>
    <!-- Dynamic config loading to prevent caching -->
    <!-- Dynamic config loading to prevent caching -->
    <script>
        document.write('<script src="data/config_calculators.js?v=' + Date.now() + '"><\/script>');
        document.write('<script src="data/config_dashboard.js?v=' + Date.now() + '"><\/script>');
        document.write('<script src="data/config_firebase.js?v=' + Date.now() + '"><\/script>');
    </script>
</head>

<body>
    <div id="bg-canvas"></div>

    <!-- AUTH WALL / COVER -->
    <div id="auth-cover"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#1e88e5; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; transition: opacity 0.5s;">
        <div style="font-size: 64px; font-weight: 800; margin-bottom: 20px;">Vpoint</div>
        <div style="font-size: 18px; opacity: 0.9; margin-bottom: 40px;">–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</div>

        <button onclick="window.Auth.login()"
            style="background:white; color:#1e88e5; border:none; padding:15px 40px; border-radius:30px; font-size:18px; font-weight:bold; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,0.2); transition:transform 0.2s;">
            <span style="margin-right:10px">G</span> –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>

        <div id="auth-loading" style="margin-top:20px; font-size:12px; opacity:0.7;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>

    <!-- Auth Watcher Script -->
    <script>
        const checkAuthWall = setInterval(() => {
            if (window.Auth && window.Auth.auth) {
                clearInterval(checkAuthWall);
                document.getElementById('auth-loading').innerText = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É...";

                window.Auth.auth.onAuthStateChanged(user => {
                    const cover = document.getElementById('auth-cover');
                    if (user) {
                        cover.style.opacity = '0';
                        setTimeout(() => cover.style.display = 'none', 500);
                    } else {
                        // Keep cover, maybe show message
                        cover.style.display = 'flex';
                        cover.style.opacity = '1';
                        document.getElementById('auth-loading').style.display = 'none';
                    }
                });
            }
        }, 100);
    </script>

    <div class="container">
        <div class="header" style="position:relative;">
            <div class="logo" id="site-logo"><span>V</span>point</div>
            <div class="subtitle" id="site-subtitle">–†–æ–∑—Ä–∞—Ö–æ–≤—É–π —ñ —Å—Ç–≤–æ—Ä—é–π ‚Äî –ª–µ–≥–∫–æ, —à–≤–∏–¥–∫–æ, –∑—Ä—É—á–Ω–æ</div>

            <img id="header-illustration"
                style="position:absolute; right:100px; top:-30px; height:140px; display:none; object-fit:contain; transition: transform 0.1s; pointer-events: none;">
            <img id="header-illustration2"
                style="position:absolute; right:180px; top:-30px; height:140px; display:none; object-fit:contain; transition: transform 0.1s; pointer-events: none;">

            <div class="auth-controls" style="display:flex; align-items:center; gap:10px;">
                <!-- Firebase Auth (User) -->
                <button id="authLoginBtn" onclick="window.Auth.login()"
                    style="background:#fff; color:#333; border:none; padding:6px 14px; border-radius:20px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:6px; font-size:13px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                    <span>G</span> –£–≤—ñ–π—Ç–∏
                </button>

                <div id="authUserArea" style="display:none; align-items:center; gap:10px;">
                    <img id="authUserAvatar" src=""
                        style="width:32px; height:32px; border-radius:50%; border:2px solid white;">
                    <div style="text-align:right; line-height:1.2">
                        <div id="authUserName" style="font-size:13px; font-weight:700;">User</div>
                        <div style="font-size:10px; opacity:0.8; cursor:pointer; text-decoration:underline"
                            onclick="window.Auth.logout()">–í–∏–π—Ç–∏</div>
                    </div>
                </div>

                <!-- Admin Auth (System) -->
                <button class="logout-btn" id="logoutBtn" onclick="doLogout()">Admin Exit</button>
                <button class="settings-btn" onclick="openLogin()">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Dynamic Content -->
        <div id="calculatorsGrid" class="grid"></div>
        <!-- Loading Indicator -->
        <div id="loading" style="grid-column: 1/-1; text-align: center; padding: 20px;">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤...
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-box">
            <h3>üîê –í—Ö—ñ–¥ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
            <input type="password" id="adminPass" class="modal-input" placeholder="–ü–∞—Ä–æ–ª—å"
                onkeydown="if(event.key==='Enter') checkLogin()">
            <button class="modal-btn" onclick="checkLogin()">–£–≤—ñ–π—Ç–∏</button>
            <div style="margin-top:10px; font-size:12px; cursor:pointer; color:#666" onclick="closeLogin()">–°–∫–∞—Å—É–≤–∞—Ç–∏
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePassModal" style="z-index: 2000;">
        <div class="modal-box">
            <h3>üÜï –ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px">–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –ø–∞—Ä–æ–ª—å —ñ –∑–±–µ—Ä–µ–∂—ñ—Ç—å —Ñ–∞–π–ª</p>
            <input type="text" id="newAdminPass" class="modal-input" placeholder="–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å"
                onkeydown="if(event.key==='Enter') saveNewPassword()">
            <button class="modal-btn" style="background:#f59e0b" onclick="saveNewPassword()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
            <div style="margin-top:10px; font-size:12px; cursor:pointer; color:#666"
                onclick="document.getElementById('changePassModal').style.display='none'">–°–∫–∞—Å—É–≤–∞—Ç–∏</div>
        </div>
    </div>

    <!-- File Selection Modal -->
    <div class="modal-overlay" id="fileSelectModal">
        <div class="modal-box" style="width: 400px;">
            <h3>üõ†Ô∏è –û–±–µ—Ä—ñ—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
            <div id="fileList" style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                <!-- Buttons will be injected here -->
            </div>
            <div style="margin-top:15px; font-size:12px; cursor:pointer; color:#666" onclick="closeFileSelect()">
                –°–∫–∞—Å—É–≤–∞—Ç–∏</div>
        </div>
    </div>

    <script>
        document.write('<script src="data/config_calculators.js?v=' + Date.now() + '"><\/script>');
        document.write('<script src="data/config_dashboard.js?v=' + Date.now() + '"><\/script>');
        document.write('<script src="data/config_firebase.js?v=' + Date.now() + '"><\/script>');
    </script>

    <!-- Firebase Compat (Required for file:// protocol) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Auth Module (Standard Script) -->
    <script src="core/auth.js"></script>

    <script>
        // Global Error Handler for Debugging
        window.onerror = function (msg, url, line, col, error) {
            console.error(msg, url, line, col, error);
            alert("Script Error: " + msg + "\nLine: " + line + "\nURL: " + url);
        };

        function hexToRgba(hex, alpha) {
            if (!hex || hex[0] !== '#') return `rgba(255, 255, 255, ${alpha})`;
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // --- Apply Dashboard Config ---
        function applyDashboardConfig() {
            if (!window.DashboardConfig) return;
            const cfg = window.DashboardConfig;
            const root = document.documentElement;

            // Theme Color & CSS Vars
            const themeColor = cfg.themeColor || "#1e88e5";
            root.style.setProperty('--theme-color', themeColor);

            const glassBlur = cfg.glassBlur !== undefined ? cfg.glassBlur : 10;
            const glassOpacity = cfg.glassOpacity !== undefined ? cfg.glassOpacity : 0.1;
            root.style.setProperty('--glass-blur', glassBlur + 'px');
            root.style.setProperty('--glass-bg', `rgba(255, 255, 255, ${glassOpacity})`);

            // Title & Logo
            document.title = cfg.siteTitle || "Vpoint";
            const logo = document.getElementById('site-logo');
            const subtitle = document.getElementById('site-subtitle');

            if (logo) {
                if (cfg.logoImage) {
                    const finalLogoSrc = (cfg.logoImage.startsWith('blob:') || cfg.logoImage.startsWith('data:')) ? cfg.logoImage : encodeURI(cfg.logoImage);
                    logo.innerHTML = `<img src="${finalLogoSrc}" alt="Logo" style="height: 60px;">`;
                } else {
                    logo.textContent = cfg.logoText || cfg.siteTitle || "Vpoint";
                    logo.classList.add('logo-glow');
                }
            }

            // Subtitle
            if (cfg.siteTitleSize) logo.style.fontSize = cfg.siteTitleSize + 'px';
            if (cfg.siteSubtitle) subtitle.innerText = cfg.siteSubtitle;

            // Illustration 1
            const illus = document.getElementById('header-illustration');
            if (cfg.headerIllustration && illus) {
                let path = cfg.headerIllustration;
                if (!path.startsWith('http') && !path.startsWith('data:') && !path.startsWith('blob:')) {
                    if (!path.startsWith('./') && !path.startsWith('../') && !path.startsWith('/')) {
                        path = './' + path;
                    }
                }
                const finalIllusSrc = (path.startsWith('blob:') || path.startsWith('data:')) ? path : encodeURI(path);
                illus.src = finalIllusSrc + '?v=' + Date.now();
                illus.style.display = 'block';
                illus.style.width = 'auto'; // Help SVG rendering
                const i1X = cfg.illus1X ?? 0;
                const i1Y = cfg.illus1Y ?? 0;
                const i1S = cfg.illus1Scale ?? 1;
                illus.style.transform = `translate(${i1X}px, ${i1Y}px) scale(${i1S})`;
            } else if (illus) {
                illus.style.display = 'none';
            }

            // Illustration 2
            const illus2 = document.getElementById('header-illustration2');
            if (cfg.headerIllustration2 && illus2) {
                let path2 = cfg.headerIllustration2;
                if (!path2.startsWith('http') && !path2.startsWith('data:') && !path2.startsWith('blob:')) {
                    if (!path2.startsWith('./') && !path2.startsWith('../') && !path2.startsWith('/')) {
                        path2 = './' + path2;
                    }
                }
                const finalIllus2Src = (path2.startsWith('blob:') || path2.startsWith('data:')) ? path2 : encodeURI(path2);
                illus2.src = finalIllus2Src + '?v=' + Date.now();
                illus2.style.display = 'block';
                illus2.style.width = 'auto';
                const i2X = cfg.illus2X ?? 0;
                const i2Y = cfg.illus2Y ?? 0;
                const i2S = cfg.illus2Scale ?? 1;
                illus2.style.transform = `translate(${i2X}px, ${i2Y}px) scale(${i2S})`;
            } else if (illus2) {
                illus2.style.display = 'none';
            }

            // Logo Positioning
            if (logo) {
                const lX = cfg.logoX ?? 0;
                const lY = cfg.logoY ?? 0;
                const lS = cfg.logoScale ?? 1;
                logo.style.transform = `translate(${lX}px, ${lY}px) scale(${lS})`;
                logo.style.transformOrigin = 'center';
            }

            // Header Box Style
            const headerBox = document.querySelector('.header');
            if (headerBox) {
                const hBg = cfg.headerBgColor || '#ffffff';
                const hOpacity = cfg.headerOpacity ?? 0.15;
                const hBlur = cfg.headerBlur ?? 10;
                headerBox.style.background = hexToRgba(hBg, hOpacity);
                headerBox.style.backdropFilter = `blur(${hBlur}px)`;
                headerBox.style.webkitBackdropFilter = `blur(${hBlur}px)`;
            }

            // Background Type Logic
            const bgCanvas = document.getElementById('bg-canvas');
            const bgType = cfg.bgType || 'color';

            if (bgType === 'animation') {
                bgCanvas.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    const blob = document.createElement('div');
                    blob.className = 'blob';
                    blob.style.left = Math.random() * 100 + '%';
                    blob.style.top = Math.random() * 100 + '%';
                    blob.style.animationDuration = (10 + Math.random() * 20) + 's';
                    blob.style.animationDelay = (Math.random() * -20) + 's';
                    bgCanvas.appendChild(blob);
                }
            } else if (bgType === 'gradient') {
                bgCanvas.style.background = `linear-gradient(135deg, ${themeColor} 0%, #0f172a 100%)`;
            } else if (bgType === 'color') {
                bgCanvas.style.background = themeColor;
            } else if (bgType === 'image' && cfg.backgroundImage) {
                bgCanvas.style.backgroundImage = `url('${cfg.backgroundImage}')`;
                bgCanvas.style.backgroundSize = 'cover';
                bgCanvas.style.backgroundPosition = 'center';
            }
        }
        // Check auth on load
        window.onload = function () {
            applyDashboardConfig();
            renderCalculators();
            if (sessionStorage.getItem('isAdmin') === 'true') {
                document.getElementById('logoutBtn').style.display = 'block';
            }
        };

        function renderCalculators() {
            const grid = document.getElementById('calculatorsGrid');
            const loading = document.getElementById('loading');
            grid.innerHTML = '';

            const configs = window.CalculatorConfig || [];

            if (configs.length === 0) {
                loading.innerText = '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ñ–≤.';
                return;
            }

            const dbCfg = window.DashboardConfig || {};
            const cardWidth = dbCfg.cardMinWidth || 250;
            const cardPadding = dbCfg.cardPadding || 20;
            const cardIconSize = dbCfg.cardIconSize || 40;
            const cardTitleSize = dbCfg.cardTitleSize || 16;
            const cardTitleColor = dbCfg.cardTitleColor || '#ffffff';
            const cardDescSize = dbCfg.cardDescSize || 12;
            const cardDescColor = dbCfg.cardDescColor || '#ffffff';

            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${cardWidth}px, 1fr))`;
            grid.style.gridAutoRows = '1fr';
            grid.style.alignItems = 'stretch';
            grid.style.justifyItems = 'stretch';

            configs.forEach(conf => {
                const cardTitleWeight = dbCfg.cardTitleWeight || '800';
                const placeholderBg = dbCfg.placeholderBg || '';
                const placeholderBadge = dbCfg.placeholderBadgeText || '–°–∫–æ—Ä–æ';

                const a = document.createElement('a');
                a.href = `core/calculator.html?config=${conf.file}`;
                a.className = 'card';
                if (conf.isPlaceholder) {
                    a.href = '#';
                }

                const colSpan = conf.colSpan || 1;
                a.style.padding = `${cardPadding}px`;
                a.style.gridColumn = `span ${colSpan}`;

                // Add flex layout to ensure equal heights
                a.style.display = 'flex';
                a.style.flexDirection = 'column';
                a.style.justifyContent = 'space-between';
                a.style.height = '100%';
                a.style.width = '100%';

                if (conf.isPlaceholder && placeholderBg) {
                    a.style.background = placeholderBg;
                    a.style.color = '#334155';
                }

                let badgeHtml = '';
                if (conf.isPlaceholder) {
                    badgeHtml = `<div class="badge" style="background:${dbCfg.themeColor || '#1e88e5'}">${placeholderBadge}</div>`;
                } else if (conf.badge) {
                    badgeHtml = `<div class="badge" style="background:${dbCfg.themeColor || '#1e88e5'}">${conf.badge}</div>`;
                }

                const isImage = (conf.icon && (conf.icon.includes('/') || conf.icon.includes('.')));
                const iconHtml = isImage ? `<img src="${encodeURI(conf.icon)}" style="height:${cardIconSize}px; display:block; margin: 0 auto 20px; object-fit: contain;">` : `<div style="font-size:${cardIconSize}px; margin-bottom: 20px;">${conf.icon}</div>`;

                a.innerHTML = `
                    <div style="flex-grow: 1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align: center;">
                        ${badgeHtml}
                        <div style="height: ${cardIconSize}px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                            ${iconHtml}
                        </div>
                        <div class="card-title" style="font-size:${cardTitleSize}px; color:${conf.isPlaceholder ? 'inherit' : cardTitleColor}; font-weight: ${cardTitleWeight}; margin-bottom: 8px; line-height: 1.2;">${conf.title}</div>
                        <div class="card-desc" style="font-size:${cardDescSize}px; color:${conf.isPlaceholder ? 'inherit' : cardDescColor}; opacity:0.8; line-height: 1.4; max-width: 250px;">${conf.desc || ''}</div>
                    </div>
                `;
                if (!conf.isPlaceholder) {
                    a.classList.add('glass-card');
                    // Ensure css variables are set for glass card
                    a.style.setProperty('--glass-bg', `rgba(255, 255, 255, ${dbCfg.glassOpacity || 0.1})`);
                    a.style.setProperty('--glass-blur', `${dbCfg.glassBlur || 10}px`);
                }
                grid.appendChild(a);
            });

            loading.style.display = 'none';
        }

        function openLogin() {
            if (sessionStorage.getItem('isAdmin') === 'true') {
                showFileSelection();
                return;
            }
            document.getElementById('loginModal').style.display = 'flex';
            setTimeout(() => document.getElementById('adminPass').focus(), 100);
        }

        function closeLogin() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function closeFileSelect() {
            document.getElementById('fileSelectModal').style.display = 'none';
        }

        function showFileSelection() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';

            // DASHBOARD EDIT BUTTON
            const dashBtn = document.createElement('button');
            dashBtn.className = 'modal-btn';
            dashBtn.style.background = '#f3f4f6';
            dashBtn.style.color = '#333';
            dashBtn.style.border = '1px dashed #ccc';
            dashBtn.style.marginBottom = '15px';
            dashBtn.innerHTML = `üè† –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ì–æ–ª–æ–≤–Ω—É (Dashboard)`;
            dashBtn.onclick = function () {
                window.location.href = 'core/designer.html?mode=dashboard';
            };
            list.appendChild(dashBtn);

            const configs = window.CalculatorConfig || [];

            configs.forEach(conf => {
                if (conf.isPlaceholder) return;

                const btn = document.createElement('button');
                btn.className = 'modal-btn';
                btn.style.background = 'white';
                btn.style.color = '#1e40af';
                btn.style.border = '1px solid #1e40af';
                btn.style.marginBottom = '0';
                const isImage = (conf.icon && (conf.icon.includes('/') || conf.icon.includes('.')));
                const finalIconSrc = isImage ? encodeURI(conf.icon) : '';
                const iconHtml = isImage ? `<img src="${finalIconSrc}" style="height:20px; vertical-align:middle; margin-right:5px; object-fit:contain">` : `<span style="font-size:16px">${conf.icon}</span>`;
                btn.innerHTML = `${iconHtml} <b>${conf.title}</b><br><span style="font-size:10px; opacity:0.6">${conf.file}</span>`;
                btn.onclick = function () {
                    window.location.href = 'core/admin.html?config=' + conf.file;
                };
                btn.onmouseover = function () { this.style.background = '#eff6ff'; };
                btn.onmouseout = function () { this.style.background = 'white'; };
                list.appendChild(btn);
            });

            // ADD NEW CALCULATOR BUTTON
            const addBtn = document.createElement('button');
            addBtn.className = 'modal-btn';
            addBtn.style.marginTop = '15px';
            addBtn.style.background = '#10b981'; // Green
            addBtn.style.color = 'white';
            addBtn.innerHTML = `‚ûï –î–æ–¥–∞—Ç–∏ –ù–æ–≤–∏–π –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä`;
            addBtn.onclick = showAddWizard_Step1;
            list.appendChild(addBtn);

            // CHANGE PASSWORD BUTTON
            const passBtn = document.createElement('button');
            passBtn.className = 'modal-btn';
            passBtn.style.marginTop = '10px';
            passBtn.style.background = '#f59e0b'; // Amber
            passBtn.style.color = 'white';
            passBtn.innerHTML = `üîê –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å`;
            passBtn.onclick = function () {
                closeFileSelect();
                document.getElementById('changePassModal').style.display = 'flex';
                setTimeout(() => document.getElementById('newAdminPass').focus(), 100);
            };
            list.appendChild(passBtn);

            // Manual Input
            const manualDetails = document.createElement('div');
            manualDetails.style.marginTop = '10px';
            manualDetails.style.borderTop = '1px solid #eee';
            manualDetails.style.paddingTop = '10px';
            manualDetails.innerHTML = `<button onclick="manualInput()" style="background:none; border:none; color:#666; font-size:11px; cursor:pointer; text-decoration:underline">–í–≤–µ—Å—Ç–∏ —à–ª—è—Ö –≤—Ä—É—á–Ω—É...</button>`;
            list.appendChild(manualDetails);

            document.getElementById('fileSelectModal').style.display = 'flex';
        }

        async function saveNewPassword() {
            const newPass = document.getElementById('newAdminPass').value;
            if (!newPass) {
                alert('–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å!');
                return;
            }

            if (!window.DashboardConfig) window.DashboardConfig = {};
            window.DashboardConfig.adminPassword = newPass;

            const fileContent = `window.DashboardConfig = ${JSON.stringify(window.DashboardConfig, null, 4)};`;

            // 1. Try Automatic Save (Local Server)
            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: 'data/config_dashboard.js', content: fileContent })
                });

                if (response.ok) {
                    alert('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–º—ñ–Ω–µ–Ω–æ (–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è)!');
                    document.getElementById('changePassModal').style.display = 'none';
                    return; // Stop here if successful
                }
            } catch (e) {
                console.warn("Local Saver not detected, switching to manual mode.");
            }

            // 2. Fallback to File Picker
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'config_dashboard.js',
                    types: [{ accept: { 'text/javascript': ['.js'] } }]
                });
                const writable = await handle.createWritable();
                await writable.write(fileContent);
                await writable.close();

                alert('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–º—ñ–Ω–µ–Ω–æ!');
                document.getElementById('changePassModal').style.display = 'none';
            } catch (e) {
                console.error(e);
                if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        // --- WIZARD LOGIC (Fix for User Gesture) ---
        let newCalcData = {};

        function showAddWizard_Step1() {
            const list = document.getElementById('fileList');
            list.innerHTML = `
                <div style="text-align:left">
                    <h4 style="margin:0 0 10px 0; font-size:14px; color:#333">–ö—Ä–æ–∫ 1: –û–ø–∏—Å –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</h4>
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px">–ù–∞–∑–≤–∞</label>
                    <input type="text" id="newCalcTitle" class="modal-input" placeholder="–ù–∞–ø—Ä: –°–ø–∞–ª—å–Ω—è" style="margin-top:0">
                    
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px; margin-top:10px">–Ü–∫–æ–Ω–∫–∞ (–µ–º–æ–¥–∑—ñ)</label>
                    <input type="text" id="newCalcIcon" class="modal-input" placeholder="üõèÔ∏è" value="üì¶" style="margin-top:0">
                    
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px; margin-top:10px">–û–ø–∏—Å</label>
                    <input type="text" id="newCalcDesc" class="modal-input" placeholder="–î–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É..." style="margin-top:0">
                    
                    <div style="display:flex; gap:10px; margin-top:20px">
                        <button class="modal-btn" style="background:#ccc; color:#333" onclick="showFileSelection()">–ù–∞–∑–∞–¥</button>
                        <button class="modal-btn" onclick="showAddWizard_Step2()">–î–∞–ª—ñ ‚û°Ô∏è</button>
                    </div>
                </div>
            `;
        }

        function showAddWizard_Step2() {
            // Validate inputs
            const title = document.getElementById('newCalcTitle').value;
            const icon = document.getElementById('newCalcIcon').value;
            const desc = document.getElementById('newCalcDesc').value;

            if (!title) { alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É!'); return; }

            newCalcData = { title, icon, desc, fileId: 'schema_' + Date.now() };

            const list = document.getElementById('fileList');
            list.innerHTML = `
                <div style="text-align:center">
                    <h4 style="margin:0 0 10px 0; font-size:14px; color:#333">–ö—Ä–æ–∫ 2: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –§–∞–π–ª—É</h4>
                    <p style="font-size:12px; color:#666; margin-bottom:20px">–ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó <b>data/${newCalcData.fileId}.js</b></p>
                    
                    <button class="modal-btn" style="background:#2563eb" onclick="saveSchemaFile()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –°—Ö–µ–º—É</button>
                </div>
            `;
        }

        async function saveSchemaFile() {
            const newSchema = {
                title: newCalcData.title,
                currency: "–≥—Ä–Ω",
                categories: {},
                processes: [],
                groups: [],
                rules: {}
            };
            const fileContent = `const Schema = ${JSON.stringify(newSchema, null, 4)};\nwindow.Schema = Schema;`;
            const fileName = `data/${newCalcData.fileId}.js`;

            // 1. Try Auto-Save (Local Server)
            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: fileName, content: fileContent })
                });
                if (response.ok) {
                    newCalcData.finalFileName = `${newCalcData.fileId}.js`;
                    console.log("‚úÖ Auto-saved schema");
                    showAddWizard_Step3();
                    return;
                }
            } catch (e) {
                console.warn("Local Saver skipped", e);
            }

            // 2. Fallback
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: `${newCalcData.fileId}.js`,
                    types: [{ accept: { 'text/javascript': ['.js'] } }]
                });
                const writable = await handle.createWritable();
                await writable.write(fileContent);
                await writable.close();

                newCalcData.finalFileName = handle.name;
                showAddWizard_Step3();

            } catch (e) {
                console.error(e);
                if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        function showAddWizard_Step3() {
            const list = document.getElementById('fileList');
            list.innerHTML = `
                <div style="text-align:center">
                    <h4 style="margin:0 0 10px 0; font-size:14px; color:#333">–ö—Ä–æ–∫ 3: –û–Ω–æ–≤–ª–µ–Ω–Ω—è –°–ø–∏—Å–∫—É</h4>
                    <p style="font-size:12px; color:#666; margin-bottom:20px">–¢–µ–ø–µ—Ä —Ç—Ä–µ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ —Ñ–∞–π–ª —Å–ø–∏—Å–∫—É <b>data/config_calculators.js</b></p>
                    
                    <button class="modal-btn" style="background:#10b981" onclick="saveConfigFile()">üìù –û–Ω–æ–≤–∏—Ç–∏ –°–ø–∏—Å–æ–∫</button>
                </div>
            `;
        }

        async function saveConfigFile() {
            const newEntry = {
                id: newCalcData.fileId,
                title: newCalcData.title,
                icon: newCalcData.icon,
                file: `data/${newCalcData.finalFileName}`,
                desc: newCalcData.desc
            };

            if (!window.CalculatorConfig) window.CalculatorConfig = [];
            window.CalculatorConfig.push(newEntry);

            const configContent = `window.CalculatorConfig = ${JSON.stringify(window.CalculatorConfig, null, 4)};`;

            // 1. Try Auto-Save (Local Server)
            try {
                const response = await fetch('http://localhost:5005', {
                    method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: 'data/config_calculators.js', content: configContent })
                });
                if (response.ok) {
                    alert('‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ! (–ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è)');
                    closeFileSelect();
                    renderCalculators();
                    return;
                }
            } catch (e) {
                console.warn("Local Saver skipped", e);
            }

            // 2. Fallback
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'config_calculators.js',
                    types: [{ accept: { 'text/javascript': ['.js'] } }]
                });
                const writable = await handle.createWritable();
                await writable.write(configContent);
                await writable.close();

                alert('‚úÖ –í—Å–µ –≥–æ—Ç–æ–≤–æ!');
                closeFileSelect();
                renderCalculators();

            } catch (e) {
                console.error(e);
                if (e.name !== 'AbortError') alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }


        function manualInput() {
            const file = prompt("–í–≤–µ–¥—ñ—Ç—å —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É:", "data/schema_kitchen.js");
            if (file) window.location.href = 'core/admin.html?config=' + file;
        }

        function checkLogin() {
            const pass = document.getElementById('adminPass').value;
            const configPass = (window.DashboardConfig && window.DashboardConfig.adminPassword) ? window.DashboardConfig.adminPassword : 'admin';

            if (pass === configPass) {
                sessionStorage.setItem('isAdmin', 'true');
                // clear local storage legacy if exists
                localStorage.removeItem('isAdmin');

                alert('–£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥! –°–µ—Å—ñ—è –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –≤–∫–ª–∞–¥–∫–∏.');
                document.getElementById('logoutBtn').style.display = 'block';
                closeLogin();

                showFileSelection();
            } else {
                alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å');
            }
        }

        function doLogout() {
            sessionStorage.removeItem('isAdmin');
            localStorage.removeItem('isAdmin');
            document.getElementById('logoutBtn').style.display = 'none';
            alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏.');
        }

        // Simple Enter key support
        document.getElementById('adminPass').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkLogin();
            }
        });
    </script>
</body>

</html>
```