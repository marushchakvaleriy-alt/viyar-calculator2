# Логіка Розрахунку Матриці Адмінпанелі

Цей документ описує технічну логіку розрахунку, що використовується в `admin.html`. Він призначений для передачі програмістам для розуміння алгоритмів формування цін та вартості робіт.

## 1. Загальна Концепція
Матриця представляє собою двовимірну таблицю, де:
*   **Рядки (Fields)**: Елементи калькуляції (Вироби, Фурнітура, Послуги).
*   **Стовпці (Processes)**: Виробничі процеси (Проектування, Конструювання, Збирання, Монтаж тощо).

Кожна клітинка на перетині Рядка та Стовпця містить **Базове Значення (Base Value)**, яке може бути фіксованим числом або динамічною формулою.

## 2. Алгоритм Розрахунку (Data Flow)

Система працює за наступним ланцюжком:

1.  **Вхідні дані (@qty)**: Користувач вводить кількість або вибирає опцію в калькуляторі.
2.  **Вибірка Правил (Rules Lookup)**: Для кожного активного поля система шукає відповідне правило в `Schema.rules[fieldId][processId]`.
3.  **Обчислення Значення (Evaluation)**:
    *   Якщо значення — число: використовується як є.
    *   Якщо значення — формула (починається з `=`): виконується підстановка змінних та математичний розрахунок.
4.  **Агрегація (Summation)**:
    *   `Row Raw Sum` = Сума всіх базових значень в рядку.
    *   `Row Total` = `Row Raw Sum` * `@qty`. (Або 1 раз, якщо встановлено прапорець `1x`).
    *   `Category Total` = Сума `Row Total` всіх полів, що належать до певної категорії (наприклад, "Монтаж").

## 3. Логіка Формул

Система підтримує розширений синтаксис формул. Парсинг відбувається в реальному часі ("на льоту").

### Доступні Змінні (Variables)
| Змінна | Опис | Приклад значення |
| :--- | :--- | :--- |
| `@qty` | Кількість, введена користувачем | `5` (шт) |
| `@raw` | **"Сира" сума рядка**. Сума балів всіх клітинок у цьому рядку (без множення на кількість). | `150` (балів) |
| `@sum` | **Повна сума рядка**. `@raw * @qty` | `750` |
| `@sum_[alias]` | **Глобальна сума категорії**. Доступ до підсумків інших колонок. | `@sum_konst` (Сума конструювання) |

*Примітка: Аліаси категорій (`[alias]`) визначаються в `CatAliases` (наприклад, `construction` -> `konst`).*

### Підтримувані Операції
Використовується безпечний `Math` контекст JavaScript:
*   Арифметика: `+`, `-`, `*`, `/`
*   Логіка: `ternary ? true : false`
*   Функції: `min(a,b)`, `max(a,b)`, `round(x)`, `ceil(x)`, `floor(x)`

### Приклади Формул

**1. Лінійне масштабування:**
```js
=@qty * 10
// Якщо кількість 5, результат 50
```

**2. Поріг (Min/Max):**
```js
=min(@qty, 3) * 100
// Якщо qty=1 -> 100
// Якщо qty=10 -> 300 (береться максимум 3)
```

**3. Ступінчаста ціна (Tiered Pricing):**
```js
=@qty <= 10 ? @qty * 20 : 10 * 20 + (@qty - 10) * 15
// Перші 10 шт по 20, наступні по 15
```

**4. Відсоток від суми іншої категорії:**
```js
=@sum_zbira * 0.15
// 15% від загальної вартості збирання
```

## 4. Структура Даних (JSON Schema)

Конфігурація зберігається в об'єкті `Schema`:

```javascript
const Schema = {
    // Категорії (Стовпці груп)
    categories: {
        "cat_construction": { "name": "Конструювання", "color": "#eff6ff" },
        ...
    },
    // Процеси (Конкретні колонки)
    processes: [
        { "id": "pr_draft", "name": "Чорновий розрахунок", "category": "cat_construction" },
        ...
    ],
    // Групи полів (Секції)
    groups: [
        { "id": "g1", "title": "Кухня" }
    ],
    // Поля (Рядки)
    fields: [
        { 
            "id": "f1", 
            "type": "number", 
            "label": "Ящики Blum",
            "groupId": "g1" 
        }
    ],
    // Правила розрахунку (Клітинки)
    rules: {
        "f1": {
            "pr_draft": 15,          // Статичне число
            "pr_assembly": "=@qty*5" // Формула
        }
    }
};
```

## 5. Особливості Реалізації

*   **Modal Fields (Модальні вікна)**: Поля типу `action_button` можуть мати вкладені під-поля (`modalFields`). Їх значення розраховуються окремо і сумуються до батьківського поля.
*   **Фіксовані значення (1x)**: Прапорець `once` (або `1x` в інтерфейсі) дозволяє ігнорувати `@qty` при множенні, додаючи вартість лише один раз на замовлення, незалежно від кількості. В коді це виглядає як `{ v: 10, once: true }`.
