<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Designer - Viyar Pro</title>
    <script src="schema.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #111827;
            --sidebar-bg: #1f2937;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --border: #374151;
            --field-bg: #374151;
            --text-main: #f3f4f6;
            --text-dim: #9ca3af;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: var(--bg);
            color: var(--text-main);
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.2);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        .sidebar h2 {
            font-size: 16px;
            margin: 0;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
        }

        /* New Premium Controls Styling */
        .section-tab {
            font-size: 9px;
            color: var(--accent);
            font-weight: 800;
            text-transform: uppercase;
            margin: 25px 0 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-group {
            display: flex;
            background: #111827;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            flex: 1;
            padding: 6px;
            font-size: 10px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-weight: 700;
            transition: 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .shadow-subtle {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .shadow-deep {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .shadow-glow {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-footer {
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-top: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 24px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .control-label {
            display: block;
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .property-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .width-btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .width-btn {
            background: #111827;
            color: var(--text-dim);
            border: 1px solid var(--border);
            padding: 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .width-btn:hover {
            border-color: var(--accent);
            color: white;
        }

        .width-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn-back,
        .btn-save {
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            text-decoration: none;
        }

        .canvas {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preview-container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.01);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            min-height: 80vh;
        }

        .group-box {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            margin-bottom: 40px;
            padding: 30px 20px 20px;
            position: relative;
            background: rgba(255, 255, 255, 0.01);
            transition: border-color 0.3s;
        }

        .group-header {
            position: absolute;
            top: -14px;
            left: 20px;
            background: var(--accent);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fields-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
        }

        .field-card {
            background: #1f2937;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            cursor: move;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .field-card.selected {
            border: 2px solid var(--accent);
            background: #2d3748;
        }

        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }

        .field-type-badge {
            font-size: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            padding: 2px 6px;
            border-radius: 4px;
            width: fit-content;
            text-transform: uppercase;
        }

        .field-mock-input {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 5px;
        }

        .w-100 {
            grid-column: span 12;
        }

        .w-75 {
            grid-column: span 9;
        }

        .w-66 {
            grid-column: span 8;
        }

        .w-50 {
            grid-column: span 6;
        }

        .w-33 {
            grid-column: span 4;
        }

        .w-25 {
            grid-column: span 3;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent);
        }

        input[type="number"],
        select {
            background: #111827;
            border: 1px solid var(--border);
            color: white;
            padding: 6px;
            border-radius: 6px;
            font-size: 12px;
            width: 100%;
        }

        /* Light Theme Overrides */
        body.light-theme {
            --bg: #f3f4f6;
            --sidebar-bg: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-dim: #6b7280;
            --field-bg: #ffffff;
        }

        body.light-theme .canvas {
            background: #f3f4f6;
        }

        body.light-theme .preview-container {
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        body.light-theme .field-card {
            background: #f9fafb;
            border-color: #e5e7eb;
        }

        body.light-theme .field-label {
            color: #111827;
        }

        body.light-theme .sidebar {
            background: white;
            border-right: 1px solid #e5e7eb;
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: #9ca3af;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            margin-left: 5px;
            cursor: help;
        }

        .input-preview {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            color: #9ca3af;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header" style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">üé® Layout Designer</h2>
            <button class="toggle-btn" id="undoBtn" onclick="undo()" title="–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –Ω–∞–∑–∞–¥ (Ctrl+Z)"
                style="padding: 5px 10px; font-size: 11px; opacity: 0.3; pointer-events: none;">‚è™ –ù–∞–∑–∞–¥</button>
        </div>

        <div class="sidebar-content">
            <div id="globalSettings" style="margin-bottom: 25px;">
                <div class="section-tab">üåê –ì–ª–æ–±–∞–ª—å–Ω—ñ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
                <div class="control-group" style="padding-bottom:10px">
                    <span class="control-label">–¢–µ–º–∞ –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</span>
                    <div class="toggle-group">
                        <button class="toggle-btn" id="themeDark" onclick="setGlobalTheme('dark')">–¢–µ–º–Ω–∞</button>
                        <button class="toggle-btn" id="themeLight" onclick="setGlobalTheme('light')">–°–≤—ñ—Ç–ª–∞</button>
                    </div>
                </div>
                <div class="control-group">
                    <span class="control-label">–ù–∞–∑–≤–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞</span>
                    <input type="text" id="calcTitleInp" oninput="updateGlobal('title', this.value)"
                        style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; margin-bottom:10px;">
                    <span class="control-label">–í–µ—Ä—Å—ñ—è</span>
                    <input type="text" id="calcVersionInp" oninput="updateGlobal('version', this.value)"
                        style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; margin-bottom:15px;">

                    <button class="toggle-btn"
                        style="width:100%; border-color: #ef4444; color: #ef4444; margin-top:10px"
                        onclick="resetAllToDefault()">
                        üßπ –°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ —Å—Ç–∏–ª—ñ (Reset)
                    </button>
                </div>
            </div>

            <div id="selectionPanel" style="display: none;">
                <div id="fieldProperties">
                    <div class="section-tab">üìè –ú–∞–∫–µ—Ç —Ç–∞ –†–æ–∑–º—ñ—Ä–∏</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                        <div id="selectedFieldName"
                            style="font-weight: 800; color: #fff; font-size: 14px; letter-spacing: 0.5px;">-</div>
                        <button class="toggle-btn" style="padding:4px 8px; font-size:9px"
                            onclick="applySelectedStyleToAll()" title="–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ü–µ–π —Å—Ç–∏–ª—å –¥–æ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤">–ö–æ–ø—ñ—é–≤–∞—Ç–∏ –Ω–∞
                            –≤—Å—ñ</button>
                    </div>

                    <div class="control-group">
                        <span class="control-label">–®–∏—Ä–∏–Ω–∞ –±–ª–æ–∫—É</span>
                        <div class="width-btn-group">
                            <button class="width-btn" onclick="setFieldWidth('w-25')">1/4</button>
                            <button class="width-btn" onclick="setFieldWidth('w-33')">1/3</button>
                            <button class="width-btn" onclick="setFieldWidth('w-50')">1/2</button>
                            <button class="width-btn" onclick="setFieldWidth('w-66')">2/3</button>
                            <button class="width-btn" onclick="setFieldWidth('w-75')">3/4</button>
                            <button class="width-btn" onclick="setFieldWidth('w-100')">1/1</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <span class="control-label">–û—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è</span>
                        <div class="toggle-group">
                            <button class="toggle-btn" id="btnDirCol"
                                onclick="updateStyle('flexDirection', 'column')">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ</button>
                            <button class="toggle-btn" id="btnDirRow"
                                onclick="updateStyle('flexDirection', 'row')">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</button>
                        </div>
                        <div class="property-row">
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–í—ñ–¥—Å—Ç—É–ø (Gap)</span>
                                <input type="number" id="gapInp" oninput="updateStyle('gap', this.value)"
                                    style="width:80%">
                            </div>
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–í–Ω—É—Ç—Ä. Padding</span>
                                <input type="number" id="paddingInp" oninput="updateStyle('padding', this.value)"
                                    style="width:80%">
                            </div>
                        </div>
                        <div style="margin-top:10px">
                            <span class="control-label" style="font-size:8px">–í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –Ω–∞–∑–≤–∏</span>
                            <div class="toggle-group" style="display:grid; grid-template-columns:repeat(3, 1fr)">
                                <button class="toggle-btn" id="alignLeft"
                                    onclick="updateStyle('textAlign', 'left')">‚¨ÖÔ∏è</button>
                                <button class="toggle-btn" id="alignCenter"
                                    onclick="updateStyle('textAlign', 'center')">‚ÜîÔ∏è</button>
                                <button class="toggle-btn" id="alignRight"
                                    onclick="updateStyle('textAlign', 'right')">‚û°Ô∏è</button>
                            </div>
                        </div>

                        <div id="labelWidthControl" style="margin-top:15px; display:none;">
                            <span class="control-label" style="font-size:8px">–®–∏—Ä–∏–Ω–∞ –Ω–∞–∑–≤–∏ (px)</span>
                            <div class="property-row">
                                <input type="range" min="10" max="400" id="labelWidthRange"
                                    oninput="updateStyle('labelWidth', this.value)" style="flex:1">
                                <div id="labelWidthVal" style="font-size:10px; width:35px; font-weight:800">120</div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Typography Pro -->
                    <div class="section-tab">üî§ –¢–∏–ø–æ–≥—Ä–∞—Ñ—ñ–∫–∞ —Ç–∞ –¢–µ–∫—Å—Ç</div>
                    <div class="control-group">
                        <div class="property-row">
                            <input type="range" min="10" max="40" id="fontSizeRange"
                                oninput="updateStyle('fontSize', this.value)" style="flex: 2;">
                            <div id="fontSizeVal" style="font-size: 10px; width: 30px; font-weight:800">14</div>
                        </div>
                        <div class="property-row">
                            <select id="fontWeightSelect" onchange="updateStyle('fontWeight', this.value)"
                                style="flex:2; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; padding:5px; border-radius:5px;">
                                <option value="400">Regular</option>
                                <option value="600">SemiBold</option>
                                <option value="700">Bold</option>
                                <option value="800">Black</option>
                            </select>
                            <input type="color" id="labelColor" onchange="updateStyle('color', this.value)"
                                style="flex:1; height:32px; background:none; border:1px solid var(--border); padding:2px; border-radius:5px;">
                        </div>
                        <div style="margin-top:15px">
                            <span class="control-label" style="font-size:8px">–¢–µ–∫—Å—Ç-–ø—ñ–¥–∫–∞–∑–∫–∞ (Placeholder)</span>
                            <input type="text" id="placeholderInp" oninput="updateStyle('placeholder', this.value)"
                                placeholder="–í–≤–µ–¥—ñ—Ç—å..."
                                style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                        </div>
                        <div style="margin-top:10px">
                            <span class="control-label" style="font-size:8px">–û–ø–∏—Å / Help Text</span>
                            <input type="text" id="helpInp" oninput="updateStyle('help', this.value)"
                                placeholder="–ó'—è–≤–∏—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ..."
                                style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                        </div>
                        <div style="margin-top:10px">
                            <span class="control-label" style="font-size:8px">URL —Ñ–æ—Ç–æ —É –ø—ñ–¥–∫–∞–∑—Ü—ñ</span>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="helpImgInp" oninput="updateStyle('helpImg', this.value)"
                                    placeholder="images/photo.jpg"
                                    style="flex:1; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit; font-size:12px;">
                                <button onclick="document.getElementById('filePicker').click()"
                                    style="padding:0 12px; border-radius:6px; background:var(--accent); border:none; color:white; cursor:pointer;"
                                    title="–í–∏–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª">üìÇ</button>
                            </div>
                            <input type="file" id="filePicker" style="display:none" onchange="pickHelpImg(this)">
                        </div>
                        <div class="toggle-group" style="margin-top:10px">
                            <button class="toggle-btn" id="btnUpper"
                                onclick="toggleLayoutProp('uppercase')">–ê–ë–í</button>
                            <button class="toggle-btn" id="btnLetterSpacing" onclick="toggleLayoutProp('spaced')">A B
                                C</button>
                        </div>
                    </div>

                    <!-- Section 5: Input Aesthetics -->
                    <div class="section-tab">üñºÔ∏è –°—Ç–∏–ª—å –ü–æ–ª—è (Input)</div>
                    <div class="control-group">
                        <div style="margin-bottom:15px">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <span class="control-label" style="font-size:8px">–®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è (%)</span>
                                <button class="toggle-btn" style="padding:2px 5px; font-size:8px"
                                    onclick="updateStyle('inputWidth', 100)">100%</button>
                            </div>
                            <div class="property-row">
                                <input type="range" min="10" max="100" id="inputWidthRange"
                                    oninput="updateStyle('inputWidth', this.value)" style="flex:1">
                                <div id="inputWidthVal" style="font-size:10px; width:35px; font-weight:800">100%</div>
                            </div>
                        </div>
                        <div style="margin-bottom:15px" id="inputOffsetGroup">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <span class="control-label" style="font-size:8px">–ó—Å—É–≤ –≤–ø—Ä–∞–≤–æ (px)</span>
                                <button class="toggle-btn" style="padding:2px 5px; font-size:8px"
                                    onclick="updateStyle('inputOffset', 0)">Reset</button>
                            </div>
                            <div class="property-row">
                                <input type="range" min="0" max="400" id="inputOffsetRange"
                                    oninput="updateStyle('inputOffset', this.value)" style="flex:1">
                                <div id="inputOffsetVal" style="font-size:10px; width:35px; font-weight:800">0</div>
                            </div>
                        </div>
                        <div class="property-row">
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">–†–∞–º–∫–∞</span>
                                <input type="color" id="inpBorderColor" onchange="updateStyle('inpBorder', this.value)"
                                    style="width:100%">
                            </div>
                            <div style="flex:1">
                                <span class="control-label" style="font-size:8px">Background</span>
                                <input type="color" id="inpBgColor" onchange="updateStyle('inpBg', this.value)"
                                    style="width:100%">
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Effects -->
                    <div class="section-tab">‚ú® –ï—Ñ–µ–∫—Ç–∏ —Ç–∞ –î–µ–∫–æ—Ä</div>
                    <div class="control-group">
                        <span class="control-label">–ì–ª–∏–±–∏–Ω–∞ (–¢—ñ–Ω—å)</span>
                        <div class="toggle-group" style="display:grid; grid-template-columns:repeat(4, 1fr)">
                            <button class="toggle-btn" id="shNone" onclick="updateStyle('shadow', 'none')">Off</button>
                            <button class="toggle-btn" id="shSubtle"
                                onclick="updateStyle('shadow', 'subtle')">S</button>
                            <button class="toggle-btn" id="shDeep" onclick="updateStyle('shadow', 'deep')">D</button>
                            <button class="toggle-btn" id="shGlow" onclick="updateStyle('shadow', 'glow')">G</button>
                        </div>
                        <label
                            style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: var(--accent); cursor: pointer; margin-top:10px; font-weight:700;">
                            <input type="checkbox" id="glassToggle" onchange="updateStyle('glass', this.checked)">
                            Glassmorphism (Blur)
                        </label>
                    </div>

                    <!-- Section 4: Action Button -->
                    <div id="actionButtonProperties" style="display: none;">
                        <div class="section-tab">üîò –°—Ç–∏–ª—å –ö–Ω–æ–ø–∫–∏</div>
                        <div class="property-row">
                            <div style="flex:1"><span class="control-label" style="font-size:8px">–§–æ–Ω</span><input
                                    type="color" id="btnBgColor" onchange="updateStyle('btnBg', this.value)"
                                    style="width:100%"></div>
                            <div style="flex:1"><span class="control-label" style="font-size:8px">–¢–µ–∫—Å—Ç</span><input
                                    type="color" id="btnTextColor" onchange="updateStyle('btnColor', this.value)"
                                    style="width:100%"></div>
                        </div>
                        <div class="property-row" style="margin-top: 10px;">
                            <input type="number" id="btnFontSize" placeholder="–®—Ä–∏—Ñ—Ç"
                                oninput="updateStyle('btnFontSize', this.value)" style="width:45%">
                            <input type="number" id="btnRadius" placeholder="–†–∞–¥—ñ—É—Å"
                                oninput="updateStyle('btnRadius', this.value)" style="width:45%">
                        </div>
                    </div>

                    <div class="control-group" style="margin-top: 20px; border: none;">
                        <label
                            style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: #ef4444; cursor: pointer;">
                            <input type="checkbox" id="fieldHidden" onchange="toggleFieldHidden(this.checked)">
                            –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç
                        </label>
                    </div>
                </div>

                <!-- Group Properties -->
                <div id="groupProperties" style="display: none;">
                    <div class="section-tab">üìÇ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ì—Ä—É–ø–∏</div>
                    <div class="control-group">
                        <span class="control-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–∏</span>
                        <input type="text" id="groupTitleInp" oninput="updateGroupStyle('title', this.value)"
                            style="width:100%; padding:8px; border-radius:6px; background:rgba(0,0,0,0.1); border:1px solid var(--border); color:inherit;">
                    </div>
                    <div class="control-group">
                        <span class="control-label">–§–æ–Ω —Å–µ–∫—Ü—ñ—ó</span>
                        <input type="color" id="groupBgColor" onchange="updateGroupStyle('background', this.value)">
                    </div>
                    <div class="control-group">
                        <label
                            style="font-size: 11px; display: flex; align-items: center; gap: 8px; color: var(--accent); cursor: pointer; font-weight:700;">
                            <input type="checkbox" id="groupNumbering"
                                onchange="updateGroupStyle('showNumbering', this.checked)"> –ù—É–º–µ—Ä—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É
                        </label>
                    </div>
                </div>
            </div>

            <div id="noSelection"
                style="color: var(--text-dim); font-size: 11px; text-align: center; margin-top: 40px; border: 1px dashed var(--border); padding: 15px; border-radius: 10px;">
                –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –ø–æ–ª–µ –∞–±–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥—Ä—É–ø–∏ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="admin.html" class="nav-btn-back"
                style="background: rgba(255,255,255,0.05); color: var(--text-dim); border: 1px solid var(--border);">–ú–∞—Ç—Ä–∏—Ü—è</a>
            <button class="btn-save" onclick="saveLayout()" style="background: #10b981; color: white;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
    </div>

    <div class="canvas">
        <div class="preview-container" id="designerCanvas"></div>
    </div>

    <script>
        let selectedIds = []; // Array of selected field IDs
        let selectedGroupId = null;
        let selectedCatId = null; // Currently editing a category?

        let historyStack = [];
        const MAX_HISTORY = 50;

        function saveHistory() {
            historyStack.push(JSON.stringify(Schema));
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            const btn = document.getElementById('undoBtn');
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
        }

        function undo() {
            if (historyStack.length === 0) return;
            const previous = historyStack.pop();
            const currentSchema = JSON.parse(previous);

            // Restore Schame
            Object.keys(currentSchema).forEach(key => {
                Schema[key] = currentSchema[key];
            });

            if (historyStack.length === 0) {
                const btn = document.getElementById('undoBtn');
                btn.style.opacity = '0.3';
                btn.style.pointerEvents = 'none';
            }
            renderDesigner();
            // Deselect to avoid stale references if IDs changed (though they shouldn't)
            selectedIds = [];
            selectedGroupId = null;
            document.getElementById('noSelection').style.display = 'block';
            document.getElementById('selectionPanel').style.display = 'none';
        }

        // Add Ctrl+Z listener
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        document.addEventListener('DOMContentLoaded', renderDesigner);

        function renderDesigner() {
            const container = document.getElementById('designerCanvas');
            container.innerHTML = '';

            // Sync Global Inputs
            document.getElementById('calcTitleInp').value = (Schema.layout && Schema.layout.title) || '';
            document.getElementById('calcVersionInp').value = (Schema.layout && Schema.layout.version) || '';

            // Render Header Preview
            const headerPreview = document.createElement('div');
            headerPreview.style.padding = '0 10px 20px 10px';
            headerPreview.style.borderBottom = '1px solid var(--border)';
            headerPreview.style.marginBottom = '30px';
            headerPreview.style.display = 'flex';
            headerPreview.style.justifyContent = 'space-between';
            headerPreview.style.alignItems = 'baseline';
            headerPreview.innerHTML = `
                <div style="font-size: 18px; font-weight: 800; color:var(--accent)">${Schema.layout?.title || '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä'}</div>
                <div style="font-size: 10px; opacity:0.5; text-align: right;">
                    ${Schema.layout?.version || 'v1.0'}<br>
                    <span style="color:var(--accent); font-weight:bold;">Ctrl + Click –¥–ª—è –≤–∏–±–æ—Ä—É –¥–µ–∫—ñ–ª—å–∫–æ—Ö</span>
                </div>
            `;
            container.appendChild(headerPreview);

            // New: Category Toggles Preview
            const catSelection = document.createElement('div');
            catSelection.style.marginBottom = '25px';
            catSelection.className = 'categories-preview-container';
            catSelection.innerHTML = `
                <div style="font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span style="background: var(--accent); width: 4px; height: 12px; border-radius: 2px;"></span>
                    –ü—Ä–æ—Ü–µ—Å–∏ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É (–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è)
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;" id="catTogglesGrid"></div>
            `;
            container.appendChild(catSelection);

            const catGrid = catSelection.querySelector('#catTogglesGrid');
            Object.keys(Schema.categories || {}).forEach(cid => {
                const cat = Schema.categories[cid];
                const btn = document.createElement('div');
                btn.className = 'cat-preview-toggle';
                btn.draggable = true;
                btn.dataset.cid = cid;
                btn.style.cssText = `
                    padding: 6px 14px; border-radius: 999px; font-size: 11px; font-weight: 600; 
                    border: 2px solid var(--accent); background: var(--accent); color: white; 
                    display: flex; align-items: center; gap: 6px; cursor: move; transition: 0.2s;
                `;
                btn.innerHTML = `<span style="font-size: 8px;">‚úì</span> ${cat.name}`;
                catGrid.appendChild(btn);
            });
            setupDragEvents(catGrid, '.cat-preview-toggle', updateCategoriesOrder);

            // Create Main Layout (Form + Results)
            const mainLayout = document.createElement('div');
            mainLayout.style.display = 'flex';
            mainLayout.style.gap = '30px';
            mainLayout.style.width = '100%';

            const formPanel = document.createElement('div');
            formPanel.style.flex = '2';
            formPanel.id = 'formPanelPreview';

            const resultsPanel = document.createElement('div');
            resultsPanel.style.flex = '1';
            resultsPanel.style.minWidth = '250px';
            resultsPanel.style.background = 'rgba(255,255,255,0.03)';
            resultsPanel.style.borderRadius = '16px';
            resultsPanel.style.padding = '20px';
            resultsPanel.style.border = '1px solid var(--border)';
            resultsPanel.innerHTML = `
                <h3 style="margin-top:0; font-size: 14px; text-transform:uppercase; color:var(--text-dim)">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h3>
                <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px">
                    ${Object.keys(Schema.categories || {}).map(cid => `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:var(--text-main)">
                            <span>${Schema.categories[cid].name}</span>
                            <span style="font-weight:600; color:var(--accent)">0 –≥—Ä–Ω</span>
                        </div>
                    `).join('')}
                </div>
                <div style="display:flex; flex-direction:column; align-items:center">
                    <div style="font-size: 10px; color: var(--text-dim); font-weight:700; margin-bottom: 5px; text-transform:uppercase">–í–°–¨–û–ì–û</div>
                    <div style="font-size: 24px; font-weight: 800; color: white;">0 –≥—Ä–Ω</div>
                </div>
            `;

            mainLayout.appendChild(formPanel);
            mainLayout.appendChild(resultsPanel);
            container.appendChild(mainLayout);

            Schema.groups.forEach((group, idx) => {
                const gl = group.layout || {};
                const groupEl = document.createElement('div');
                groupEl.className = 'group-box';
                groupEl.dataset.groupId = group.id;
                groupEl.draggable = true;
                if (gl.borderWidth) {
                    groupEl.style.border = `${gl.borderWidth}px solid ${gl.borderColor || 'rgba(255,255,255,0.1)'}`;
                }

                const groupCont = document.createElement('div');
                groupCont.className = 'group-content';
                groupEl.appendChild(groupCont);

                const header = document.createElement('div');
                header.className = 'group-header';
                const gLayout = group.layout || {};
                const showNumbers = gLayout.showNumbering;

                header.textContent = (showNumbers ? `${idx + 1}. ` : '') + (group.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏');
                header.onclick = (e) => { e.stopPropagation(); selectGroup(group.id); };
                if (selectedGroupId === group.id) header.classList.add('selected');
                groupCont.appendChild(header);

                groupCont.style.background = gLayout.background || (document.body.classList.contains('light-theme') ? '#fff' : '#111827');
                groupCont.style.padding = '20px';
                groupCont.style.borderRadius = '12px';
                groupCont.style.border = '1px solid var(--border)';

                const grid = document.createElement('div');
                grid.className = 'fields-grid';
                Schema.fields.filter(f => f.groupId === group.id).forEach(field => {
                    grid.appendChild(createFieldCard(field));
                });

                groupCont.appendChild(grid);
                formPanel.appendChild(groupEl);
                setupDragEvents(grid, '.field-card', updateFieldsOrder);
            });
            setupDragEvents(formPanel, '.group-box', updateGroupsOrder);
        }

        function pickHelpImg(input) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                updateStyle('helpImg', 'images/' + fileName);
                document.getElementById('helpImgInp').value = 'images/' + fileName;
            }
        }

        function createFieldCard(field) {
            const l = field.layout || {};
            const widthClass = l.width || 'w-100';
            const card = document.createElement('div');
            card.className = `field-card ${widthClass}${field.hidden ? ' hidden-card' : ''}`;
            if (selectedIds.includes(field.id)) card.classList.add('selected');
            card.dataset.id = field.id;
            card.draggable = true;

            const isRow = l.flexDirection === 'row';
            card.style.flexDirection = l.flexDirection || 'column';
            card.style.gap = (l.gap || 8) + 'px';
            if (isRow) card.style.alignItems = 'center';

            const isLight = document.body.classList.contains('light-theme');
            const defaultColor = isLight ? '#374151' : 'white';

            const labelStyle = `
                display: flex;
                align-items: center;
                gap: 5px;
                font-size:${l.fontSize || 13}px;
                ${isRow ? `flex: 0 0 ${l.labelWidth || 120}px;` : 'none'};
                justify-content: ${l.textAlign === 'center' ? 'center' : (l.textAlign === 'right' ? 'flex-end' : 'flex-start')};
                color:${l.color || defaultColor};
                font-weight:${l.fontWeight || 600};
                ${l.uppercase ? 'text-transform:uppercase;' : ''}
                ${l.spaced ? 'letter-spacing:0.05em;' : ''}
            `;

            card.innerHTML = `
                <div class="field-label" style="${labelStyle}">
                    ${field.label || field.default || '–ü–æ–ª–µ'}
                    ${l.help ? '<span class="help-icon">?</span>' : ''}
                </div>
                <div style="flex:${isRow ? 1 : 'none'}; width: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <div style="width:${l.inputWidth || 100}%; margin-left:${l.inputOffset || 0}px;">
                        <div class="field-type-badge">${field.type}</div>
                        ${field.type === 'action_button' ?
                    `<div class="btn-preview" style="background:${l.btnBg || '#2563eb'}; color:${l.btnColor || '#fff'}; font-size:${l.btnFontSize || 10}px; border-radius:${l.btnRadius || 8}px; padding:${(l.btnPadding || 12) / 2}px; text-align:center; font-weight:700; margin-top:5px;">${field.default || 'BUTTON'}</div>` :
                    field.type === 'select_modal' ?
                        `<div class="input-preview" style="border-color:${l.inpBorder || '#d1d5db'}; background:${l.inpBg || '#fff'}; display: flex; justify-content: space-between; align-items: center; padding: 6px 10px;"><span>${field.placeholderText || field.label || '–í–∏–±–µ—Ä—ñ—Ç—å...'}</span><span style="font-size: 8px;">‚ñº</span></div>` :
                        field.type === 'select' ?
                            `<div class="input-preview" style="border-color:${l.inpBorder || '#d1d5db'}; background:${l.inpBg || '#fff'}; display: flex; justify-content: space-between; align-items: center; padding: 6px 10px;"><span>${field.placeholderText || field.label || '–í–∏–±–µ—Ä—ñ—Ç—å...'}</span><span style="font-size: 8px;">‚ñº</span></div>` :
                            `<div class="input-preview" style="border-color:${l.inpBorder || '#d1d5db'}; background:${l.inpBg || '#fff'}; color:${l.inpBg ? (parseInt(l.inpBg.replace('#', ''), 16) > 0xffffff / 2 ? '#000' : '#fff') : '#9ca3af'}">${field.placeholderText || l.placeholder || 'Placeholder...'}</div>`
                }
                    </div>
                </div>
            `;
            card.onclick = (e) => {
                e.stopPropagation();
                const isMulti = e.ctrlKey || e.metaKey || e.shiftKey;
                selectField(field.id, isMulti);
            };
            return card;
        }

        function updateGlobal(prop, val) {
            saveHistory();
            Schema.layout = Schema.layout || {};
            Schema.layout[prop] = val;
            renderDesigner();
        }

        function setGlobalTheme(theme) {
            saveHistory();
            Schema.layout = Schema.layout || {};
            Schema.layout.theme = theme;
            document.body.classList.toggle('light-theme', theme === 'light');
            document.getElementById('themeDark').classList.toggle('active', theme === 'dark' || !theme);
            document.getElementById('themeLight').classList.toggle('active', theme === 'light');
            renderDesigner();
        }

        function resetAllToDefault() {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤?')) return;
            saveHistory();
            Schema.fields.forEach(f => {
                f.layout = {};
            });
            renderDesigner();
            alert('–°—Ç–∏–ª—ñ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤ –±—É–ª–æ —Å–∫–∏–Ω—É—Ç–æ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö.');
        }

        function applySelectedStyleToAll() {
            if (selectedIds.length === 0) return;
            if (!confirm('–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Å—Ç–∏–ª—å –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø–æ–ª—è –¥–æ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –ø–æ–ª—ñ–≤?')) return;
            saveHistory();
            const sourceField = Schema.fields.find(f => f.id === selectedIds[0]);
            const styleToCopy = JSON.parse(JSON.stringify(sourceField.layout || {}));

            Schema.fields.forEach(f => {
                f.layout = JSON.parse(JSON.stringify(styleToCopy));
            });
            renderDesigner();
            alert('–°—Ç–∏–ª—å —É—Å–ø—ñ—à–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –¥–æ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤.');
        }

        function selectField(id, multi = false) {
            if (multi) {
                const idx = selectedIds.indexOf(id);
                if (idx > -1) selectedIds.splice(idx, 1);
                else selectedIds.push(id);
            } else {
                selectedIds = [id];
            }
            selectedGroupId = null;

            if (selectedIds.length === 0) {
                document.getElementById('noSelection').style.display = 'block';
                document.getElementById('selectionPanel').style.display = 'none';
                renderDesigner();
                return;
            }

            const field = Schema.fields.find(f => f.id === selectedIds[0]);
            const l = field.layout || {};

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('selectionPanel').style.display = 'block';
            document.getElementById('fieldProperties').style.display = 'block';
            document.getElementById('groupProperties').style.display = 'none';

            // Sync UI for the first/main selected field
            document.getElementById('selectedFieldName').textContent = selectedIds.length > 1 ? `üì¶ –û–±—Ä–∞–Ω–æ –æ–±'—î–∫—Ç—ñ–≤: ${selectedIds.length}` : (field.label || field.default);
            document.getElementById('fontSizeRange').value = l.fontSize || 13;
            document.getElementById('fontSizeVal').textContent = l.fontSize || 13;
            // ... (sync other inputs as usual, they will show first item state)
            document.getElementById('fontWeightSelect').value = l.fontWeight || 400;
            document.getElementById('labelColor').value = l.color || (document.body.classList.contains('light-theme') ? '#111827' : '#ffffff');
            document.getElementById('placeholderInp').value = l.placeholder || '';
            document.getElementById('helpInp').value = l.help || '';
            document.getElementById('helpImgInp').value = l.helpImg || '';
            document.getElementById('inputWidthRange').value = l.inputWidth || 100;
            document.getElementById('inputWidthVal').textContent = (l.inputWidth || 100) + '%';
            document.getElementById('inputOffsetRange').value = l.inputOffset || 0;
            document.getElementById('inputOffsetVal').textContent = l.inputOffset || 0;
            document.getElementById('inpBorderColor').value = l.inpBorder || '#d1d5db';
            document.getElementById('inpBgColor').value = l.inpBg || '#ffffff';
            document.getElementById('gapInp').value = l.gap || 8;
            document.getElementById('paddingInp').value = l.padding || 15;
            document.getElementById('glassToggle').checked = !!l.glass;
            document.getElementById('fieldHidden').checked = !!field.hidden;

            const lwCtrl = document.getElementById('labelWidthControl');
            if (l.flexDirection === 'row') {
                lwCtrl.style.display = 'block';
                document.getElementById('labelWidthRange').value = l.labelWidth || 120;
                document.getElementById('labelWidthVal').textContent = (l.labelWidth || 120) + 'px';
            } else {
                lwCtrl.style.display = 'none';
            }

            document.getElementById('btnUpper').classList.toggle('active', !!l.uppercase);
            document.getElementById('btnLetterSpacing').classList.toggle('active', !!l.spaced);
            document.getElementById('btnDirCol').classList.toggle('active', (l.flexDirection || 'column') === 'column');
            document.getElementById('btnDirRow').classList.toggle('active', l.flexDirection === 'row');

            document.getElementById('alignLeft').classList.toggle('active', (l.textAlign || 'left') === 'left');
            document.getElementById('alignCenter').classList.toggle('active', l.textAlign === 'center');
            document.getElementById('alignRight').classList.toggle('active', l.textAlign === 'right');

            ['none', 'subtle', 'deep', 'glow'].forEach(s => {
                const btn = document.getElementById('sh' + s.charAt(0).toUpperCase() + s.slice(1));
                if (btn) btn.classList.toggle('active', (l.shadow || 'none') === s);
            });

            const btnProps = document.getElementById('actionButtonProperties');
            if (field.type === 'action_button') {
                btnProps.style.display = 'block';
                document.getElementById('btnBgColor').value = l.btnBg || '#2563eb';
                document.getElementById('btnTextColor').value = l.btnColor || '#ffffff';
                document.getElementById('btnFontSize').value = l.btnFontSize || 14;
                document.getElementById('btnRadius').value = l.btnRadius || 8;
            } else {
                btnProps.style.display = 'none';
            }

            renderDesigner();
        }

        function selectGroup(id) {
            selectedGroupId = id; selectedIds = [];
            const group = Schema.groups.find(g => g.id === id);
            const gl = group.layout || {};

            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('selectionPanel').style.display = 'block';
            document.getElementById('fieldProperties').style.display = 'none';
            document.getElementById('groupProperties').style.display = 'block';

            document.getElementById('groupTitleInp').value = group.title || '';
            document.getElementById('groupBgColor').value = gl.background || (document.body.classList.contains('light-theme') ? '#ffffff' : '#111827');
            document.getElementById('groupNumbering').checked = !!gl.showNumbering;

            renderDesigner();
        }

        function updateGroupStyle(prop, val) {
            const group = Schema.groups.find(g => g.id === selectedGroupId);
            saveHistory();
            if (prop === 'title') {
                group.title = val;
            } else {
                if (!group.layout) group.layout = {};
                group.layout[prop] = val;
            }
            renderDesigner();
        }
        function toggleLayoutProp(prop) {
            saveHistory();
            selectedIds.forEach(id => {
                const field = Schema.fields.find(f => f.id === id);
                if (!field.layout) field.layout = {};
                field.layout[prop] = !field.layout[prop];
            });
            renderDesigner();
            selectField(selectedIds[0], true); // Refresh UI state based on first item
            // Note: multi selection refresh logic might needs refinement for toggle buttons
        }

        function updateStyle(prop, val) {
            if (selectedIds.length === 0) return;
            saveHistory();
            selectedIds.forEach(id => {
                const field = Schema.fields.find(f => f.id === id);
                if (!field.layout) field.layout = {};

                const intProps = ['fontSize', 'inputWidth', 'btnFontSize', 'btnRadius', 'gap', 'padding', 'labelWidth', 'inputOffset'];
                field.layout[prop] = intProps.includes(prop) ? parseInt(val) : val;
            });

            // Immediate UI update for sliders (based on value passed)
            if (prop === 'inputWidth') document.getElementById('inputWidthVal').textContent = val + '%';
            if (prop === 'inputOffset') document.getElementById('inputOffsetVal').textContent = val;
            if (prop === 'labelWidth') document.getElementById('labelWidthVal').textContent = val + 'px';

            renderDesigner();
            if (prop === 'shadow' || prop === 'flexDirection') selectField(selectedIds[0], true);
        }

        function setFieldWidth(w) { updateStyle('width', w); }
        function toggleFieldHidden(v) {
            selectedIds.forEach(id => {
                Schema.fields.find(f => f.id === id).hidden = v;
            });
            renderDesigner();
        }

        function updateCategoriesOrder() {
            saveHistory();
            const newOrder = {};
            [...document.querySelectorAll('.cat-preview-toggle')].forEach(el => {
                const cid = el.dataset.cid;
                newOrder[cid] = Schema.categories[cid];
            });
            Schema.categories = newOrder;
            renderDesigner(); // Re-render to show updated results order
        }

        function updateGroupStyle(prop, val) {
            const group = Schema.groups.find(g => g.id === selectedGroupId);
            if (!group.layout) group.layout = {};
            group.layout[prop] = prop === 'borderWidth' ? parseInt(val) : val;
            renderDesigner();
        }

        function setupDragEvents(cont, sel, onDrop) {
            cont.onsubmit = e => e.preventDefault();
            cont.addEventListener('dragstart', e => { if (e.target.matches(sel)) e.target.classList.add('dragging'); });
            cont.addEventListener('dragend', e => { if (e.target.matches(sel)) e.target.classList.remove('dragging'); });
            cont.addEventListener('dragover', e => {
                e.preventDefault();
                const drag = document.querySelector('.dragging');
                if (!drag || !drag.matches(sel)) return;

                // Improved 2D proximity sorting
                const others = [...cont.querySelectorAll(`${sel}:not(.dragging)`)];
                const after = others.reduce((clos, child) => {
                    const box = child.getBoundingClientRect();
                    const centerX = box.left + box.width / 2;
                    const centerY = box.top + box.height / 2;

                    // Simple logic: if mouse is before the center of the element, place before it
                    const isBefore = e.clientX < centerX && e.clientY < (box.top + box.height + 10);
                    const isTrulyBefore = e.clientY < box.top || (e.clientY < (box.top + box.height) && e.clientX < centerX);

                    const off = isTrulyBefore ? -1 : 1;
                    // This is still a bit simple, but better than vertical-only
                    // Let's use distance to box center to find the insertion point
                    const dist = Math.sqrt(Math.pow(e.clientX - centerX, 2) + Math.pow(e.clientY - centerY, 2));

                    if (e.clientX < centerX || e.clientY < box.top) {
                        if (dist < clos.dist) return { dist, el: child };
                    }
                    return clos;
                }, { dist: Infinity }).el;

                if (after) cont.insertBefore(drag, after);
                else cont.appendChild(drag);
            });
            cont.addEventListener('drop', (e) => {
                saveHistory();
                setTimeout(onDrop, 10);
            });
        }

        function updateFieldsOrder() {
            const sorted = [];
            document.querySelectorAll('.group-box').forEach(gb => {
                const gid = gb.dataset.groupId;
                gb.querySelectorAll('.field-card').forEach(fc => {
                    const f = Schema.fields.find(x => x.id === fc.dataset.id);
                    f.groupId = gid; sorted.push(f);
                });
            });
            Schema.fields = [...sorted, ...Schema.fields.filter(f => !sorted.includes(f))];
        }

        function updateGroupsOrder() {
            Schema.groups = [...document.querySelectorAll('.group-box')].map(gb => Schema.groups.find(g => g.id === gb.dataset.groupId));
        }

        async function saveLayout() {
            try {
                const handle = await window.showSaveFilePicker({ suggestedName: 'schema.js', types: [{ accept: { 'text/javascript': ['.js'] } }] });
                const writ = await handle.createWritable();
                await writ.write(`const Schema = ${JSON.stringify(Schema, null, 4)};\nwindow.Schema = Schema;`);
                await writ.close(); alert('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
            } catch (e) { if (e.name !== 'AbortError') console.error(e); }
        }
    </script>
</body>

</html>